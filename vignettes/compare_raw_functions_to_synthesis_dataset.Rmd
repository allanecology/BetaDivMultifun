---
title: "compare to synthesis dataset"
author: "noelle"
date: "December 5, 2018"
output: html_document
---
# Comparison of raw functions dataset to synthesis dataset


sample dataset (from Eric, some Columns will be included), [synthesis dataset](https://www.bexis.uni-jena.de/Data/ShowXml.aspx?DatasetId=21688) (note: access only with access to BExIS)
TODO : is it really the same? or is it the "internal synthesis dataset"?

synthesis data can only be loaded with help of the file `nonpublic.R`
```{r}
synthesis <- data.table::fread(paste(pathtodata, "../assembled_data/EP grass functions & services.txt", sep=""), header=T)
data.table::setnames(synthesis, old="Plot", "Plotn")
synthesis <- merge(raw_functions[,c("Plot", "Plotn")], synthesis, by="Plotn")
```


```{r}
CompareToReferenceDataset(raw_functions, synthesis, name="Biomass2011", sortcol="Plot")
CompareToReferenceDataset(raw_functions, synthesis, name="Biomass2014")
CompareToReferenceDataset(raw_functions, synthesis, name="SoilOrganicC")
CompareToReferenceDataset(raw_functions, synthesis, name="Pmic.2011")
CompareToReferenceDataset(raw_functions, synthesis, name="Pmic.2014")
CompareToReferenceDataset(raw_functions, synthesis, name="Root.decomposition")
CompareToReferenceDataset(raw_functions, synthesis, name="Soil.C.stock")
CompareToReferenceDataset(raw_functions, synthesis, name="P_loss2011")
CompareToReferenceDataset(raw_functions, synthesis, name="P_loss2015")
CompareToReferenceDataset(raw_functions, synthesis, name="OlsenPi2014")
CompareToReferenceDataset(raw_functions, synthesis, name="Urease", sortcol = "Plot")
CompareToReferenceDataset(raw_functions, synthesis, name="beta_Glucosidase", sortcol = "Plot")
CompareToReferenceDataset(raw_functions, synthesis, name="Xylosidase", sortcol = "Plot")
CompareToReferenceDataset(raw_functions, synthesis, name="N_Acetyl_beta_Glucosaminidase", sortcol = "Plot")
CompareToReferenceDataset(raw_functions, synthesis, name="DEA", sortcol = "Plot")
CompareToReferenceDataset(raw_functions, synthesis, name ="Potential.nitrification", sortcol = "Plot")
CompareToReferenceDataset(raw_functions, synthesis, name ="Nmic.2011", sortcol = "Plot")
CompareToReferenceDataset(raw_functions, synthesis, name ="NH4.2014", sortcol = "Plot")
CompareToReferenceDataset(raw_functions, synthesis, name ="mAMFhyphae", sortcol = "Plot")
CompareToReferenceDataset(raw_functions, synthesis, name="Parasitoid.traps")
CompareToReferenceDataset(raw_functions, synthesis, name="Groundwater.recharge")
CompareToReferenceDataset(raw_functions, synthesis, name="Phosphatase")
CompareToReferenceDataset(raw_functions, synthesis, name="NO3.2014")
CompareToReferenceDataset(raw_functions, synthesis, name="Root.biomass")
CompareToReferenceDataset(raw_functions, synthesis, name="Litter.decomposition")
CompareToReferenceDataset(raw_functions, synthesis, name="Nshoot.2011")
CompareToReferenceDataset(raw_functions, synthesis, name="Pshoot.2011")
CompareToReferenceDataset(raw_functions, synthesis, name="NH4.2014")
CompareToReferenceDataset(raw_functions, synthesis, name="NO3.2014")


# change the naming
raw_functions[,"herbivory" := herbivory.2013]
CompareToReferenceDataset(raw_functions, synthesis, name="herbivory")
raw_functions[, "herbivory" := NULL]

data.table::setnames(synthesis, old="Bulk.density2014", new="Bulk.density2011")
CompareToReferenceDataset(raw_functions, synthesis, name="Bulk.density2011")
```
Run after running `2calc_raw_dataset.R` and `1read_raw_datasets.Rmd`.

## Erroneous entry in Synthesis
```{r}
CompareToReferenceDataset(raw_functions, synthesis, name ="Total.pollinators", sortcol = "Plot")
```

1 Value (AEG24) is 939 in synthesis and 339 in raw_functions. Was changed in synthesis (out of range).
```{r}
synthesis[Plot == "AEG24", ]$Total.pollinators <- 339
CompareToReferenceDataset(raw_functions, synthesis, name ="Total.pollinators", sortcol = "Plot")
```



## problematic

### pathogen.infection
not even correlated.
```{r, eval=F}
# comparison to synthesis
d <- merge(raw_functions[, c("Plot", "pathogen.infection")], synthesis[, c("Plot", "pathogen.infection")], by="Plot")
plot(d$pathogen.infection.x, d$pathogen.infection.y, ylim=c(0,0.1))
mod <- lm(pathogen.infection.x~pathogen.infection.y, data=d)
hist(d$pathogen.infection.y)
CompareToReferenceDataset(raw_functions, synthesis, name ="pathogen.infection", sortcol = "Plot")

rm(d); rm(mod)
```


### Biomass 2009
Not the same values as in synthesis, but they are correlated.
two treatments, neither was used in synthesis for Biomass2009
```{r, eval=F}
CompareToReferenceDataset(raw_functions, synthesis, name="Biomass2009")
deleteme <- merge(raw_functions[, c("Plot", "Biomass2009")], synthesis[,c("Plot", "Biomass2009")], by="Plot", all=T)
plot(deleteme$Biomass2009.x, deleteme$Biomass2009.y)
rm(deleteme)
```





### forage quality
Note : **multiply with biomass from the given year!** - doesn't make sense - this would completely change the range!
ohne biomasse - es geht um qualitÃ¤t, oder? "normalisation" der Jahre mit
biomasse macht keinen sinn, da wir sowieso mit konzentrationen arbeiten...
oder?
```{r}
# fs <- synthesis[,c("Plot", "forage.quality")]
# include <- c("Plot", colnames(raw_functions)[grep("forage", colnames(raw_functions))])
# fr <- raw_functions[, include, with=F]
# fr[,"means"] <- apply(fr[,-1], 1, mean, na.rm=T)
# test <- merge(fs, fr, by="Plot", all = T)
# 
# # same range of all values!
# plot(test$forage.quality, ylim=c(3,-3)) ; points(test$forage.quality2009, col="pink"); points(test$forage.quality2010, col="green");
# points(test$forage.quality2011, col="orange"); points(test$forage.quality2012, col="violet"); points(test$forage.quality2013, col="yellow")
# points(test$means, col="red")
CompareToReferenceDataset(raw_functions, synthesis, name="forage.quality")

d <- merge(forage.quality, synthesis[, c("Plot", "forage.quality")], by="Plot", all=T)
plot(d$forage.quality.x, d$forage.quality.y)
```

```{r}
# forage.quality.test <- merge(forage.quality[, c("Plot", "forage.quality")], synthesis[, c("Plot", "forage.quality")], by="Plot")
# max(forage.quality.test$forage.quality.x - forage.quality.test$forage.quality.y)
# min(forage.quality.test$forage.quality.x - forage.quality.test$forage.quality.y)
# # too much deviation ! 
# 
# 
# 
# # calculating the columns needed for forage quality calc
# # 2009
# forage.quality.2009[, Crude.protein.2009 := 6.25*N.2009]
# forage.quality.2009[, DDM.2009 := 88.9-(0.779* ADF.2009)]
# forage.quality.2009[, DMI.2009 := 120/NDF.2009]
# forage.quality.2009[, RFV.2009 := (DDM.2009*DMI.2009)/1.29]
# forage.quality.2009[, forage.quality.2009 := apply(scale(forage.quality.2009[,c("RFV.2009", "Crude.protein.2009")]), 1, mean)]
# forage.quality.2009 <- merge(PlotExplo, forage.quality.2009, by="Plot")
# # 2010
# forage.quality.2010[, Crude.protein.2010 := 6.25*N.2010]
# forage.quality.2010[, DDM.2010 := 88.9-(0.779* ADF.2010)]
# forage.quality.2010[, DMI.2010 := 120/NDF.2010]
# forage.quality.2010[, RFV.2010 := (DDM.2010*DMI.2010)/1.29]
# forage.quality.2010[, forage.quality.2010 := apply(scale(forage.quality.2010[,c("RFV.2010", "Crude.protein.2010")]), 1, mean)]
# forage.quality.2010 <- merge(PlotExplo, forage.quality.2010, by="Plot")
# # 2011
# forage.quality.2011[, Crude.protein.2011 := 6.25*N.2011]
# forage.quality.2011[, DDM.2011 := 88.9-(0.779* ADF.2011)]
# forage.quality.2011[, DMI.2011 := 120/NDF.2011]
# forage.quality.2011[, RFV.2011 := (DDM.2011*DMI.2011)/1.29]
# forage.quality.2011[, forage.quality.2011 := apply(scale(forage.quality.2011[,c("RFV.2011", "Crude.protein.2011")]), 1, mean)]
# forage.quality.2011 <- merge(PlotExplo, forage.quality.2011, by="Plot")
# # 2012
# forage.quality.2012[, Crude.protein.2012 := 6.25*N.2012]
# forage.quality.2012[, DDM.2012 := 88.9-(0.779* ADF.2012)]
# forage.quality.2012[, DMI.2012 := 120/NDF.2012]
# forage.quality.2012[, RFV.2012 := (DDM.2012*DMI.2012)/1.29]
# forage.quality.2012[, forage.quality.2012 := apply(scale(forage.quality.2012[,c("RFV.2012", "Crude.protein.2012")]), 1, mean)]
# forage.quality.2012 <- merge(PlotExplo, forage.quality.2012, by="Plot")
# # 2013
# forage.quality.2013[, Crude.protein.2013 := 6.25*N.2013]
# forage.quality.2013[, DDM.2013 := 88.9-(0.779* ADF.2013)]
# forage.quality.2013[, DMI.2013 := 120/NDF.2013]
# forage.quality.2013[, RFV.2013 := (DDM.2013*DMI.2013)/1.29]
# forage.quality.2013[, forage.quality.2013 := apply(scale(forage.quality.2013[,c("RFV.2013", "Crude.protein.2013")]), 1, mean)]
# forage.quality.2013 <- merge(PlotExplo, forage.quality.2013, by="Plot")
# 
# # tested for each year if equal to forage.quality in synthesis
# # data.table::setnames(forage.quality.2010, old="forage.quality.2010", new="forage.quality")
# # CompareToReferenceDataset(forage.quality.2010, synthesis, name="forage.quality")
# 
# # test if mean of all years is given in synthesis
# forage.quality <- merge(forage.quality.2009[,c("Plot", "Plotn", "forage.quality")], forage.quality.2010[,c("Plot", "forage.quality")], by="Plot")
# forage.quality <- merge(forage.quality, forage.quality.2011[,c("Plot", "forage.quality")], by="Plot", suffixes=c(".2011", ".a"))
# forage.quality <- merge(forage.quality, forage.quality.2012[,c("Plot", "forage.quality")], by="Plot", suffixes=c(".2012", ".a"))
# forage.quality <- merge(forage.quality, forage.quality.2013[,c("Plot", "forage.quality")], by="Plot", suffixes = c(".2013", ".a"))
# 
# newcol <- rowMeans(forage.quality[, colnames(forage.quality)[grep("forage", colnames(forage.quality))], with=F], na.rm = T)
# fq <- cbind(forage.quality[, c("Plot", "Plotn")], "forage.quality" = newcol)
# CompareToReferenceDataset(fq, synthesis, name="forage.quality")
# 
# test <- merge(fq[, c("Plot", "forage.quality")], synthesis[, c("Plot", "forage.quality")], by="Plot")
# max(test$forage.quality.x - test$forage.quality.y)
# min(test$forage.quality.x - test$forage.quality.y)
# 
# # TODO is not the same!
```

TODO : **different values than in synthesis!!** Really calculated with 2009? Or is it the mean among all years (2009 - 2013). If yes - take mean among years AFTER forage.quality calculation?! Note : the column names given in assembled dataset do not correspond to columns in "my" dataset - e.g. ShootN.conc in Erics dataset is "N" in mine.


# Nshoot and Pshoot 2009
same problem as with forage quality : not the same numbers as in synthesis! Due to Biomass 2009?

need to multiply with biomass?
```{r}
test <- merge(assemblednutrients[,c("Plot", "Nshoot2011")], synthesis[,c("Plot", "Nshoot.2011")], by="Plot")
max(test$Nshoot2011 - test$Nshoot.2011, na.rm=T)
```

