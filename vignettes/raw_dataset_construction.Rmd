---
title: "prepare functions"
author: "noelle"
date: "November 14, 2018"
output: html_document
---


# Loading file paths
The paths of file locations are stored externally in "info_data.csv" where all information is stored.
Load this file externally and store in variable "info_data". More information is given in "nonpublic.R", 
at server where the whole analysis is stored.

*note* : to read in data, you need to be connected to server. 

```{r}
# only show lines which contain path info
info_data <- info_data[grep("txt", info_data$path_unix),c("ColumnName", "path_unix")]
```


# Plot, exploratories
```{r}
PlotExplo <- data.table::fread(info_data$path_unix[grep("Biomass2011", info_data$ColumnName)], header=T, sep='\t')
PlotExplo <- PlotExplo[,c("EpPlotID", "explo")]
data.table::setnames(PlotExplo, old=c("EpPlotID", "explo"), new=c("Plot", "Explo"))
# generate old plot names
Plot <- c(paste("AEG", seq(1,50), sep=""), paste("HEG", seq(1,50), sep=""), paste("SEG", seq(1,50), sep=""))
# generate new plot names
Plotn <- c(paste("AEG", sprintf("%02d", 1:50), sep=""), paste("HEG", sprintf("%02d", 1:50), sep=""), paste("SEG", sprintf("%02d", 1:50), sep=""))
PlotExplo <- merge(PlotExplo, cbind(Plot, Plotn), by = "Plot")
# subset for raw dataset construction
# TODO : delete this line? PlotExplo <- PlotExplo[,c("Plot","Plotn")]
raw_functions <- data.table::copy(PlotExplo)
```


# Biomass
years 2008 to 2017. **caution**, 2008 might not be reliable.

all biomasses in g/m^2
```{r}
# 2008
# TODO
# 2009
# TODO
# 2010
# TODO
# 2011
Biomass2011 <- data.table::fread(info_data$path_unix[grep("Biomass2011", info_data$ColumnName)], header=T, sep='\t')
Biomass2011 <- Biomass2011[,c("EpPlotID", "biomass_g")]
data.table::setnames(Biomass2011, old = c("EpPlotID", "biomass_g"), new = c("Plot", "Biomass2011"))
# add to raw_functions dataset
raw_functions <- merge(raw_functions, Biomass2011, by="Plot") ; rm(Biomass2011)
# TODO : delete this line? Biomass2011 <- merge(PlotExplo, Biomass2011, by="Plot")

# 2012
# TODO
# 2013
# TODO
# 2014
Biomass2014 <- data.table::fread(info_data$path_unix[grep("Biomass2014", info_data$ColumnName)], header=T)
Biomass2014 <- Biomass2014[,c("EpPlotID", "biomass_g")]
data.table::setnames(Biomass2014, old = c("EpPlotID", "biomass_g"), new = c("Plot", "Biomass2014"))
raw_functions <- merge(raw_functions, Biomass2014, by="Plot"); rm(Biomass2014)

# 2015
Biomass2015 <- data.table::fread(info_data$path_unix[grep("Biomass2015", info_data$ColumnName)], header=T, quote="", drop=19)
Biomass2015 <- Biomass2015[,c("EpPlotID", "biomass_g")]
data.table::setnames(Biomass2015, old=c("EpPlotID", "biomass_g"), new=c("Plot", "Biomass2015"))
raw_functions <- merge(raw_functions, Biomass2015, by="Plot"); rm(Biomass2015)
```



# Soil Organic C
```{r}
SoilOrganicC <- data.table::fread(info_data$path_unix[grep("SoilOrganicC", info_data$ColumnName)], header=T, sep='\t')
SoilOrganicC <- SoilOrganicC[which(SoilOrganicC$Type == "G"), c("EP_Plotid","Organic_C")]
data.table::setnames(SoilOrganicC, old=c("EP_Plotid", "Organic_C"), new=c("Plot", "SoilOrganicC"))
raw_functions <- merge(raw_functions, SoilOrganicC, by="Plot"); rm(SoilOrganicC)
```


# Root biomass
Includes fine and coarse biomass, added them together.
```{r}
Root.biomass <- data.table::fread(info_data$path_unix[grep("Root.biomass", info_data$ColumnName)], header=T, sep='\t')
Root.biomass <- Root.biomass[Type == "G"]
Root.biomass <- Root.biomass[,c("EP_Plotid", "Fine_Roots_Biomass", "Coarse_Roots_Biomass")]
data.table::setnames(Root.biomass, old="EP_Plotid", new="Plot")
raw_functions <- merge(raw_functions, Root.biomass, by="Plot"); rm(Root.biomass)
```

# Flower cover
**leave out**
We can go from "total_influorescence_area_in_cm" of each species to a total flower cover. The total area measured was : 600m² per grassland plot.
TODO : left open as not sure if I include it
```{r, eval=F}
Total.flower.cover <- data.table::fread(info_data$path_unix[grep("Total.flower.cover", info_data$ColumnName)], header=T, sep='\t')
```


# Microbial phosphorous in soil
(mg/kg)
used to calculate PRI
```{r}
Pmic.2011 <- data.table::fread(info_data$path_unix[grep("Pmic.2011", info_data$ColumnName)], header=T, sep='\t')
Pmic.2011 <- Pmic.2011[grep("G", Pmic.2011$EP)]
data.table::setnames(Pmic.2011, old=c("EP", "Pmic"), new=c("Plot", "Pmic.2011"))
raw_functions <- merge(raw_functions, Pmic.2011, by="Plot"); rm(Pmic.2011)
```


# Root decomposition
Decomposition measurements of fine roots (<2mm) within the upper 10 cm of the mineral soil. Determination of mass loss after 6 months. Litterbag method. Standardized control material: beech roots for forest sites and herbaceous roots for grassland sites. Numbers in [%]

mass "loss" because decomposed roots are lost.
```{r}
Root.decomposition <- data.table::fread(info_data$path_unix[grep("Root.decomposition", info_data$ColumnName)], header=T, sep='\t')
Root.decomposition <- Root.decomposition[Type == "G"]
Root.decomposition <- data.table::setnames(Root.decomposition[,c("EP_Plotid", "Mass_loss_October_2012")], old=c("EP_Plotid", "Mass_loss_October_2012"), new=c("Plot", "Root.decomposition"))
raw_functions <- merge(raw_functions, Root.decomposition, by="Plot"); rm(Root.decomposition)
```


# Bulk density and soil C stock
**Bulk density** : Increased use of machine compact the soil. At a given point, the root growth is impaired.

**soil C stock** : C in soil

Determination bulk density and calculated CN stocks for the upper 10 cm of the mineral soil. Dry combustion of soil at a temperature of 1100°C and subsequent determination of evolving CO2 and N2 with a Thermal Conductivity Detector (TCD).

[g/cm^3]

**data is from 2011, not 2014!**

```{r}
Bulk.density.soil.C.stock.2011 <- data.table::fread(info_data$path_unix[grep("Soil.C.stock", info_data$ColumnName)], header=T, sep='\t')
Bulk.density.soil.C.stock.2011 <- Bulk.density.soil.C.stock.2011[Type == "G"]
Bulk.density.soil.C.stock.2011 <- data.table::setnames(Bulk.density.soil.C.stock.2011[,c("EP_Plotid", "BD", "OC_stock")], old=c("EP_Plotid", "BD", "OC_stock"), new=c("Plot", "Bulk.density2014", "Soil.C.stock"))
raw_functions <- merge(raw_functions, Bulk.density.soil.C.stock.2011, by="Plot"); rm(Bulk.density.soil.C.stock.2011)
```

# Herbivory

## 2013
invertebrate herbivory in 146 managed temperate grasslands. Year: 2013

increased land-use - less invertebrates - less herbivory

Visually estimation of herbivory by eye using templates and measurement of leaf area left after feeding of the herbivores using LI-COR area meter

2 samples per plot in 145 cases, 1 sample for :  "AEG6"  "HEG16" "HEG43" "SEG19" "SEG33" and 3 samples for "SEG45". 2 Columns are included in the raw_functions dataset, 1 for each sample.

SEG45 : The mean of all 3 samples was already taken and stored as sample2. Taking the mean of samples2 first and then with sample1 would lead to different results than in the synthesis dataset.
```{r}
herb <- data.table::fread(info_data$path_unix[grep("herbivory.2013", info_data$ColumnName)], header=T, sep='\t')
data.table::setorder(herb, EP_Plotid)
# prepare empty dt and names vector for forloop
ns <- unique(herb[,EP_Plotid])
# some plots don't have a secnod measure
PlotExplo$Plot[!(PlotExplo$Plot %in% ns)]
# store both measures as Herbivory1 and Herbivory2
herb1 <- herb[herb$Sample == 1, c("EP_Plotid","PercHerbivory")]
herb2 <- herb[herb$Sample == 2, c("EP_Plotid","PercHerbivory")]
# SEG45 has 3 samples. therefore take the mean of all 3 samples as measure and set herb1 to NA.
herb2 <- rbind(herb2[EP_Plotid != "SEG45"], list("SEG45", mean(herb[EP_Plotid == "SEG45", PercHerbivory])))
herb1 <- herb1[EP_Plotid != "SEG45"]
herb <- merge(herb1, herb2, by="EP_Plotid", all.x = T, all.y = T)
data.table::setnames(herb, old=c("EP_Plotid", "PercHerbivory.x", "PercHerbivory.y"), new=c("Plot", "Herbivory1", "Herbivory2"))

raw_functions <- merge(raw_functions, herb, by="Plot", all.x = T)
rm(herb); rm(herb1); rm(herb2); rm(ns); gc()
```


# Forage quality
"Futter qualität", year : 2009
forage quality (index based on crude protein concentration and relative forage value) - Eric Ecology Letters LUI

RFV : Relative Feed Value
RFQ : Relative Forage Quality
ADL : acid detergent lignin, Lignin
ADF : Acid Detergent Fibre, Säure-Detergenz-Faser, ein Teil der Gerüstsubstanzen von Futtermitteln
NDF : Neutral Detergent Fibre, Neutral-Detergenz-Faser, fasrige Anteile von Futtermitteln 

more ADF/ NDF --> less nutritional value because less easy to digest

according to forage quality estimation based on alfalfa (medicago sativa) values. [source](https://openprairie.sdstate.edu/cgi/viewcontent.cgi?referer=https://scholar.google.ch/&httpsredir=1&article=1351&context=extension_extra)

[% concentration in aboveground grassland plant community biomass without litter]
```{r}
forage.quality <- data.table::fread(info_data$path_unix[grep("forage.quality", info_data$ColumnName)], header=T, sep='\t')
# 2009
forage.quality.2009 <- forage.quality[year == "2009"]
forage.quality.2009 <- forage.quality.2009[, c("Plot", "N", "ADF", "NDF")]
data.table::setnames(forage.quality.2009, old=c("N", "ADF", "NDF"), new = c("N.2009", "ADF.2009", "NDF.2009"))
# 2010
forage.quality.2010 <- forage.quality[year == "2010"]
forage.quality.2010 <- forage.quality.2010[, c("Plot", "N", "ADF", "NDF")]
data.table::setnames(forage.quality.2010, old=c("N", "ADF", "NDF"), new = c("N.2010", "ADF.2010", "NDF.2010"))
# 2011
forage.quality.2011 <- forage.quality[year == "2011"]
forage.quality.2011 <- forage.quality.2011[, c("Plot", "N", "ADF", "NDF")]
data.table::setnames(forage.quality.2011, old=c("N", "ADF", "NDF"), new = c("N.2011", "ADF.2011", "NDF.2011"))
# 2012
forage.quality.2012 <- forage.quality[year == "2012"]
forage.quality.2012 <- forage.quality.2012[, c("Plot", "N", "ADF", "NDF")]
data.table::setnames(forage.quality.2012, old=c("N", "ADF", "NDF"), new = c("N.2012", "ADF.2012", "NDF.2012"))
# 2013
forage.quality.2013 <- forage.quality[year == "2013"]
forage.quality.2013 <- forage.quality.2013[, c("Plot", "N", "ADF", "NDF")]
data.table::setnames(forage.quality.2013, old=c("N", "ADF", "NDF"), new = c("N.2013", "ADF.2013", "NDF.2013"))
# merge all years with raw_functions
raw_functions <- merge(raw_functions, forage.quality.2009, by="Plot")
raw_functions <- merge(raw_functions, forage.quality.2010, by="Plot")
raw_functions <- merge(raw_functions, forage.quality.2011, by="Plot")
raw_functions <- merge(raw_functions, forage.quality.2012, by="Plot")
raw_functions <- merge(raw_functions, forage.quality.2013, by="Plot")
```




# Phosphorous (loss) 2011
Resin refers to the method of phosphorous measurement in soil.
```{r}
P_loss2011 <- data.table::fread(info_data$path_unix[grep("P_loss2011", info_data$ColumnName)], header=T, sep='\t')
# filter out grassland plots
P_loss2011 <- P_loss2011[grep("G", P_loss2011$EP)]
# get new plot names
data.table::setnames(P_loss2011, old=c("EP","Resin_P"), new=c("Plot","P_loss2011"))
raw_functions <- merge(raw_functions, P_loss2011, by="Plot")
```


## Phosphorous 2014
Olsen method, Pi is inorganic Phosphorous
```{r}
OlsenPi2014 <- data.table::fread(info_data$path_unix[grep("OlsenPi2014", info_data$ColumnName)], header=T, sep='\t')
# grassland plots are abbreviated with a "G", e.g. "AEG", forest plots with "W", e.g. "AEW"
OlsenPi2014 <- OlsenPi2014[grep("G",OlsenPi2014$Plot_ID),c("Plot_ID","OlsenPi")]
data.table::setnames(OlsenPi2014, old=c("Plot_ID", "OlsenPi"), new=c("Plotn", "OlsenPi2014"))
raw_functions <- merge(raw_functions, OlsenPi2014, by="Plotn")
```



## Microbial Enzyme activities
from dataset of study which characterised soil microbial communities at three levels of resolution (gene abundance, enzyme activity, and community level).

beginning of May 2011 as a mixed sample from the top horizon (0-10 cm)

beta_Glucosidase [nmol MUF g-1 h-1], Xylosidase [nmol MUF g-1 h-1], N_Acetyl_beta_Glucosaminidase [nmol MUF g-1 h-1], Urease [µg N g-1 DM 2h-1], DEA = DEA_with_C2H2 [µg N2O-N+N2 g-1 soil dw h-1], Phosphatase [nmol MUF g-1 h-1]

all concentrations given g-1.

```{r}
microbial_enzyme_activities <- data.table::fread(info_data$path_unix[grep("beta_Glucosidase", info_data$ColumnName)], header=T, sep='\t', drop=c("Exploratory", "Year"))
data.table::setnames(microbial_enzyme_activities, old=c("EP_Plot_ID","DEA_with_C2H2"), new=c("Plot", "DEA"))
raw_functions <- merge(raw_functions, microbial_enzyme_activities, by="Plot")
```



# Potential nitrification
Abundance of nitrogen fixing microbes and ammonia oxidizers. abundance and activity of nitrogen fixing microbes and ammonia oxidizing bacteria and archaea.

potential nitrification is determined according to Hoffmann et al, 2007. [ngN / g DW soil / h]

year is not clear, but probably 2011. start date is 1.9.2011, end date is 30.01.2013.

```{r}
Potential.nitrification <- data.table::fread(info_data$path_unix[grep("Potential.nitrification", info_data$ColumnName)])
Potential.nitrification <- Potential.nitrification[,c("PlotID", "pot_nitrification")]
data.table::setnames(Potential.nitrification, old=c("PlotID", "pot_nitrification"), new=c("Plot", "Potential.nitrification"))
merge(raw_functions, Potential.nitrification, by="Plot")
raw_functions <- Potential.nitrification <- merge(PlotExplo, Potential.nitrification, by="Plot")
```





