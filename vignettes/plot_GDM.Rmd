---
title: "plot GDM"
author: "Noelle Schenk"
date: "August 20, 2019"
output: html_document
---
```{r}
suppressPackageStartupMessages(require(ggplot2))
suppressPackageStartupMessages(require(cowplot))
```

```{r}
#TODO somehow structure the input choices
# maybe automatically read in all possible file names?
# shift stuff to functions
```


requirements : 
- user : connect to planteco and nsch to get input files
- GDM output as .rds, e.g. gdm_EFnestedness_LUI_input.Rds
- cluster output as .rds, e.g. gdm_EFnestedness_LUI_permutation.Rds
- run `results_nonpublic.R` : load pathtoout and nicenames
  - run `plotting.R` to have function create_restab2() working (data.table problem)


## Prepare the regression testing
Prepare the variables which are used for regression testing
```{r, eval = F}
luiinput <- "lui"
name <- "gdm_EFturnover_0.75_LUI"
```


## Load data
```{r}
luiinput <- "lui"
# luiinput <- "components"

name <- "gdm_EFturnover_0.75_LUI"

# gdmin <- readRDS(paste(pathtoout, "/cluster/gdm_EFturnover_0.5_LUI_input.Rds", sep = ""))
# gdmin <- readRDS(paste(pathtoout, "/cluster/gdm_EFdistance_Gstd_input.Rds", sep = ""))
gdmin <- readRDS(paste(pathtoout, "/cluster/", name, "_input.Rds", sep = ""))

gdm_output <- gdm::gdm(gdmin, geo = F, splines = NULL, knots = NULL)
exSplines <- gdm::isplineExtract(gdm_output)

# gdmperm <- readRDS(paste(pathtoout, "/cluster/gdm_EFdistance_LUI_permutation.Rds", sep = ""))
# gdmperm <- readRDS(paste(pathtoout, "/cluster/gdm_EFnestedness_LUI_permutation.Rds", sep = ""))

permut <- F # T or F, depending wether permutations are available or not
main <- name # plot title
create_plot <- T
```
```{r}
# take maximum of each variable for barplot
maxsplines <- apply(exSplines$y, 2, max, na.rm = TRUE)
# get significances
if(permut == T){sign <- gdmperm[[3]][,1]}
```
create plotting tables

Sequence according to effect sizes over all models. until then : alphabetically.
```{r}
#TODO : once all models are read, use effect size sequence and not alphabetically
plotsequence_bio <- c("autotroph", "bacteria.RNA", "belowground.herbivore", "belowground.predator", "herbivore", "plant.pathogen", "pollinator", "protist.bacterivore", "protist.eukaryvore", "protist.omnivore", "protist.plant.parasite", "secondary.consumer", "soilfungi.decomposer", "soilfungi.pathotroph", "soilfungi.symbiont", "tertiary.consumer")
#TODO : add characteristic color for each trophic level

print("userinput")
if(luiinput == "lui"){
  plotsequence_abio <- c("LUI", "deltaLUI", "soil", "isolation", "geo")
}else if(luiinput == "components"){
  plotsequence_abio <- c(paste(c("G", "M", "F"), "std", sep = ""), paste("delta", c("Gstd", "Mstd", "Fstd"), sep = ""),
                         "soil", "isolation", "geo")
}
```

create results table
```{r}
restab <- data.table::data.table("names" = names(maxsplines), "maxsplines" = maxsplines)
if(permut == T){
  del <- data.table::data.table("names" = names(sign), "sign" = sign)
  restab <- data.table::data.table(merge(restab, del, by = "names")); rm(del)
}
# get bios
bios <- grep(paste(plotsequence_bio, collapse = "|"), names(maxsplines), value = T)
restab[names %in% bios, type := "bio"]
# get abios
abios <- grep(paste(plotsequence_bio, collapse = "|"), names(maxsplines), value = T, invert = T)
restab[names %in% abios, type := "abio"]
# get nestedness
sne <- grep("sne", names(maxsplines), value = T)
restab[names %in% sne, component := "nestedness"]
# get turnover
to <- grep("sim", names(maxsplines), value = T)
restab[names %in% to, component := "turnover"]
# get only significant
if(permut == T){restab[, maxsplines := (1-sign) * maxsplines]}
# add nice names
restab <- data.table::data.table(merge(nicenames, restab, by = "names"))
# order by above-belowground and alphabetically
# set the levels of the factor in the wanted order
data.table::setorder(restab, ground, names)
# restab[, names := factor(names, levels = names)]
# order <- restab[type == "bio", names]
# bring colors into right format
restab[, color := as.character(color)]

restab[type == "abio", component := "abio"]

restab[component %in% c("turnover", "abio"), linetypet := "solid"]
restab[component == "nestedness", linetypet := "dotted"]
```


simple plot
```{r, eval = F}
# to plot each spline in a separate plot
plot(gdm_output, plot.layout = c(3, 2), plot.color = "grey", main="GDM")
```


# Multipanel Barplot

```{r, eval = F}
if(create_plot){
  df <- restab[type == "bio" & ground == "a", ]
  p<-ggplot(data = df, aes(x=nicenames, y=maxsplines, fill = color, linetype = linetypet)) +
    geom_bar(stat="identity", color = "black") + 
    coord_flip() + 
    scale_fill_identity() + scale_linetype_identity() + # the best option for customizing linetype, color,...!
    ylim(0, 0.44) + 
    ggtitle(main) +
    theme(legend.position = "none", axis.title = element_blank(),
          axis.text.y = element_text(size=9, angle = 0),
          plot.margin = margin(l = 50), 
          axis.text.x = element_blank(),
          axis.line.x=element_blank(),
          axis.ticks.x = element_blank(),
          panel.grid.major.x = element_line(color = "grey")
    )
  
  df <- restab[type == "bio" & ground == "b", ]
  b <- ggplot(data = df, aes(x=nicenames, y=maxsplines, fill = color, linetype = linetypet)) +
    geom_bar(stat="identity", color = "black") + 
    coord_flip() +
    scale_fill_identity() + scale_linetype_identity() +
    ylim(0, 0.44) +
    theme(legend.position = "none", 
          axis.title = element_blank(),
          axis.text.y = element_text(size=9, angle = 0),
          plot.margin = margin(l = 50),
          axis.text.x = element_blank(),
          axis.line.x=element_blank(),
          axis.ticks.x = element_blank(),
          panel.grid.major.x = element_line(color = "grey"))
  # aes(x=stringr::str_wrap(nicenames, 10), y=onlysign, fill = names))
  
  # dashed or dotted or solid
  # https://stackoverflow.com/questions/39898870/ggplot-geom-bar-customize-by-linetype-and-fill
  # geom_errorbarh() for horizontal error bars
  # https://www.heropatterns.com/
  # df <- restab[type == "abio"]
  df <- restab[ground == "x"]
  q <- ggplot(data = df, aes(x=nicenames, y=maxsplines, fill = names, linetype = linetypet)) +
    geom_bar(stat="identity", color = "black") + 
    coord_flip() + 
    scale_fill_manual(values = df$color) + scale_linetype_identity() +
    ylim(0, 0.44) + 
    theme(legend.position = "none", axis.title = element_blank(),
          axis.text.y = element_text(size=9),
          panel.grid.major.x = element_line(color = "grey"))
  # # plot pure legend - only works if legend is there (legend.position taken out)
  # legend <- cowplot::get_legend(q)
  # plot_grid(NULL, legend)
}

```
```{r, eval = F}
if(create_plot == T){
  plot_grid(p, b, q, labels = c('A', '', 'B'), label_size = 12, nrow = 3, rel_heights = c(0.31, 0.51, 0.18), align = "v")

  # plot_grid(p, b, q, labels = c('aboveground', 'belowground', 'abiotic'), label_size = 12, nrow = 3, rel_heights = c(0.31, 0.51, 0.18), align = "v")
}
```

Multipanel barplot with overview bars

Aboveground - belowground - abiotic
```{r}
#TODO : requires to run manually plotting.R because of data.table issue

restab2 <- create_restab2()
restab2 <- restab2[type %in% c("unscaled", "averaged_scaled")]
df <- data.frame(restab2)
ov1 <- ggplot(data = df, aes(x=type, y=maxsplines, fill = color)) +
  geom_bar(stat="identity", color = "black", linetype = "solid") +
  coord_flip() +
  scale_fill_identity() +
  theme(legend.position = "none", axis.title = element_blank(),
        axis.text.y = element_text(size=9),
        panel.grid.major.x = element_line(color = "grey"))
# plot pure legend
# legend <- cowplot::get_legend(ov1)
# plot_grid(NULL, legend, ncol = 1)
```
```{r, eval = T}
if(create_plot == T){
  plot_grid(p, b, q, ov1, labels = c('A', '', 'B', 'C'), label_size = 12, nrow = 4, rel_heights = c(0.08, 0.11, 0.065, 0.035), align = "v") # LUI components
}
```

turnover - nestedness - abiotic
```{r}
restab3 <- create_restab_3()
restab3 <- restab3[type %in% c("unscaled", "averaged_scaled")]
df <- data.frame(restab3)
ov2 <- ggplot(data = df, aes(x=type, y=maxsplines, fill = color)) +
  geom_bar(stat="identity", color = "black", linetype = "solid") +
  coord_flip() +
  scale_fill_identity() +
  theme(legend.position = "none", axis.title = element_blank(),
        axis.text.y = element_text(size=9),
        panel.grid.major.x = element_line(color = "grey"))
# plot pure legend
# legend <- cowplot::get_legend(ov2)
# plot_grid(NULL, legend)
```
```{r, eval = T}
if(create_plot){
  # plot_grid(p, b, q, ov1, ov2, labels = c('A', '', 'B', 'C', ''), label_size = 12, nrow = 5, rel_heights = c(0.27, 0.37, 0.13, 0.11, 0.11), align = "v") # LUI components
  plot_grid(p, b, q, ov1, ov2, labels = c('A', '', 'B', 'C', ''), label_size = 12, nrow = 5, rel_heights = c(0.27, 0.37, 0.13, 0.075, 0.075), align = "v") # 2 summary bars
}
```

```{r,eval = T}
restab <- list(restab, restab2, restab3)
saveRDS(restab, paste("list_restab_", name, ".Rds", sep = ""))
```






# testing
```{r}
tolerance <- 10^(-3)

check_restab_summary_stats <- function(restab, restab2, restab3, tolerance){
  res <- c()
  res["mean_restab_a"] <- abs(mean(restab[[1]]$maxsplines) - 0.05098799) < tolerance
  res["mean_restab_b"] <- abs(mean(restab[[2]]$maxsplines) - 0.4810926) < tolerance
  res["mean_restab_c"] <- abs(mean(restab[[3]]$maxsplines) - 0.4810926) < tolerance
  res["mean_restab2"] <- abs(mean(restab2$maxsplines) - 0.4810926) < tolerance
  res["mean_restab3"] <- abs(mean(restab3$maxsplines) - 0.4810926) < tolerance
  res["nrow_restab_a_b_c"] <- abs(nrow(restab[[1]]) + nrow(restab[[2]]) + nrow(restab[[3]]) - 49) < tolerance
  res["nrow_restab2_3"] <- abs(nrow(restab2) - nrow(restab3)) < tolerance
  res["length_restab2_equal_restab3"] <- length(restab2) == length(restab3)
  return(res)
}

run_EFturnover075_test <- function(){
  res <- check_restab_summary_stats(restab, restab2, restab3, tolerance = tolerance)
  if(all(res) == T){
    print("test was successful. Mean and length of restab, restab2 and restab3 are as expected.")
  } else {
    print("test not successful. Inspect the following vector in order to see which ")
  }
}

run_EFturnover075_test()
```









# single EFs heatmap


load data
```{r, eval = F}
singleEFdist <- readRDS(paste(pathtodata, "/assembled_data/general/singleEFdist.rds", sep = "")) # already scaled
i <- 1
ni <- colnames(singleEFdist)[!colnames(singleEFdist) %in% c("Var1", "Var2")][i]
i <- paste(pathtoout, "/cluster/gdm_", ni, "_LUI_input.Rds", sep = "")
gdmin <- readRDS(i)
permut <- "F"

gdm_output <- gdm::gdm(gdmin, geo = F, splines = NULL, knots = NULL)
exSplines <- gdm::isplineExtract(gdm_output)

main <- "EFsingle" # plot title

# take maximum of each variable for barplot
maxsplines <- apply(exSplines$y, 2, max, na.rm = TRUE)
# get significances
if(permut == T){sign <- gdmperm[[3]][,1]}

# create restults table
restab <- create_restab()
data.table::setnames(restab, old = "maxsplines", new = ni)
restab2 <- data.table::copy(restab)
```

```{r, eval = F}
i <- 2
for(i in 2:(length(colnames(singleEFdist))-2)){
  print(i)
  ni <- colnames(singleEFdist)[!colnames(singleEFdist) %in% c("Var1", "Var2")][i]
  i <- paste(pathtoout, "/cluster/gdm_", ni, "_LUI_input.Rds", sep = "")
  gdmin <- readRDS(i)
  permut <- "F"
  gdm_output <- gdm::gdm(gdmin, geo = F, splines = NULL, knots = NULL)
  exSplines <- gdm::isplineExtract(gdm_output)
  # take maximum of each variable for barplot
  maxsplines <- apply(exSplines$y, 2, max, na.rm = TRUE)
  # get significances
  if(permut == T){sign <- gdmperm[[3]][,1]}
  
  restab <- create_restab()
  restab <- data.table::data.table(restab)
  data.table::setnames(restab, old = "maxsplines", new = ni)
  include <- c(ni, "names")
  restab2 <- merge(restab2, restab[, ..include], by = "names", all.x = T)
}
restab2 <- data.table::data.table(restab2)
```
Create heatmap
```{r, eval = F}
# pal <- RColorBrewer::brewer.pal(9, "YlOrRd")
pal <- RColorBrewer::brewer.pal(9, "Greys")
include <- c("nicenames", colnames(singleEFdist)[!colnames(singleEFdist) %in% c("Var1", "Var2")])

df <- restab2[type == "bio" & ground == "a", ]
df <- data.table::melt(df[, ..include], id.vars = "nicenames")

a <- ggplot(data = df, aes(x = variable, y = nicenames, fill = value)) +
  geom_tile() +
  scale_fill_gradientn(colours = pal) +
  theme(axis.text.x = element_text(angle = 90, vjust = 1, 
    size = 12, hjust = 1),
    plot.margin = margin(l = 50),
    axis.line.x=element_blank(),
    axis.text.y = element_text(size=9, angle = 0),
    axis.ticks.x = element_blank(),
    panel.grid.major.x = element_line(color = "grey"),
    axis.title = element_blank(),
    legend.position = "top") + 
  scale_x_discrete(position = "top") 

df <- restab2[type == "bio" & ground == "b", ]
df <- data.table::melt(df[, ..include], id.vars = "nicenames")
b <- ggplot(data = df, aes(x = variable, y = nicenames, fill = value)) +
  geom_tile() +
  scale_fill_gradientn(colours = pal) +
  theme(legend.position = "none", 
        axis.title = element_blank(),
        axis.text.y = element_text(size=9, angle = 0),
        plot.margin = margin(l = 50),
        axis.text.x = element_blank(),
        axis.line.x=element_blank(),
        axis.ticks.x = element_blank(),
        panel.grid.major.x = element_line(color = "grey"))


df <- restab2[type == "abio", ]
df <- data.table::melt(df[, ..include], id.vars = "nicenames")
c <- ggplot(data = df, aes(x = variable, y = nicenames, fill = value)) +
  geom_tile() +
  scale_fill_gradientn(colours = pal) +
  theme(legend.position = "none", 
        axis.title = element_blank(),
        axis.text.y = element_text(size=9, angle = 0),
        plot.margin = margin(l = 50),
        axis.text.x = element_blank(),
        axis.line.x=element_blank(),
        axis.ticks.x = element_blank(),
        panel.grid.major.x = element_line(color = "grey"))

```

```{r, eval = F}
# plot_grid(a, b, c, labels = c('A', '', 'B'), label_size = 12, nrow = 3, rel_heights = c(0.31, 0.51, 0.18), align = "v")
plot_grid(a, b, c, labels = c('A', '', 'B'), label_size = 12, nrow = 3, rel_heights = c(0.43, 0.47, 0.11), align = "v")
# plot_grid(a, b, c, labels = c('A', '', 'B'), label_size = 12, nrow = 3, rel_heights = c(0.58, 0.44, 0.10), align = "v") # grayscale with legend

# plot_grid(p, b, q, labels = c('aboveground', 'belowground', 'abiotic'), label_size = 12, nrow = 3, rel_heights = c(0.31, 0.51, 0.18), align = "v")
```




