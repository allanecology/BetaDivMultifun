---
title: "plot GDM"
author: "Noelle Schenk"
date: "August 20, 2019"
output: html_document
---
```{r}
suppressPackageStartupMessages(require(ggplot2))
suppressPackageStartupMessages(require(cowplot))
#TODO add @import package to the function which will be used for plotting
```

```{r}
#TODO :  fill in code to work with significances
#TODO : order of trophic groups :  once all models are read, use effect size sequence and not alphabetically
```


requirements : 
- user : connect to planteco and nsch to get input files
- GDM output as .rds, e.g. gdm_EFnestedness_LUI_input.Rds
- cluster output as .rds, e.g. gdm_EFnestedness_LUI_permutation.Rds
- run `results_nonpublic.R` : load pathtoout, nicenames and model_names
  - pathtoout : path to location where gdm input of model is stored. points to a folder, where the folder cluster witht the model input is.
  - nicenames : helper file to get nice names of functions and trophic levels
  - model_names : helper file for automation. Contains 3 columns : `name`  contains the all model names for `model_name`, `luiinput` contains either "lui" or "components" as LUI input for `luiinput` and `permut` is either TRUE or FALSE.


## Load data

### User input
Either chose automaticrun T or F. If T, the model names and lui input are automatically read in from model_names in a loop, started from `results_nonpublic.R`.
```
for(i in nrow(model_names)){
  source("plot_GDM.R")
}
```
If F, `luiinput` and `model_name` need to be given manually.
*note* that i <- 6 for testing.
```{r}
automaticrun <- T
create_plot <- T
permut <- F # T or F, depending wether permutations are available or not
# i <- 6 # i <- 6 for testing
if(automaticrun){
  print("automatic input")
  luiinput <- model_names$luiinput[i]
  model_name <- model_names$name[i]
  permut <- model_names$permut[i]
} else {
  luiinput <- "lui" # luiinput <- "components"
  model_name <- "gdm_EFturnover_0.75_LUI"
}
if(permut == T){
  gdmperm <- readRDS(paste(pathtoout, "/cluster/gdm_EFnestedness_LUI_permutation.Rds", sep = ""))
  sign <- gdmperm[[3]][,1]
}
```

read input data and produce gdm result
```{r}
gdm_output <- readRDS(paste_gdm_input_path_together(pathtoout = pathtoout, name = model_name))
exSplines <- gdm::isplineExtract(gdm_output)
```
create plotting tables

Sequence according to effect sizes over all models. until then : alphabetically.
```{r}
plotsequence_bio <- c("autotroph", "bacteria.RNA", "belowground.herbivore", "belowground.predator", "herbivore", "plant.pathogen", "pollinator", "protist.bacterivore", "protist.eukaryvore", "protist.omnivore", "protist.plant.parasite", "secondary.consumer", "soilfungi.decomposer", "soilfungi.pathotroph", "soilfungi.symbiont", "tertiary.consumer")
plotsequence_abio <- define_rownames_lui_or_components(luiinput = luiinput)
```


# create lineplot
```{r}
# extract I splines y axes and get LUI x axis
lineplot_data <- data.table(cbind(exSplines$x[, "Geographic"], exSplines$y))
setnames(lineplot_data, old = c("V1", "Geographic"), new = c("xaxis", "LUI"))
lineplot_data <- melt(lineplot_data, measure.vars = colnames(lineplot_data)[-1], id.vars = "xaxis", 
                      variable.name = "names")
# adding plot information from nicenames
lineplot_data <- merge(lineplot_data, nicenames, by = "names", all.x = T)

# above, below and abiotic subplots
p <- create_gdm_lineplot(lineplot_data[ground == "a"]) + labs(title = model_name)
q <- create_gdm_lineplot(lineplot_data[ground == "b"])
r <- create_gdm_lineplot(lineplot_data[ground == "x"])
biotic_legend <- get_nice_legend(type = "biotic") # plot with plot_grid(biotic_legend)
abiotic_legend <- get_nice_legend(type = "abiotic")

# add together the subplots
lin <- plot_grid(p, biotic_legend, q, NULL, r, abiotic_legend,  labels = c('A', '', 'B', '', 'C', ''), nrow = 3)
```





create results table
```{r, eval = T}
maxsplines <- apply(exSplines$y, 2, max, na.rm = TRUE) # take maximum of each variable for barplot

restab <- create_restab0()
```


# Multipanel Barplot
without overview bars
```{r, eval = T}
p <- create_bio_aboveground_barplot()
b <- create_bio_belowground_barplot()
# dashed or dotted or solid
# https://stackoverflow.com/questions/39898870/ggplot-geom-bar-customize-by-linetype-and-fill
# geom_errorbarh() for horizontal error bars
# https://www.heropatterns.com/
q <- create_abio_barplot()
# # plot pure legend - only works if legend is there (legend.position taken out)
# legend <- cowplot::get_legend(q)
# plot_grid(NULL, legend)
```
overview bar : Aboveground - belowground - abiotic
```{r}
restab2 <- create_restab2()
restab2 <- restab2[type %in% c("unscaled", "averaged_scaled")]
df <- data.frame(restab2)
ov1 <- create_overview_above_below_abiotic_barplot()
# plot pure legend
# legend <- cowplot::get_legend(ov1)
# plot_grid(NULL, legend, ncol = 1)
```
overview bar : turnover - nestedness - abiotic
```{r}
restab3 <- create_restab_3()
restab3 <- restab3[type %in% c("unscaled", "averaged_scaled")]
df <- data.frame(restab3)

# ov2 <- ggplot(data = df, aes(x=type, y=maxsplines, fill = color)) +
#   geom_bar(stat="identity", color = "black", linetype = "solid") +
#   coord_flip() +
#   scale_fill_identity() +
#   theme(legend.position = "none", axis.title = element_blank(),
#         axis.text.y = element_text(size=9),
#         panel.grid.major.x = element_line(color = "grey"))
ov2 <- create_overview_turnover_nestedness_abiotic_barplot()
# plot pure legend
# legend <- cowplot::get_legend(ov2)
# plot_grid(NULL, legend)
```

```{r, eval = T}
if(create_plot == T){
  multipanel_without_overviews <- plot_grid(p, b, q, labels = c('A', '', 'B'), label_size = 12, nrow = 3, rel_heights = c(0.31, 0.51, 0.18), align = "v")
  # plot_grid(p, b, q, labels = c('aboveground', 'belowground', 'abiotic'), label_size = 12, nrow = 3, rel_heights = c(0.31, 0.51, 0.18), align = "v")
  
  # multipanel_with_overview_above_below <- plot_grid(p, b, q, ov1, labels = c('A', '', 'B', 'C'), label_size = 12, nrow = 4, rel_heights = c(0.08, 0.11, 0.065, 0.035), align = "v") # LUI components
  
  multipanel_with_overview_bars <- plot_grid(p, b, q, ov1, ov2, labels = c('A', '', 'B', 'C', ''), label_size = 12, nrow = 5, rel_heights = c(0.27, 0.37, 0.13, 0.075, 0.075), align = "v") # 2 summary bars
  # plot_grid(p, b, q, ov1, ov2, labels = c('A', '', 'B', 'C', ''), label_size = 12, nrow = 5, rel_heights = c(0.27, 0.37, 0.13, 0.11, 0.11), align = "v") # LUI components
}

```


```{r,eval = T}
restab <- list(restab, restab2, restab3)
saveRDS(restab, paste("list_restab_", model_name, ".Rds", sep = ""))

ggsave(filename=paste(model_name, "_multipanel_barplot.pdf", sep = ""), plot = multipanel_without_overviews, device=cairo_pdf,
       width = 11.96, height = 8.27, units = "in", dpi = 900)
ggsave(filename = paste(model_name, "_multipanel_barplot_overviewbars.pdf", sep = ""), plot = multipanel_with_overview_bars, device=cairo_pdf,
       width = 11.96, height = 8.27, units = "in", dpi = 900)
```






# testing
```{r, eval = F}
tolerance <- 10^(-3)

check_restab_summary_stats <- function(restab, restab2, restab3, tolerance){
  res <- c()
  res["mean_restab_a"] <- abs(mean(restab[[1]]$maxsplines) - 0.05098799) < tolerance
  res["mean_restab_b"] <- abs(mean(restab[[2]]$maxsplines) - 0.4810926) < tolerance
  res["mean_restab_c"] <- abs(mean(restab[[3]]$maxsplines) - 0.4810926) < tolerance
  res["mean_restab2"] <- abs(mean(restab2$maxsplines) - 0.4810926) < tolerance
  res["mean_restab3"] <- abs(mean(restab3$maxsplines) - 0.4810926) < tolerance
  res["nrow_restab_a_b_c"] <- abs(nrow(restab[[1]]) + nrow(restab[[2]]) + nrow(restab[[3]]) - 49) < tolerance
  res["nrow_restab2_3"] <- abs(nrow(restab2) - nrow(restab3)) < tolerance
  res["length_restab2_equal_restab3"] <- length(restab2) == length(restab3)
  return(res)
}

run_EFturnover075_test <- function(){
  res <- check_restab_summary_stats(restab, restab2, restab3, tolerance = tolerance)
  if(all(res) == T){
    print("test was successful. Mean and length of restab, restab2 and restab3 are as expected.")
  } else {
    print("test not successful. Inspect the following vector in order to see which ")
  }
}

run_EFturnover075_test()
```









# single EFs heatmap


load data
```{r, eval = F}
singleEFdist <- readRDS(paste(pathtodata, "/assembled_data/general/singleEFdist.rds", sep = "")) # already scaled
i <- 1
ni <- colnames(singleEFdist)[!colnames(singleEFdist) %in% c("Var1", "Var2")][i]
i <- paste(pathtoout, "/cluster/gdm_", ni, "_LUI_input.Rds", sep = "")
gdmin <- readRDS(i)
permut <- "F"

gdm_output <- gdm::gdm(gdmin, geo = F, splines = NULL, knots = NULL)
exSplines <- gdm::isplineExtract(gdm_output)

# take maximum of each variable for barplot
maxsplines <- apply(exSplines$y, 2, max, na.rm = TRUE)
# get significances
if(permut == T){sign <- gdmperm[[3]][,1]}

# create restults table
restab <- create_restab()
data.table::setnames(restab, old = "maxsplines", new = ni)
restab2 <- data.table::copy(restab)
```

```{r, eval = F}
i <- 2
for(i in 2:(length(colnames(singleEFdist))-2)){
  print(i)
  ni <- colnames(singleEFdist)[!colnames(singleEFdist) %in% c("Var1", "Var2")][i]
  i <- paste(pathtoout, "/cluster/gdm_", ni, "_LUI_input.Rds", sep = "")
  gdmin <- readRDS(i)
  permut <- "F"
  gdm_output <- gdm::gdm(gdmin, geo = F, splines = NULL, knots = NULL)
  exSplines <- gdm::isplineExtract(gdm_output)
  # take maximum of each variable for barplot
  maxsplines <- apply(exSplines$y, 2, max, na.rm = TRUE)
  # get significances
  if(permut == T){sign <- gdmperm[[3]][,1]}
  
  restab <- create_restab()
  restab <- data.table::data.table(restab)
  data.table::setnames(restab, old = "maxsplines", new = ni)
  include <- c(ni, "names")
  restab2 <- merge(restab2, restab[, ..include], by = "names", all.x = T)
}
restab2 <- data.table::data.table(restab2)
```
Create heatmap
```{r, eval = F}
# pal <- RColorBrewer::brewer.pal(9, "YlOrRd")
pal <- RColorBrewer::brewer.pal(9, "Greys")
include <- c("nicenames", colnames(singleEFdist)[!colnames(singleEFdist) %in% c("Var1", "Var2")])

df <- restab2[type == "bio" & ground == "a", ]
df <- data.table::melt(df[, ..include], id.vars = "nicenames")

a <- ggplot(data = df, aes(x = variable, y = nicenames, fill = value)) +
  geom_tile() +
  scale_fill_gradientn(colours = pal) +
  theme(axis.text.x = element_text(angle = 90, vjust = 1, 
    size = 12, hjust = 1),
    plot.margin = margin(l = 50),
    axis.line.x=element_blank(),
    axis.text.y = element_text(size=9, angle = 0),
    axis.ticks.x = element_blank(),
    panel.grid.major.x = element_line(color = "grey"),
    axis.title = element_blank(),
    legend.position = "top") + 
  scale_x_discrete(position = "top") 

df <- restab2[type == "bio" & ground == "b", ]
df <- data.table::melt(df[, ..include], id.vars = "nicenames")
b <- ggplot(data = df, aes(x = variable, y = nicenames, fill = value)) +
  geom_tile() +
  scale_fill_gradientn(colours = pal) +
  theme(legend.position = "none", 
        axis.title = element_blank(),
        axis.text.y = element_text(size=9, angle = 0),
        plot.margin = margin(l = 50),
        axis.text.x = element_blank(),
        axis.line.x=element_blank(),
        axis.ticks.x = element_blank(),
        panel.grid.major.x = element_line(color = "grey"))


df <- restab2[type == "abio", ]
df <- data.table::melt(df[, ..include], id.vars = "nicenames")
c <- ggplot(data = df, aes(x = variable, y = nicenames, fill = value)) +
  geom_tile() +
  scale_fill_gradientn(colours = pal) +
  theme(legend.position = "none", 
        axis.title = element_blank(),
        axis.text.y = element_text(size=9, angle = 0),
        plot.margin = margin(l = 50),
        axis.text.x = element_blank(),
        axis.line.x=element_blank(),
        axis.ticks.x = element_blank(),
        panel.grid.major.x = element_line(color = "grey"))

```

```{r, eval = F}
# plot_grid(a, b, c, labels = c('A', '', 'B'), label_size = 12, nrow = 3, rel_heights = c(0.31, 0.51, 0.18), align = "v")
plot_grid(a, b, c, labels = c('A', '', 'B'), label_size = 12, nrow = 3, rel_heights = c(0.43, 0.47, 0.11), align = "v")
# plot_grid(a, b, c, labels = c('A', '', 'B'), label_size = 12, nrow = 3, rel_heights = c(0.58, 0.44, 0.10), align = "v") # grayscale with legend

# plot_grid(p, b, q, labels = c('aboveground', 'belowground', 'abiotic'), label_size = 12, nrow = 3, rel_heights = c(0.31, 0.51, 0.18), align = "v")
```




