<!--
%\VignetteEngine{knitr}
%\VignetteIndexEntry{ISMB Twitter Analysis}
-->
*how to work on this file*

There are TODO's, WAITING's


*note:*

This is where the analysis is performed and described.
All necessary functions will be written in separate R files.
As described [here](http://rmflight.github.io/post/vignette-analysis/).


# Reproducibility
This vignette and package were built as recommended by the blogpost of [Hilary Parker](https://hilaryparker.com/2014/04/29/writing-an-r-package-from-scratch/), [the book "R packages"](http://r-pkgs.had.co.nz/) and the idea of using `R packages` for an analysis is coming from Robert M. Flight's blogposts, where he explains [why](http://rmflight.github.io/post/analyses-as-packages/) and [how](http://rmflight.github.io/post/vignette-analysis/) to use `R package` for an analysis.

Working with [Google's R Style Guide](https://google.github.io/styleguide/Rguide.xml).

## packrat
In order to be clear on R package versions and dependencies, [packrat](http://rstudio.github.io/packrat/) was used. 
```{r, eval=F}
# devtools::install_github("rstudio/packrat")
require(packrat)
```
Follow the [walktrough](http://rstudio.github.io/packrat/walkthrough.html) from packrat, which they highly recommend.


## personalisation
To run this script with personal, non-public content, run `nonpublic.R` . TODO: an empty version of the file will be uploaded, named `nonpublic_empty.R`

```{r, eval=F}
include.nonpublic <- readline(prompt="Fill in nonpublic variables from file nonpublic.Rmd? y or n ")
if (include.nonpublic == "y") {
  source("nonpublic.R")
}
```


# Dataset
## about

| var name   | ID     | content                   | year |
| ---------- | ------ | ------------------------- | ---- |
|   soil     | bla    | bla                       |      |
|   pH       | bli    | blu                       |  |
| spdivGRL   | ... | species diversity in grasslands |  |
| spinfoGRL  | ... | info about species diversity in grasslands |  |
| landscape  | ... | ... |  |
| plotNames  | ... | ... |  |
| plotCoord  | | |  |
| covar      | | environmental coovariates |  |
| funct       | EP grass functions & services.txt | Ecosystem functions data, pre-cleaned by eric |  |
| lui        | 20907 | land-use intensity data |  |
| lui5y      | ? by-hand | some update of lui dataset | 2006-2010 |
```{r, eval=F}
varnames <- c("soil", "pH", "spdivGRL", "spinfoGRL", "landscape", "plotNames", "plotCoord", "covar", "funs", "lui")
varIDs <- c(NA, NA, NA, NA, NA, NA, NA, NA, NA, 20907)
```


## obtain dataset from BExIS
With account on [BExIS](https://www.bexis.uni-jena.de). Using the script `accesBexis.R` from Bexis. Download and store it a folder with path `accesBexispath`.
```{r, eval=F}
# accesBexispath <- "C:/Users/nschenk/Documents/BEF/BExIS/"
source(paste(accesBexispath,"accessBexis.R", sep=""))
```

As this script is public, user-input is requested to fill in variables `datasetid`, `user`, `pswd` and a name for the downloaded dataset. The first 3 variables are requested by the function `read.service` from the script `accessBexis.R`.

**single dataset download**
```{r, eval=F}
my_name <- readline(prompt="BExIS user name : ")
my_password <- readline(prompt="BExIS password : ")
my_datasetid <- readline(prompt="BExIS dataset ID : ")
my_varname <- readline(prompt="BExIS dataset name which will be used in R")
downloaded_dataset <- read.service(datasetid = my_datasetid, user = my_name, pswd = my_password)
assign(my_varname, downloaded_dataset)
# delete unwanted variables
rm(my_name, my_password, my_datasetid); gc()
```


## land-use intensity (LUI)
LUI is standardised among five years, from 2006-2010.
```{r}
LUI <- loadAndCleanLUI(path=pathtodata)
```
### variation in LUI
TODO calculate variation in LUI of many years. Standardize each m,g amd f with the average value across ALL years, to keep the variation!--> do this by hand, not with the online LUI tool!


## ecosystem functions
```{r}
funct <- loadAndCleanEcosystemFunctions(path=pathtodata)
```
WAITING : checking correlations between functions - follow eric's script "create function database.R" once it is clear how to deal with the functions.
```{r}
# WAITING : here! check in other file how I found out which input variables are too correlated to include. 
```


## Biodiversity
We will average biodiversity data across several years. Not for OTU measures, as they differ too much across years. For presence-absence, we say that a species is present if it was present at least in one year. 

TODO : is the diversity correlated among years? (can we combine years?)

```{r}

```



### Biodiversity abundance
**leave abundance out for the moment** to make things easier.

For abundance : take one year and standardise all species per plot. All species of 1 plot should sum to 1. Then, average across years of these standardised values. Do this for bats and birds separately before combining them, because bats and bird abundances were measured differently. (Bat abundance was the amount of sounds measured, but one bat may produce several sounds. Birds were measured visually and as well with sounds, but different than bats.)

Open question: is it possible to work with relative abundances for Betadiversity? Does that impact the abundance turnover component?

We may lose situations where one plot has many species and another plot has a low amount of species. So the question is - is the value changing a lot? Standardisation can only happen either per year OR per plot. Per plot makes sense, because presumably the same person measured the diversity of a given plot, and the abundance can differ among persons. To keep the situation mentioned above, we would need to standardise per year and not per plot. According to Eric, that would only be the case in a low number of situations. But would be needed to confirm it.


