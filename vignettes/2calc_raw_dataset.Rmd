---
title: "assembled dataset construction"
author: "noelle"
date: "December 5, 2018"
output: html_document
---

# create dataset
```{r}
security_copy <- data.table::copy(raw_functions)
```


# Biomass 2009
2 treatments, avg


# Root biomass
rb = fine root + coarse root biomass
```{r}
Root.biomass <- list_raw_functions$Root.biomass
Root.biomass[, "Root.biomass" := rowSums(.SD,na.rm=T), .SDcols=c("Fine_Roots_Biomass", "Coarse_Roots_Biomass")]
Root.biomass <- Root.biomass[, c("Plot", "Root.biomass")]
raw_functions <- merge(raw_functions, Root.biomass, by="Plot", all=T)
```

# Groundwater recharge
```{r}
Gtot <- list_raw_functions$Groundwater.recharge
raw_functions[, Groundwater.recharge := rowMeans(Gtot[,c(paste("Groundwater.recharge", seq(2010,2016), sep=""))])]
```


# forage quality
RFV : Relative Feed Value
RFQ : Relative Forage Quality
ADL : acid detergent lignin, Lignin
ADF : Acid Detergent Fibre, Säure-Detergenz-Faser, ein Teil der Gerüstsubstanzen von Futtermitteln
NDF : Neutral Detergent Fibre, Neutral-Detergenz-Faser, fasrige Anteile von Futtermitteln 

according to forage quality estimation based on alfalfa (medicago sativa) values. [source](https://openprairie.sdstate.edu/cgi/viewcontent.cgi?referer=https://scholar.google.ch/&httpsredir=1&article=1351&context=extension_extra)

[% concentration in aboveground grassland plant community biomass without litter]

```{r, eval=F}
# calculating the columns needed for forage quality calc
forage.quality[, Crude.protein := 6.25*N]
forage.quality[, DDM := 88.9-(0.779* ADF)]
forage.quality[, DMI := 120/NDF]
forage.quality[, RFV := (DDM*DMI)/1.29]
forage.quality[, forage.quality := apply(scale(forage.quality[,c("RFV", "Crude.protein")]), 1, mean)]
```
See in compare_raw_function_to_synthesis for yearly calculation!

# Nshoot and Pshoot
same dataset like forage.quality
```{r}
nutrients <- list_raw_functions$nutrients
#TODO : there is something wrong with Biomass 2009. --> see there

# multiply with biomass!
# nutrients <- list_raw_functions$nutrients
# d09 <- merge(Biomass2009, nutrients, by="Plot", all=T)
# d09[, Nshoot.2009 := Biomass2009 * (Nshoot2009percent / 100)]
# bal <- merge(d09, synthesis[,c("Plot", "Nshoot.2009")])
# # maximum deviation of 6
# max(bal$Nshoot.2009.x - bal$Nshoot.2009.y, na.rm=T)
# # the larger the total values, the larger the deviation. Could be acceptable?
# plot(bal$Nshoot.2009.x, bal$Nshoot.2009.x - bal$Nshoot.2009.y)


# 2010

assemblednutrients <- merge(raw_functions[,c("Plot", "Biomass2010")], nutrients, by="Plot", all=T)
assemblednutrients[, Nshoot.2010 := Biomass2010 * (Nshoot2010percent / 100)]
assemblednutrients[, Pshoot.2010 := Biomass2010 * (Pshoot2010percent / 100)]
# add to raw_functions
raw_functions <- merge(raw_functions, assemblednutrients[,c("Plot", "Nshoot.2010", "Pshoot.2010")], by="Plot")


# 2011
assemblednutrients <- merge(raw_functions[,c("Plot", "Biomass2011")], nutrients, by="Plot", all=T)
assemblednutrients[, Nshoot.2011 := Biomass2011 * (Nshoot2011percent / 100)]
assemblednutrients[, Pshoot.2011 := Biomass2011 * (Pshoot2011percent / 100)]
# add to raw_functions
raw_functions <- merge(raw_functions, assemblednutrients[,c("Plot", "Nshoot.2011", "Pshoot.2011")], by="Plot")

# 2012
assemblednutrients <- merge(raw_functions[,c("Plot", "Biomass2012")], nutrients, by="Plot", all=T)
assemblednutrients[, Nshoot.2012 := Biomass2012 * (Nshoot2012percent / 100)]
assemblednutrients[, Pshoot.2012 := Biomass2012 * (Pshoot2012percent / 100)]
raw_functions <- merge(raw_functions, assemblednutrients[,c("Plot", "Nshoot.2012", "Pshoot.2012")], by = "Plot", all = T)

# 2013
assemblednutrients <- merge(raw_functions[,c("Plot", "Biomass2013")], nutrients, by="Plot", all=T)
assemblednutrients[, Nshoot.2013 := Biomass2013 * (Nshoot2013percent / 100)]
assemblednutrients[, Pshoot.2013 := Biomass2013 * (Pshoot2013percent / 100)]
raw_functions <- merge(raw_functions, assemblednutrients[,c("Plot", "Nshoot.2013", "Pshoot.2013")], by = "Plot", all = T)

```


# Herbivory
## 2013
invertebrate herbivory in 146 managed temperate grasslands. Year: 2013

increased land-use - less invertebrates - less herbivory

Visually estimation of herbivory by eye using templates and measurement of leaf area left after feeding of the herbivores using LI-COR area meter

2 samples per plot in 145 cases, 1 sample for :  "AEG6"  "HEG16" "HEG43" "SEG19" "SEG33" and 3 samples for "SEG45". 2 Columns are included in the raw_functions dataset, 1 for each sample.

SEG45 : The mean of all 3 samples was already taken and stored as sample2. Taking the mean of samples2 first and then with sample1 would lead to different results than in the synthesis dataset.
```{r}
Herbivory.2013 <- list_raw_functions$Herbivory.2013

Herbivory.2013 <- aggregate(PercHerbivory~EP_Plotid, Herbivory.2013, mean)
data.table::setnames(Herbivory.2013, old=c("EP_Plotid", "PercHerbivory"), new=c("Plot", "herbivory.2013"))
raw_functions <- merge(raw_functions, Herbivory.2013, by="Plot", all.x=T)
```

# Litter.decomposition
litter bag approach, Mass loss in the litter bags, after two months, and four months. 1.5g of dry plant material. January 2013 put 10 bags each, 2 months later retrieval of 5 bags, 2 more months : retrieval of other 5 bags. calculated daily decomposition rates.
```{r}
Litter.decomposition <- list_raw_functions$Litter.decomposition
# take the mean daily decomposition rate over all measures, the ones with 2 months and the ones with 4 months decomposition.
Litter.decomposition <- aggregate(DailyDecompositionRate~EPPlotID,Litter.decomposition,mean)
data.table::setnames(Litter.decomposition, old=c("EPPlotID", "DailyDecompositionRate"), new=c("Plot", "Litter.decomposition"))
raw_functions <- merge(raw_functions, Litter.decomposition, by="Plot", all.x = T)
```


# Parasitoid traps
If there are more parasitoid wasps, they predate caterpillars which eat the plants.

In spring 2008, a total of 95 grassland plots were selected in Hainich-Dün, Schorfheide-Chorin and Schwäbische Alb. After collecting the traps at the end of September, nests of trap-nesting bees, wasps and their natural enemies were collected and recorded. The experimental grassland plots were chosen according to their different land use types and their distance from each other.

Cat : Replace by a better measure (caterpillars predation not found in bexis)

3 datasets (13350, 13347, 13349) for 3 regions: 34 from AEG, 28 from HEG and 34 from SEG - 96 plots measured

recorded total broodcell number : Total_BC_No
```{r}
# get dataset from raw functions list
pt <- list_raw_functions$Parasitoid.traps
pt <- pt[Function == "Parasitoid", c("PlotID", "Total_BC_No")]
pt <- aggregate(Total_BC_No~PlotID, pt, sum)
data.table::setnames(pt, old=c("PlotID", "Total_BC_No"), new=c("Plot", "Parasitoid.traps"))
# append to raw functions list
raw_functions <- merge(raw_functions, pt, by="Plot", all.x = T)
```

# Total pollinators
Plot number AEG24 has 939 total pollinators in synthesis dataset, but only 339 total pollinators in the downloaded dataset. All other numbers are perfectly identical.

The number from the downloaded dataset is taken, but the change is recorded.
```{r}
Total.pollinators <- list_raw_functions$Total.pollinators
Total.pollinators <- aggregate(Total.pollinators~Plot, Total.pollinators, sum)
raw_functions <- merge(raw_functions, Total.pollinators, by="Plot", all=T)
```



# PRI
from synthesis .html : 

Phosphorus retention (PRI): Pmic (15766; microbial phosphorus in soil), PlantP.conc (18869; only 2009 data on P concentrations used and multiplied with biomass to give shoot.P.stock) and NaHCO3_Pi (5241) [PRI = (shoot.P.stock + Pmic)/(NaHCO3_Pi + Pmic + shoot.P.stock)]
```{r}
#TODO calculate phoshporous retention index for 2014, and if possible 2011
```

# pathogen infection
mean_prevalence : mean disease prevalence on plot averaged across all pathogens. The percentage of plants with visible infection symptoms.

mean_severity : mean disease severity on plot averaged across all pathogens. The percentage of aboveground plant surface affected by pathogen

**pathogen data :**
% infizierte pflanzen auf plot
% pflanzenoberfläche betroffen auf plot

**plant cover data :** % species cover in a 4x4 m plot
* total cover per plot is not 100, because plants can grow on top of each other. 
* normalisation because plant cover is estimated by different people

calculate total area infected by pathogens per plot: 
* total foliar pathogen infection (% plants infected x mean % infection per plant x %cover of plant)

```{r, eval=F}
pathogen.infection <- list_raw_functions[["pathogen.infection"]]
pathogen.infection2 <- list_raw_functions[["pathogen.infection2"]]

# calculate plant cover
pathogen.infection2 <- data.table::as.data.table(aggregate(Cover~Plot, pathogen.infection2, sum))
# normalisation across plots
pathogen.infection2[,"normCover" := Cover / sum(Cover, na.rm=T)]

# merge datasets
pathogen.infection <- merge(pathogen.infection, pathogen.infection2, by = "Plot", all = T)

# calculate total foliar pathogen infection
pathogen.infection[, "pathogen.infection" := normCover * (mean_prevalence/ 100) * (mean_severity/ 100)]

# comparison to synthesis
d <- merge(pathogen.infection, synthesis[, c("Plot", "pathogen.infection")])
plot(d$pathogen.infection.x, d$pathogen.infection.y)
# problem with plto AEG4 : mean prevalence is 83.8 and mean severity is 43.4 - extremely high values !
d[Plot == "AEG4", "pathogen.infection.x"] <- 0
d[Plot == "AEG4", "pathogen.infection.y"] <- 0
# not correlated neither
# new approach: normalise fungi data
pathogen.infection[, "normm_prevalence" := mean_prevalence / sum(mean_prevalence, na.rm=T)]
pathogen.infection[, "normm_severity" := mean_severity / sum(mean_severity, na.rm=T)]
pathogen.infection[, "pathogen.infection" := normCover * normm_prevalence * normm_severity]
d <- merge(pathogen.infection, synthesis[, c("Plot", "pathogen.infection")])
plot(d$pathogen.infection.x, d$pathogen.infection.y, xlim = c(0, 4e-06))
# still not correlated

# TODO : not correlated with synthesis dataset! there must be an error somewhere... 
# or can it be because debi cleaned the plant cover data? 
```



# store assembled dataset
store as .csv document
```{r}
cat("Dear user, \n
    Please enter a prefix (=piece of the name which is printed in front of a file).\n
    It will be used for the assembled functions dataset.\n
    The dataset will be printed on your Desktop with the prefix you have given together with the following suffix :\n
    '_raw_functions_dataset.csv' \n
    example : 'december2018' would give 'december2018__raw_functions_dataset.csv'")
prefix <- readline(prompt="Write now : ")
write.csv(raw_functions, file=paste("~/Desktop/", prefix, "_raw_functions_dataset.csv", sep=""))
```
