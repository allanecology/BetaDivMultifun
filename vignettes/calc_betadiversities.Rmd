---
title: "From Diversity to Betadiversity"
author: "Noelle Schenk, Caterina Penone"
date: "May 7, 2019"
output: html_document
---
*requires* : 
- datasets : spdiv, spinfo (spinfo is the file containing information about all species, spdiv is the collected data.)
- plotNAset (the names of plots which are included)

# Load and merge dataset
Note : this script is based on the Exploratoreis diversity dataset, which is read in with the script `analysis_nonpublic.R`. It reads in the two datasets `spdiv` and `spinfo`.

## Dataset Cleaning
From cleaning, getting numbers : 
- 202944 species in the dataset
- 20 different trophic levels
- type = presenceabsence : plant pathogen, ant omnivore

```{r}
# delete Plot_bexis (old plot names)
spdiv[, Plot_bexis := NULL]
# spdiv[, c("Dataversion", "DataID") := NULL]
spdiv <- merge(spdiv, spinfo, by = "Species", all.x=T)
# this analysis was done before all missing plot x year combinations were set to NA.
# they are therefore removed here.
spdiv <- spdiv[!is.na(value)]

# now I can remove the original datasets, so I save cpu:
rm(spinfo); gc()
```
Set to presence-absence
```{r}
spdiv[value != 0, value := 1]
```


# Select trophic levels
Group to 18 trophic levels as needed for analysis. (see also `info_diversity.ods`)
```{r}
# take out trophic levels which are not used in analysis
spdiv <- spdiv[!Trophic_level %in% c("detritivore", "protist.unknown", "soilfungi.other", "vert.herb", "protist.parasite.nonplant")]
# merge the trophic levels which are merged in analysis
spdiv[Trophic_level == "herbivore.snail", Trophic_level := "herbivore"]
spdiv[Trophic_level == "ant.omnivore", Trophic_level := "omnivore"]
spdiv[Trophic_level == "omnivore.snail", Trophic_level := "omnivore"]
spdiv[Trophic_level == "protist.mainly.bacterivore", Trophic_level := "protist.bacterivore"]
# unique(spdiv$Trophic_level)
```
show years
```{r, eval=F}
unique(spdiv[, .(Trophic_level, Year)])
```

```{r, eval=F}
length(unique(spdiv$Species)) # 202944 species in the dataset (incl. OTU)
```
Get overview of amount of species per trophic level
```{r, eval=F}
for(t in unique(spdiv$Trophic_level)){
  print(c(t, length(unique(spdiv[Trophic_level == t, Species]))))
}
```
Store trophic levels in vector
```{r}
trlevels <- sort(unique(spdiv$Trophic_level))
#TODO decide if with tertiary consumers or without
# trlevels <- trlevels[!trlevels %in% c("pollinator", "tertiary.consumer", "decomposer", "myriapod.decomposer")]
trlevels <- trlevels[!trlevels %in% c("pollinator", "decomposer", "myriapod.decomposer")]
```



# Check if diversity across years is correlated
Create new column with trophic level and year
```{r, eval=F}
spdiv[, trlevel_year := paste(Trophic_level, Year, sep = "")]
```
Correlation plot of all trophic levels and years? Or better betadiversity among years?
```{r, eval=F}
# m <- cor(spdiv[, .(Species, value, trlevel_year)], use = "pariwise.complete.obs")
# 
# M <- cor(small_grlfuns[, !colnames(grlfuns) %in% c("Explo","Plotn", "Plot"), with=F], use="pairwise.complete.obs")
# corrplot::corrplot(M,type="lower",addCoef.col = "black",method="color",diag=F, tl.srt=1, tl.col="black", mar=c(1,0,1,0), number.cex=0.6)

# testing with 1 trophic level, 2 years
# for presence absence
for(trlevel in c("autotroph", "secondary.consumer", "tertiary.consumer")){
  pdf(paste("corr_diversity_across_years_", trlevel, ".pdf", sep=""), paper = "a4r")
  par(mfrow=c(12,12))
  test <- spdiv[Trophic_level == trlevel, .(Species, value, trlevel_year, Plot, Year)]
  for(p in unique(test$Plot)){
    a <- data.table::dcast.data.table(test[Plot == p], Year ~ Species, fill = 0)
    a[is.na(a)] <- 0
    a <- t(a)
    colnames(a) <- a[1,]
    a <- a[-1,]
    a <- apply(a, 2, as.numeric)
    # corrplot::corrplot(cor(a), type="lower", diag = F)
    a[a != 0] <- 1
    if(sum(is.na(cor(a))) >= 1) next
    corrplot::corrplot(cor(a), type="lower", diag = T, method = "square", tl.col = "black", order = "alphabet", tl.cex = 0.7, main = p)
  }
  dev.off()
}
# note : not possible OTU, because it can't be compared across years. The OTU identities always change.
# note : omnivore, herbivores different years are different species --> no overlap

# tertiary consumers : special case. take the 67 species measured in 2008, 2011 and 2012 and take the 11 suppl. species out of years 2009 and 2010.
tert <- spdiv[Trophic_level == "tertiary.consumer", .(Species, value, trlevel_year, Plot, Year)]
# find the 11 species which are only present in 2009 and 2010
unique(tert[Year == "2009", Species])[which(!unique(tert[Year == "2009", Species]) %in% unique(tert[Year == "2008", Species]))]
```



# Combine years

## autotrophs
Years 2008 to 2016.
Lichens and Bryophytes only 2009 (119 species, 137 plots)

year   |  no. species | no. Plots |
-------| ------------ | --------- |
2008   |   342        |  147      |
2009   |   485        |  150      |
2009 l |   119        |  150      |
2009 p |   342        |  150      |
2010   |   342        |  150      |
2011   |   342        |  150      |
2012   |   342        |  149      |
2013   |   342        |  149      |
2014   |   342        |  148      |
2015   |   342        |  150      |
2016   |   342        |  150      |

```{r}
autotroph <- spdiv[Trophic_level == "autotroph"]
autotroph <- autotroph[Year %in% c("2009", "2008", "2010", "2011", "2012", "2013", "2014", "2015", "2016")]
autotrophnew <- spdiv[Trophic_level == "autotroph" & Year %in% c("2017", "2018")]
# find the species in autotroph which are never present in the years I include
test <- data.table::data.table(aggregate(value ~ Species, autotroph, sum))
exclude <- test[value == 0, Species]
# test2 <- data.table(aggregate(value ~ Species, autotrophnew, sum))
# notexclude <- test2[value == 0, Species]
# exclude them from the analysis
autotroph <- autotroph[!Species %in% exclude]

# how many species and how many plots were measured in the different years?
length(unique(autotroph[Year == "2008", Plot])) # Changed year and tested for all years for reporting in the table
# get vector with lichen species to examine lichens separately
lichenspecies <- setdiff(unique(autotroph[Year == "2009", Species]), unique(autotroph[Year == "2008", Species]))
    # examine lichens and plants separately - same number of plots and expected number of species?
length(unique(autotroph[!Species %in% lichenspecies, Species]))
length(unique(autotroph[!Species %in% lichenspecies, Plot]))
```
*Plots identities*
```{r, eval=F}
# are the same plots missing in all years?
testplotpresence <- unique(autotroph[, .(Year, Plot)])
vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
# no, different plots are missing.
rm(testplotpresence)
```

```{r, eval = T}
# are the same plots missing in all years?
testplotpresence <- unique(autotroph[Plot %in% plotNAset, .(Year, Plot)])
visdat::vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
# no, different plots are missing.
rm(testplotpresence)
```
If a plant species is present in at least 1 year, it is considered to be present. Underlying assumption : plant species composition is quite stable, therefore it is representative to assess their presence in a large time span.

If a plant species is missing in a year, rather the year than the plot is removed. Underlying assumption : if a plot is missing a year, the diversity was not measured as many times as in the other plots.

Years 2009, 2010, 2011, 2015, 2016 are complete.

Assessing presence of plant species in all years. Lichen and Bryophyte species are taken directly from year 2009, as this is the only year.
```{r}
autotroph <- autotroph[Year %in% c("2009", "2010", "2011", "2015", "2016")]
plants <- autotroph[!Species %in% lichenspecies, ]
lichens <- autotroph[Species %in% lichenspecies,]
# if a species is present in at least one year, it is considered to be present
# calculate the mean of all value (species presence/ absence). If it is not zero, the species was present in at least one year and the value can be set to 1.
plants <- aggregate(value ~ Species + Plot, plants, function(x) mean(x, na.rm=T))
plants <- data.table::data.table(plants)
# nrow(plants) == 344*150 # TRUE : there are 344 species per plot in the new dataset
# Check how many plant species have been present / absent in how many years
hist(plants$value, main="Presence of plant species among years", sub="The plot indicates if a plant species was either present in no year, \n in 1 years , ... , in all 9 years. Most species are never present", xlab = "")

# set the numbers which are not 0 or 1 to 1 (if value > 0, that means that plant has been present at least in one year)
plants[value != 0, value := 1]

# add the lichens dataset to the plants dataset
autotroph <- rbind(plants, lichens[, .(Species, Plot, value)])
nrow(autotroph) == 150 * 344 + 150 * 119 # TRUE : there are 119 lichen and 344 plant species in all 150 plots.
```

```{r}
hist(autotroph$value)
hist(lichens$value)
hist(plants$value)
```
Although working with a range of 5 years, still many plant species are not present in many plots. This indicates that the assumption of stable autotroph species was correct.

```{r}
# remove lichens and plants, not used any more
rm(plants) ; rm(lichens); rm(lichenspecies)
# take out autotrophs from spdiv
spdiv <- spdiv[!Trophic_level == "autotroph"]
```


## herbivore
```{r}
herbivore <- spdiv[Trophic_level == "herbivore"]
```
Note : the code below can be deleted as soon as the new diversity dataset is available.
```{r}
# Arthropod herbivores consist of 3 Groups, 2 of them contain missing data, one not.
# We can only take the plots present in all groups --> reduce the number of plots
unique(herbivore[Year == "2008", Group_fine])
length(unique(herbivore[Year == "2008" & Group_fine == "Hymenoptera", Plot]))
```
| Dataset  | Hemiptera | Coleoptera  | Hymenoptera | Orthoptera |
| -------- | --------- |------------ |------------ |----------- |
| no Plots |  139      |     139     |  **150**    |  139       |
```{r}
herbivore_plotset <- unique(herbivore[Year == "2008" & Group_fine == "Orthoptera", Plot])
# check if the plot set is consistent
sum(herbivore_plotset != unique(herbivore[Year == "2008" & Group_fine == "Hemiptera", Plot])) # all the same
sum(herbivore_plotset != unique(herbivore[Year == "2008" & Group_fine == "Coleoptera", Plot])) # all the same

# select the plot set for herbivores
# select all rows which are EITHER from 2008 (arthropods) and from the selected plot list, OR they are from 2017
# species from 2017 don't have to be part of the selected plots
herbivore <- herbivore[Plot %in% herbivore_plotset & Year == "2008" | Year == "2017", ]
rm(herbivore_plotset)
```


```{r}
testplotpresence <- unique(herbivore[, .(Year, Plot)])
visdat::vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
rm(testplotpresence)
```
Snails were only measured in 134 plots. They contain 39 species. Insects were measured in 139 plots, they contain 401 species.
```{r, eval = F}
testplotpresence <- unique(herbivore[Plot %in% plotNAset, .(Year, Plot)])
visdat::vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
rm(testplotpresence)
```

```{r, eval=F}
length(unique(herbivore[Year == "2008", Species]))
length(intersect(herbivore[Year == "2008", Plot], herbivore[Year == "2017", Plot]))
```

| Year       |  2008    |  2017   | both   |
| Group      | insects  | snails  | both   |
| ---------- | -------- | ------- | ------ |
| no Plots   |   139    |  134    |  124   |
| no Species |   401    |   39    |  440   |

Too many missing plots in snails dataset. Take insects dataset only.
```{r}
herbivore <- herbivore[Year == "2008", .(Species, Plot, value)]
nrow(herbivore) == 139 * 401 # 401 species in 139 plots present
# remove from spdiv
spdiv <- spdiv[!Trophic_level == "herbivore"]
```



## Omnivore REMOVED
Consists of arthropods dataset from 2008, ants dataset from 2014_2015, and snails dataset from 2017.
```{r, eval = F}
omnivore <- spdiv[Trophic_level == "omnivore"]
testplotpresence <- unique(omnivore[, .(Year, Plot)])
# testplotpresence <- unique(omnivore[Plot %in% plotNAset, .(Year, Plot)])
vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
rm(testplotpresence)
```
Many plots are missing.

subset     |  arthropods  | ants   | snails  |  all  |  arth&sn  | 
---------- | ------------ | ------ | ------- | ----- | --------- |
Year       |    2008      | 14 15  |  2017   | all   | 08 & 17   |
no Plots   |     139      |  110   |  134    |  97   |  124      |
no Species |     14       |  20    |  21     |  55   |  35       |

```{r, eval = F}
# length(intersect(omnivore[Year == "2008", Plot], omnivore[Year == "2017", Plot]))
# length(intersect(intersect(omnivore[Year == "2008", Plot], omnivore[Year == "2017", Plot]), omnivore[Year == "2014_2015", Plot]))
```
Only took the arthropod dataset, as snails and ants have too many missing plots.
```{r, eval = F}
omnivore <- omnivore[Year == "2008", .(Species, Plot, value)]
# omnivore_ant <- omnivore[Year == "2014_2015", .(Species, Plot, value)]
# omnivore_snail <- omnivore[Year == "2017", .(Species, Plot, value)]
nrow(omnivore) == 139 * 14 # expected number of rows present
spdiv <- spdiv[!Trophic_level == "omnivore"]
# many plots do not contain any species - take out
test <- aggregate(value ~ Plot, omnivore, sum)
barplot(height = test$value)
abline(h = mean(test$value), col = "red")
abline(h = median(test$value), col = "green")

print(test$Plot[which(test$value == 0)])
#take out for the moment
trlevels <- trlevels[-which(trlevels == "omnivore")]
rm(omnivore)
```
```{r}
trlevels <- trlevels[-which(trlevels == "omnivore")]
```


## Secondary consumers
arthropods (?) and myriapods
2008 dataset

update : 2011 dataset is not included any more
```{r}
secondary.consumer <- spdiv[Trophic_level == "secondary.consumer"]
myria.sc <- spdiv[Trophic_level == "myriapod.secondary.consumer"]
myria.sc <- myria.sc[Plot %in% secondary.consumer$Plot]
trlevels <- trlevels[!trlevels == "myriapod.secondary.consumer"]

testplotpresence <- unique(secondary.consumer[, .(Year, Plot)])
# testplotpresence <- unique(secondary.consumer[Plot %in% plotNAset, .(Year, Plot)])
visdat::vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
rm(testplotpresence)
```
Only 2008 dataset has some missing values

  Year     | 2008  | 2011 | myriapods |
---------- | ----- | ---- | --------- |
no Plots   | 139   | 150* |    150    |
no Species | 170   |   4  |      4    |

Species set does not overlap.

**Note** : possibly, set from 2011 was not complete neither? But if the same error as in all insect datasets --> selecting plots from 2008 will solve the issue. In case 2011 Data is used, check this!

```{r, eval=F}
# length(unique(secondary.consumer[Year == "2008", Species]))
any(unique(secondary.consumer[Year == "2008", Species]) %in% unique(secondary.consumer[Year == "2011", Species]))
```

Select the Plot set from 2008 and merge the datasets together.
```{r}
secondary.consumer <- secondary.consumer[Plot %in% unique(unique(secondary.consumer[Year == "2008", Plot])), .(Species, Plot, value)]
secondary.consumer <- rbind(myria.sc[, .(Species, Plot, value)], secondary.consumer)
nrow(secondary.consumer) == 139 * 174  # expected number of rows present
spdiv <- spdiv[!Trophic_level == "secondary.consumer"]
```


## Tertiary consumer REMOVED
```{r, eval = F}
#HERE
tertiary.consumer <- spdiv[Trophic_level == "tertiary.consumer"]
testplotpresence <- unique(tertiary.consumer[, .(Year, Plot)])
visdat::vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
rm(testplotpresence)
```

   Year    | 2008   |    2009    |    2010    |   2011  |   2012   |
---------- | ------ | ---------- | ---------- | ------- | -------- |
subset     | birds  | birds bats | birds bats |  birds  |  birds   |
no Plot    |  150   |  150+149   |  150+150   |  150    |  150     |
no Species |  67    | 78= 67+11  | 78= 67+11  |  67     |  67      |

```{r, eval = F}
# unique(tertiary.consumer[Year == "2012", Group_fine])
# length(unique(tertiary.consumer[Year == "2012", Plot]))

# length(intersect(unique(tertiary.consumer[Year == "2009", Species]), unique(tertiary.consumer[Year == "2010", Species])))
batspecies <- setdiff(unique(tertiary.consumer[Year == "2009", Species]), unique(tertiary.consumer[Year == "2011", Species]))
```
The Bird and Bat species of the different years are the same.

Take average of Species occurrence and check how often species occur. We assume that birds and bats are difficult to measure, therefore having a large time window makes sense. A species is considered to be present in a plot, if it is present at least in one year.
```{r, eval = F}
#TODO if only birds, don't run bat lines and assing tertiary.consumer to "bird"
birds <- aggregate(value ~ Species + Plot, tertiary.consumer[Group_fine == "Birds"], function(x) mean(x, na.rm=T))
birds <- data.table::data.table(birds)
# nrow(birds) == 67 * 150 # TRUE : 67 species in 150 plots
hist(birds$value, main="Presence of bird species among years")
# If species is present at least in one year, take it as present
birds[value > 0, value := 1]
nrow(birds) == 67 * 150 # expected number of rows present (67 species in 150 plots)

bats <- aggregate(value ~ Species + Plot, tertiary.consumer[Group_fine == "Bats" & Species %in% batspecies], function(x) mean(x, na.rm=T))
bats <- data.table::data.table(bats)
# nrow(bats) == 11 * 150
hist(bats$value)
# If species is present at least in one year, take it as present
bats[value > 0, value := 1]
nrow(bats) == 11 * 150 # expected number of rows present (11 species in 150 plots)

# combine the bird and bat dataset
tertiary.consumer <- rbind(birds, bats)

nrow(tertiary.consumer) == 150 * (11 + 67)
rm(bats); rm(birds); rm(batspecies)
```
```{r}
spdiv <- spdiv[!Trophic_level == "tertiary.consumer"]
```


## Bacteria RNA

```{r}
bacteria.RNA <- spdiv[Trophic_level == "bacteria.RNA"]
testplotpresence <- unique(bacteria.RNA[, .(Year, Plot)])
visdat::vis_miss(data.table::dcast(testplotpresence, Plot ~ Year))
rm(testplotpresence)
```
Not visible in the plot, but there are only 148 plots for both years.

Check if OTU names are the same in both years. No obvious overlap.
```{r, eval=F}
length(setdiff(unique(bacteria.RNA[Year == "2014", Species]), unique(bacteria.RNA[Year == "2011", Species])))
# length(unique(bacteria.RNA$Species))
# The OTU names prefix is either bac11 or bac14 ...
# grep("01ece679a6294aadf97b931ce39a539a", bacteria.RNA$Species)
bacteria.RNA[grep("01ece679a6294aadf97b931ce39a539a", bacteria.RNA$Species), Year]
```
The OTUs can be compared across the years. However, we will only work with the 2011 dataset in order to be more consistent with the years.
Replace the prefix by bac_ instead of bac11_ and bac14_
```{r, eval=F}
# In case the years would be combined
bacteria.RNA[grep("bac11_", Species), Species := gsub("bac11_", "bac14_", Species)]
```

|    year    |  2011   |  2014     |  
| ---------- | ------- | --------- | 
| no Plots   |   148   |   148     |
| no OTUs    |  140510 |  139691   |

```{r, eval=F}
length(unique(bacteria.RNA[Year == "2014", Species])) # 139691
length(setdiff(unique(bacteria.RNA[Year == "2011", Species]), unique(bacteria.RNA[Year == "2014", Species]))) # 34435 # 35254
length(intersect(unique(bacteria.RNA[Year == "2011", Species]), unique(bacteria.RNA[Year == "2014", Species]))) # 105256
```
2014 : 34435 OTUs unique to 2014, 105256 overlapping of total 139691. ~ 1/4 to 3/4
2011 : 35254 OTUs unique to 2011, 105256 overlapping of total 140510. ~ 1/4 to 3/4
```{r}
grid::grid.newpage()
VennDiagram::draw.pairwise.venn(area1 = 34435 + 105256, area2 = 35254 + 105256, cross.area = 105256, category = c("2011 OTU", "2014 OTU"))
```
Select 2011 dataset.
```{r}
bacteria.RNA <- bacteria.RNA[Year == "2011", .(Species, Plot, value)]
# The bacteria RNA dataset had been reduced: all species-plot combinations with 0 were removed.
# reconstruct them (code from Caterina)
bacteria.RNA <- data.table::setDT(bacteria.RNA)[data.table::CJ(Species=Species,Plot=Plot,unique=T), on=.(Species, Plot)]
bacteria.RNA[is.na(value), value := 0 ]
# # add NA values for the two missing plots
# bac_missing <- rbind(data.table::data.table(Species = unique(bacteria.RNA[Plot == "AEG21", Species]), Plot = "AEG33", value = NA),
#                      data.table::data.table(Species = unique(bacteria.RNA[Plot == "AEG21", Species]), Plot = "AEG34", value = NA))
nrow(bacteria.RNA) == 148 * 140510 # expected number of plots present
spdiv <- spdiv[!Trophic_level == "bacteria.RNA"]
```


## protist.bacterivore
2011, 2011_2012, 2017 datasets
```{r}
protist.bacterivore <- spdiv[Trophic_level == "protist.bacterivore"]
testplotpresence <- unique(protist.bacterivore[, .(Year, Plot)])
visdat::vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
rm(testplotpresence)
```
Only 1 plot missing, in 2011

Are the OTU the same across years?
Datasets 2011 and 2017 are comparable with each others, but not with dataset 2011_2012. The name appendices for the latter need to be preserved, the other prefixes can be removed.
```{r, eval=F}
protist.bacterivore[grep("_protist24426", Species), Species := gsub("_protist24426", "", Species)] # remove appendix from 2011
protist.bacterivore[grep("_protist24466", Species), Species := gsub("_protist24466", "", Species)] # remove appendix from 2017

length(setdiff(unique(protist.bacterivore[Year == "2011", Species]), unique(protist.bacterivore[Year == "2011_2012", Species])))
length(intersect(unique(protist.bacterivore[Year == "2017", Species]), unique(protist.bacterivore[Year == "2011_2012", Species])))
# length(unique(protist.bacterivore[Year == "2011", Species]))
# length(unique(protist.bacterivore[Year == "2011_2012", Species]))
```

|    year    | 2011    | 2011_2012 |  2017  | 2011 2017 | 2017 2011_2012 |
| ---------- | ------- | --------- | ------ | --------- | -------------- |
| no Plots   |   149   |   150     |   150  |    149    |     149        |
| no OTUs    |   886   |   233     |   863  | 833+23+30 |       0        |

No overlap between 2011 and 2011_2012 and 2017 and 2011_2012. 

For BetaDivMultifun, only year 2011 is chosen : 
```{r}
protist.bacterivore <- protist.bacterivore[Year == "2011", .(Species, Plot, value)]
nrow(protist.bacterivore) == 149 * 886 # TRUE : The expected number of rows is present.
spdiv <- spdiv[!Trophic_level == "protist.bacterivore"]
```



## protist.eukaryvore
```{r}
protist.eukaryvore <- spdiv[Trophic_level == "protist.eukaryvore"]
testplotpresence <- unique(protist.eukaryvore[, .(Year, Plot)])
vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
rm(testplotpresence)
```
Only 1 plot missing, in 2011.

```{r, eval=F}
# code for OTU renaming, in case they would like to be combined.
protist.eukaryvore[grep("_protist24426", Species), Species := gsub("_protist24426", "", Species)] # clean 2011
protist.eukaryvore[grep("_protist24466", Species), Species := gsub("_protist24466", "", Species)] # clean 2017
```

```{r, eval=F}
# interchange intersect with setdiff and modify years to obtain values in table below
length(setdiff(unique(protist.eukaryvore[Year == "2017", Species]), unique(protist.eukaryvore[Year == "2011", Species])))
length(unique(protist.eukaryvore[Year == "2011", Plot]))
```

|   Year   |   2011   |  2017  |  both    |
| -------- | -------- | ------ | -------- |
| no Plots |   149    |  150   |    149   |
| no OTUs  |   211    |  210   | 204+7+6  |

For BetaDivMultifun, only year 2011 is chosen : 
```{r}
protist.eukaryvore <- protist.eukaryvore[Year == "2011", .(Species, Plot, value)]
nrow(protist.eukaryvore) == 149 * 211 # TRUE : The expected number of rows is present.
spdiv <- spdiv[!Trophic_level == "protist.eukaryvore"]
```


## protist.omnivore

```{r}
protist.omnivore <- spdiv[Trophic_level == "protist.omnivore"]
testplotpresence <- unique(protist.omnivore[, .(Year, Plot)])
vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
rm(testplotpresence)
```
Only 1 plot missing, in 2011.

```{r, eval=F}
# code for enaming of OTUs in case years would be combined.
protist.omnivore[grep("_protist24426", Species), Species := gsub("_protist24426", "", Species)] # clean 2011
protist.omnivore[grep("_protist24466", Species), Species := gsub("_protist24466", "", Species)] # clean 2017
```

```{r, eval=F}
# interchange intersect with setdiff and modify years to obtain values in table below
length(intersect(unique(protist.omnivore[Year == "2011", Species]), unique(protist.omnivore[Year == "2017", Species])))
length(unique(protist.omnivore[Year == "2017", Species]))
```

|   Year   |   2011   |  2017  |  both    |
| -------- | -------- | ------ | -------- |
| no Plots |   149    |  150   |    149   |
| no OTUs  |   444    |  434   | 430+10+4 |

Only Year 2011 is chosen.
```{r}
protist.omnivore <- protist.omnivore[Year == "2011", .(Species, Plot, value)]
nrow(protist.omnivore) == 149 * 444 # expected number of rows is present
spdiv <- spdiv[!Trophic_level == "protist.omnivore"]
```



## protist.plant.parasite

```{r}
protist.plant.parasite <- spdiv[Trophic_level == "protist.plant.parasite"]
testplotpresence <- unique(protist.plant.parasite[, .(Year, Plot)])
vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
rm(testplotpresence)
```
Only 1 plot missing, in 2011.

```{r, eval=F}
# Code for OTU renaming, in case years would be combined.
protist.plant.parasite[grep("_protist24426", Species), Species := gsub("_protist24426", "", Species)] # clean 2011
protist.plant.parasite[grep("_protist24466", Species), Species := gsub("_protist24466", "", Species)] # clean 2017
```

```{r, eval=F}
# interchange intersect with setdiff and modify years to obtain values in table below
length(setdiff(unique(protist.plant.parasite[Year == "2017", Species]), unique(protist.plant.parasite[Year == "2011", Species])))
length(unique(protist.plant.parasite[Year == "2017", Plot]))
```

|   Year   |   2011   |  2017  |  both    |
| -------- | -------- | ------ | -------- |
| no Plots |   149    |  150   |    149   |
| no OTUs  |   96     |   95   |  95+1+0  |

Only 2011 is chosen
```{r}
protist.plant.parasite <- protist.plant.parasite[Year == "2011", .(Species, Plot, value)]
nrow(protist.plant.parasite) == 149 * 96
spdiv <- spdiv[!Trophic_level == "protist.plant.parasite"]
```


## soilfungi.decomposer
Years 2011, 2014, 2017
```{r}
soilfungi.decomposer <- spdiv[Trophic_level == "soilfungi.decomposer"]
testplotpresence <- unique(soilfungi.decomposer[, .(Year, Plot)])
vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
rm(testplotpresence)
```
Check if OTU need renaming and check overlap of OTUs
```{r, eval=F}
length(unique(soilfungi.decomposer[Year == "2017", Species]))
length(setdiff(unique(soilfungi.decomposer[Year == "2017", Species]), unique(soilfungi.decomposer[Year == "2014", Species])))

length(intersect(intersect(unique(soilfungi.decomposer[Year == "2011", Species]), unique(soilfungi.decomposer[Year == "2017", Species])), unique(soilfungi.decomposer[Year == "2014", Species])))
```

|  Year    |  2011  |  2014  |  2017  | 11 14            |     11 17      |      14 17     | all
| -------- | ------ | ------ | ------ | ---------------- | -------------- | -------------- | --------------- |
| no Plots |  150   |  150   |  150   |       150        |       150      |      150       |      150        |
| no OTUs  | 12342  | 10772  | 10971  | 9403+2939+1369   | 9368+2974+1603 | 8391+2381+2580 | 7420+(see left) |

Only year 2011 is chosen
```{r}
soilfungi.decomposer <- soilfungi.decomposer[Year == "2011", .(Species, Plot, value)]
# adding the missing plot - species combinations . all species-plot combinations with 0 had been removed to store memory
# reconstruct them (code from Caterina)
soilfungi.decomposer <- data.table::setDT(soilfungi.decomposer)[data.table::CJ(Species=Species,Plot=Plot,unique=T), on=.(Species, Plot)]
soilfungi.decomposer[is.na(value), value := 0 ]
nrow(soilfungi.decomposer) == 150 * 12342 # TRUE : now, all expected rows are present
spdiv <- spdiv[!Trophic_level == "soilfungi.decomposer"]
```


## soilfungi.pathotroph

```{r}
soilfungi.pathotroph <- spdiv[Trophic_level == "soilfungi.pathotroph"]
testplotpresence <- unique(soilfungi.pathotroph[, .(Year, Plot)])
vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
rm(testplotpresence)
```
No missing plots
```{r, eval=F}
# code to fill table below
length(unique(soilfungi.pathotroph[Year == "2017", Species]))
length(setdiff(unique(soilfungi.pathotroph[Year == "2017", Species]), unique(soilfungi.pathotroph[Year == "2011", Species])))

length(intersect(intersect(unique(soilfungi.pathotroph[Year == "2011", Species]), unique(soilfungi.pathotroph[Year == "2017", Species])), unique(soilfungi.pathotroph[Year == "2014", Species])))
```
|  Year    |  2011  |  2014  |  2017  |      11 14       |     11 17      |      14 17     | all
| -------- | ------ | ------ | ------ | ---------------- | -------------- | -------------- | --------------- |
| no Plots |  150   |  150   |  150   |       150        |       150      |      150       |      150        |
| no OTUs  |  4097  |  6313  |  2924  | 2852+1245+3461   | 2852+1245+304  | 2134+4179+790 | 1934+(see left) |

Only 2011 data is used here.
```{r}
soilfungi.pathotroph <- soilfungi.pathotroph[Year == "2011", .(Species, Plot, value)]
# all plot-species combinations with 0 had been removed to save memory. They are added back now. (code from Caterina)
soilfungi.pathotroph <- data.table::setDT(soilfungi.pathotroph)[data.table::CJ(Species=Species,Plot=Plot,unique=T), on=.(Species, Plot)]
soilfungi.pathotroph[is.na(value), value := 0 ]
nrow(soilfungi.pathotroph) == 150 * 4097 # TRUE : all expected rows present
spdiv <- spdiv[!Trophic_level == "soilfungi.pathotroph"]
```


## soilfungi.symbiont

```{r}
soilfungi.symbiont <- spdiv[Trophic_level == "soilfungi.symbiont"]
testplotpresence <- unique(soilfungi.symbiont[, .(Year, Plot)])
vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
rm(testplotpresence)
```
No missing plots
```{r, eval=F}
length(unique(soilfungi.symbiont[Year == "2017", Species]))

length(setdiff(unique(soilfungi.symbiont[Year == "2017", Species]), unique(soilfungi.symbiont[Year == "2014", Species])))

length(intersect(intersect(unique(soilfungi.symbiont[Year == "2011", Species]), unique(soilfungi.symbiont[Year == "2017", Species])), unique(soilfungi.symbiont[Year == "2014", Species])))
```
|  Year    |  2011  |  2014  |  2017  |      11 14       |     11 17      |      14 17     |    all          |
| -------- | ------ | ------ | ------ | ---------------- | -------------- | -------------- | --------------- |
| no Plots |  150   |  150   |  150   |       150        |       150      |      150       |      150        |
| no OTUs  |  1416  |  1478  |  1445  |   1093+323+385   |  1057+359+388  | 1080+398+365   |  914+(see left) |

Only 2011 is chosen.
```{r}
soilfungi.symbiont <- soilfungi.symbiont[Year == "2011", .(Species, Plot, value)]
# adding back missing plot-species combinations (code from Caterina)
soilfungi.symbiont <- data.table::setDT(soilfungi.symbiont)[data.table::CJ(Species=Species,Plot=Plot,unique=T), on=.(Species, Plot)]
soilfungi.symbiont[is.na(value), value := 0 ]
nrow(soilfungi.symbiont) == 150 * 1416 # all expected combinations present
spdiv <- spdiv[!Trophic_level == "soilfungi.symbiont"]
```


# check and select trophic levels with only one year

## belowground herbivore

```{r}
belowground.herbivore <- spdiv[Trophic_level == "belowground.herbivore", .(Species, Plot, value)]
spdiv <- spdiv[!Trophic_level == "belowground.herbivore"]
# testplotpresence <- unique(belowground.herbivore[, .(Year, Plot)])
# vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
# rm(testplotpresence)
nrow(belowground.herbivore) == 150 * 11 # expected number of rows present
```
All plots are present, only one year (simple situation - no plot is shown).
```{r, eval=F}
hist(belowground.herbivore$value, main="Presence of belowground herbivores, 11 species", sub="The plot indicates that most species - Plot combinations are not present. This is a first indicator for relatively high (acceptable high) beta-diversity.", xlab = "")
```
```{r}
bh_overv <- aggregate(value ~ Plot, belowground.herbivore, sum)
barplot(height = bh_overv$value)
abline(h = mean(bh_overv$value), col = "red")
abline(h = median(bh_overv$value), col = "green")
```
Most plots contain 3 species. 5 Plots do not contain ANY species! Need to be removed from the dataset.
```{r}
# exclude plots with zero species
# Problem : betadiversity can't be calculated on plots without species.
zeroplots <- bh_overv$Plot[which(bh_overv$value == 0)]
belowground.herbivore <- belowground.herbivore[!Plot %in% zeroplots]
rm(zeroplots) ; rm(bh_overv)
```

Calculate betadiversity to check wether plots differ in their species composition / turnover.
```{r}
beta.belowground.herbivore <- prepare_for_betapair(belowground.herbivore)
beta.belowground.herbivore <- betapart::beta.pair(beta.belowground.herbivore, index.family = "sorensen")

corrplot::corrplot(as.matrix(beta.belowground.herbivore$beta.sor),type="lower", method="color", diag=F, mar=c(1,0,1,0), number.cex=0.4, tl.srt = 45, tl.col = "black", tl.cex = 0.5)

corrplot::corrplot(as.matrix(beta.belowground.herbivore$beta.sim),type="lower", method="color", diag=F, mar=c(1,0,1,0), number.cex=0.4, tl.srt = 45, tl.col = "black", tl.cex = 0.5)

corrplot::corrplot(as.matrix(beta.belowground.herbivore$beta.sne),type="lower", method="color", diag=F, mar=c(1,0,1,0), number.cex=0.4, tl.srt = 45, tl.col = "black", tl.cex = 0.5)
```
There is definitely some betadiversity among the plots.
```{r}
nrow(belowground.herbivore) == 145 * 11 # expected number of plots present
# cleaning
rm(beta.belowground.herbivore)
```


## belowground predator

```{r}
belowground.predator <- spdiv[Trophic_level == "belowground.predator"]
nrow(belowground.predator) == 17 * 150 # expected number of plots present
```
```{r}
bp_overv <- aggregate(value ~ Plot, belowground.predator, sum)
barplot(height = bp_overv$value)
abline(h = mean(bp_overv$value), col = "red")
abline(h = median(bp_overv$value), col = "green")
```
There is 1 plot in belowground predators which does not contain any species.
```{r}
# take out plot without species
zeroplots <- bp_overv$Plot[which(bp_overv$value == 0)]
belowground.predator <- belowground.predator[!Plot %in% zeroplots]
rm(zeroplots); rm(bp_overv)
spdiv <- spdiv[!Trophic_level == "belowground.predator"]
```
calc betadiversity and plot
```{r}
beta.belowground.predator <- prepare_for_betapair(belowground.predator)
beta.belowground.predator <- betapart::beta.pair(beta.belowground.predator, index.family = "sorensen")

corrplot::corrplot(as.matrix(beta.belowground.predator$beta.sor),type="lower", method="color", diag=F, mar=c(1,0,1,0), number.cex=0.4, tl.srt = 45, tl.col = "black", tl.cex = 0.5)

corrplot::corrplot(as.matrix(beta.belowground.predator$beta.sim),type="lower", method="color", diag=F, mar=c(1,0,1,0), number.cex=0.4, tl.srt = 45, tl.col = "black", tl.cex = 0.5)

corrplot::corrplot(as.matrix(beta.belowground.predator$beta.sne),type="lower", method="color", diag=F, mar=c(1,0,1,0), number.cex=0.4, tl.srt = 45, tl.col = "black", tl.cex = 0.5)
```
```{r}
nrow(belowground.predator) == 149 * 17 # expected number of rows present
# cleaning
rm(beta.belowground.predator)
```


## decomposer TAKEN OUT
```{r, eval = F}
decomposer <- spdiv[Trophic_level == "decomposer", .(Species, Plot, value)]
mdecomposer <- spdiv[Trophic_level == "myriapod.decomposer", .(Species, Plot, value)]
# update trlevels
trlevels <- trlevels[!trlevels == "myriapod.decomposer"]
# length(unique(mdecomposer$Plot))

# merge decomposer and mdecomposers, but only the plots present in arthropods
mdecomposer <- mdecomposer[Plot %in% decomposer$Plot]
decomposer <- rbind(decomposer, mdecomposer)
```
|   type   | arthropods | myriapods |
| -------- | ---------- | --------- |
| #species |     40     |      6    |
| #Plots   |    139     |    150    |

```{r, eval = F}
# testplotpresence <- unique(decomposer[, .(Year, Plot)])
# vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
# rm(testplotpresence)
bp_overv <- aggregate(value ~ Plot, decomposer, sum)
barplot(height = bp_overv$value)
abline(h = mean(bp_overv$value), col = "red")
abline(h = median(bp_overv$value), col = "green")

# There are so many plots without decomposers - no idea if it still worth it... Include them or not?
length(unique(decomposer$Species)) # even though 40 species, there are so few present.
# sum(bp_overv$value == 0) # 81 plots have species, 58 don't, total 139.
# take out
trlevels <- trlevels[-which(trlevels == "decomposer")]
rm(decomposer)
```
```{r}
spdiv <- spdiv[!Trophic_level == "decomposer"]
```


## plant pathogen

```{r}
plant.pathogen <- spdiv[Trophic_level == "plant.pathogen"]
spdiv <- spdiv[!Trophic_level == "plant.pathogen"]
```
```{r}
bp_overv <- aggregate(value ~ Plot, plant.pathogen, sum)
barplot(height = bp_overv$value)
abline(h = mean(bp_overv$value), col = "red")
abline(h = median(bp_overv$value), col = "green")
```
remove missing plots
```{r}
plant.pathogen <- plant.pathogen[!Plot %in% bp_overv$Plot[which(bp_overv$value == 0)]]
# fill in missing combinations
plant.pathogen <- data.table::setDT(plant.pathogen)[data.table::CJ(Species=Species,Plot=Plot,unique=T), on=.(Species, Plot)]
plant.pathogen[is.na(value), value := 0 ]
nrow(plant.pathogen) == 84 * 148
```


## pollinator REMOVED

```{r, eval = F}
pollinator <- spdiv[Trophic_level == "pollinator"]
spdiv <- spdiv[!Trophic_level == "pollinator"]
```
```{r, eval = F}
bp_overv <- aggregate(value ~ Plot, pollinator, sum)
barplot(height = bp_overv$value, ylab = "number of pollinator species per plot")
abline(h = mean(bp_overv$value), col = "red")
abline(h = median(bp_overv$value), col = "green")
```
```{r, eval = F}
pollinator <- pollinator[!Plot %in% bp_overv$Plot[which(bp_overv$value == 0)]]
# fill in missing combinations
pollinator <- data.table::setDT(pollinator)[data.table::CJ(Species=Species,Plot=Plot,unique=T), on=.(Species, Plot)]
pollinator[is.na(value), value := 0 ]
nrow(pollinator) == 705 * 144
# cleaning
rm(bp_overv)
```
144 Plots with 705 species.
```{r}
spdiv <- spdiv[!Trophic_level == "pollinator"]
```


# Find plot Selection
Find subset of plots without missing diversity data and store.

Is there any plot with zero species?
```{r, eval=F}
for(t in trlevels){
  print(t)
  tr <- get(t)
  test <- aggregate(value ~ Plot, tr, sum)
  print(test$Plot[which(test$value == 0)])
}
```
There is no more plot with zero species in the dataset.

Select the plots without missing information and store. This chunk of code generates `plotNAset.rds`, the selected set of plots.
```{r, eval=F}
plots <- list()
for(t in trlevels){
  tr <- get(t)
  plots[[t]] <- unique(tr$Plot)
}
common.plots <- Reduce(intersect,plots) #130 plots
# take out HEG31 because this is taken out in functions
common.plots <- common.plots[-which(common.plots == "HEG31")]
saveRDS(common.plots, file = "plotNAset.rds")

redplotset <- c()
for(t in trlevels){
  redplotset[t] <- length(Reduce(intersect, plots[-which(names(plots) == t)]))
}

par(mar = c(10, 4.1, 4.1, 2.1))
barplot(redplotset, ylim = c(0, 140), las = 3, cex.names = 0.8, main = "Does removal of given trophic level increase number of plots?")
abline(h = 128, col = "darkgreen")
```
Inspect common plot set
```{r, eval=F}
paste("AEG :", length(grep("A", common.plots)), "   HEG :", length(grep("H", common.plots)), "    SEG :", length(grep("S", common.plots)), sep = "")
```
| region    | no. plots |
| --------- | --------- |
| all       |    129    |
| AEG       |    40     |
| HEG       |    43     |
| SEG       |    46     |




# Select Plots from diversity datasets
Only keep the selected plots
```{r}
if(!length(plotNAset) > 1){plotNAset <- common.plots}
for(t in trlevels){
  tr <- get(t)
  tr <- tr[Plot %in% plotNAset, ]
  assign(t, tr)
}
# take out HEG31, is automatic as soon as the gapfilling is run. 
# that means that this betadiversity script needs to be run twice, once before and once after the gapfilling
```

# overvievs
```{r, eval = F}
sum <- 0
for(t in trlevels){
  tr <- get(t)
  print(c(t, length(unique(tr$Species)), "species"))
  sum <- sum + length(unique(tr$Species))
}
sum
```
[1] "autotroph" "461"       "species"  
[1] "bacteria.RNA" "140510"       "species"     
[1] "belowground.herbivore" "11"                    "species"              
[1] "belowground.predator" "17"                   "species"             
[1] "herbivore" "401"       "species"  
[1] "plant.pathogen" "84"             "species"       
[1] "protist.bacterivore" "886"                 "species"            
[1] "protist.eukaryvore" "217"                "species"           
[1] "protist.omnivore" "444"              "species"         
[1] "protist.plant.parasite" "96"                     "species"               
[1] "secondary.consumer" "174"                "species"           
[1] "soilfungi.decomposer" "12342"                "species"             
[1] "soilfungi.pathotroph" "4097"                 "species"             
[1] "soilfungi.symbiont" "1416"               "species"   


# Calculate betadiversities
```{r}
for(t in trlevels){
  tr <- get(t)
  b.tr <- prepare_for_betapair(tr)
  b.tr <- betapart::beta.pair(b.tr, index.family = "sorensen")
  trsimname <- paste(t, ".beta.sim", sep = "")
  trnesname <- paste(t, ".beta.sne", sep = "")
  assign(trsimname, b.tr$beta.sim)
  assign(trnesname, b.tr$beta.sne)
}
rm(t); rm(tr); rm(b.tr); rm(trsimname); rm(trnesname)

# prepare for formatesitepair
# convert to long format
trlevels_components <- c(paste(trlevels, ".beta.sim", sep=""), paste(trlevels, ".beta.sne", sep=""))
# create super-dataframe to store all betadiversities
t <- trlevels_components[1] ; tr <- get(t) ; tr <- as.matrix(tr) ; tr[!lower.tri(tr)] <- NA
tr <- reshape2::melt(tr, value.name = t)
masterbeta <- tr[!is.na(tr[, 3]),]

for(t in trlevels_components[-1]){
  tr <- get(t)
  tr <- as.matrix(tr)
  tr[!lower.tri(tr)] <- NA
  tr <- reshape2::melt(tr, value.name = t)
  tr <- tr[!is.na(tr[, 3]),]
  masterbeta <- merge(masterbeta, tr, by = c("Var1", "Var2"))
}
rm(tr); rm(t)
```
save betadiversity datasets
```{r}
# for(t in trlevels){
#   tr <- get(t)
#   saveRDS(tr, file = paste(t, "betadiversity.rds", sep="_"))
# }
saveRDS(trlevels, "trlevels_vector.rds")
saveRDS(masterbeta, "master_beta.rds")
```

# Calculate alpha diversities
```{r}
for(t in trlevels){
  tr <- get(t)
  alpha <- aggregate(value ~ Plot, tr, function(x) sum(x))
  alphaname <- paste(t, ".alpha", sep = "")
  setnames(alpha, old = c("Plot", "value"), new = c("Var1", alphaname))
  assign(alphaname, alpha)
}
rm(t); rm(tr); rm(alpha); rm(alphaname)

# put all alphas together to masteralpha
masteralpha <- data.table::copy(autotroph.alpha) # by hand for trlevels[1]
for(t in trlevels[-1]){
  alphaname <- paste(t, ".alpha", sep = "")
  tr <- get(alphaname)
  masteralpha <- merge(masteralpha, tr, by = "Var1", all.x = T)
}
# save alphadiversities
saveRDS(masteralpha, "master_alpha.rds")

# combine betadiversity masters with alphas
masterdiversity <- merge(masterbeta, masteralpha, by = "Var1", all.x = T)
backup <- colnames(masteralpha)
colnames(masteralpha) <- paste(colnames(masteralpha), "2", sep = ".")
setnames(masteralpha, old = "Var1.2", new = "Var2")
masterdiversity <- merge(masterdiversity, masteralpha, by = "Var2", all.x = T)

# save masterdiversity
saveRDS(masterdiversity, "master_diversity_alpha_beta.rds")
```



# Cleaning
```{r}
rm(spdiv); rm(test); rm(tr); rm(t); rm(redplotset); rm(plots)
rm(list = trlevels)
rm(list = trlevels_components)
```
