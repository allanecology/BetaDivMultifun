---
title: "test"
author: "Noelle Schenk"
date: "May 7, 2019"
output: html_document
---
*requires* : spdiv, spinfo (spinfo is the file containing information about all species, spdiv is the collected data.)
```{r}
require(naniar)
```

# Calculate beta diversities
here I prepare the raw diversity dataset, prepare it for betapart and calculate beta diversities (abundance and presence-absence based).
Note: the beginning of the script is almost completely from Caterina until splitting into trophic levels (Thank you!)
```{r}
# to chose between presence absence or abundance, uncomment one of these lines (or, if both are commented, the script is sourced
# from another script where the vector is saved.)
# presence_absence or abundance?
typeofbeta <- "presenceabsence"
# typeofbeta <- "abundance"
```

```{r}
# table of contents
# 1. CLEAN THE DATASET
# 2. PREPARE FOR BETAPART (assess some problems)
# 3. RUN BETAPART presence - absence
# 4. RUN BETAPART abundance
# 5. CLEANING RESULTS

# by commenting, chose one of these options and therefore either the small or the larger dataset.
# ################################
# # Option 1 - SMALL DATASET
# # load the vector of plots to include in the analysis
# plot_NAset <- scan("plot_NAset_small_functions.txt" , character(), quote = "") # I saved this vector as a file as I will constantly use it.

################################
# Option 2 - LARGE DATASET
# load the vector of plots to include in the analysis
# plot_NAset <- scan("plot_NAset.txt" , character(), quote = "") # I saved this vector as a file as I will constantly use it.

```

## Dataset Cleaning
From cleaning, getting numbers : 
- 334700 species in the dataset
- 28 different trophic levels
- type = presenceabsence : plant pathogen, ant omnivore

*trophic levels*:
- autotroph
- herbivore
- decomposer
- belowground predator
- tertiary consumers
- 
- pollinator (if not used for functions)

```{r}
# delete Plot_bexis (old plot names)
spdiv[, Plot_bexis := NULL]
# spdiv[, c("Dataversion", "DataID") := NULL]
spdiv <- merge(spdiv, spinfo, by = "Species", all.x=T)
# now I can remove the original datasets, so I save cpu:
rm(spinfo); gc()
```
Set to presence-absence
```{r}
#TODO maybe add loop to test if type of beta is presence absence if needed
spdiv[value != 0, value := 1]
```


## Select trophic levels
Group to 18 trophic levels as needed for analysis. (see also `info_diversity.ods`)
```{r}
# take out trophic levels which are not used in analysis
spdiv <- spdiv[!Trophic_level %in% c("detritivore", "protist.unknown", "soilfungi.other", "vert.herb", "protist.parasite.nonplant")]
# merge the trophic levels which are merged in analysis
spdiv[Trophic_level == "herbivore.snail", Trophic_level := "herbivore"]
spdiv[Trophic_level == "ant.omnivore", Trophic_level := "omnivore"]
spdiv[Trophic_level == "omnivore.snail", Trophic_level := "omnivore"]
spdiv[Trophic_level == "protist.mainly.bacterivore", Trophic_level := "protist.bacterivore"]
# unique(spdiv$Trophic_level)
```
show years
```{r, eval=F}
unique(spdiv[, .(Trophic_level, Year)])
```

```{r, eval=F}
length(unique(spdiv$Species)) # 309734 species in the dataset (incl. OTU)
```
Get overview of amount of species per trophic level
```{r, eval=F}
for(t in unique(spdiv$Trophic_level)){
  print(c(t, length(unique(spdiv[Trophic_level == t, Species]))))
}
```



## Check if diversity across years is correlated
Create new column with trophic level and year
```{r, eval=F}
spdiv[, trlevel_year := paste(Trophic_level, Year, sep = "")]
```
Correlation plot of all trophic levels and years? Or better betadiversity among years?
```{r, eval=F}
# m <- cor(spdiv[, .(Species, value, trlevel_year)], use = "pariwise.complete.obs")
# 
# M <- cor(small_grlfuns[, !colnames(grlfuns) %in% c("Explo","Plotn", "Plot"), with=F], use="pairwise.complete.obs")
# corrplot::corrplot(M,type="lower",addCoef.col = "black",method="color",diag=F, tl.srt=1, tl.col="black", mar=c(1,0,1,0), number.cex=0.6)

# testing with 1 trophic level, 2 years
# for presence absence
for(trlevel in c("autotroph", "secondary.consumer", "tertiary.consumer")){
  pdf(paste("corr_diversity_across_years_", trlevel, ".pdf", sep=""), paper = "a4r")
  par(mfrow=c(12,12))
  test <- spdiv[Trophic_level == trlevel, .(Species, value, trlevel_year, Plot, Year)]
  for(p in unique(test$Plot)){
    a <- data.table::dcast.data.table(test[Plot == p], Year ~ Species, fill = 0)
    a[is.na(a)] <- 0
    a <- t(a)
    colnames(a) <- a[1,]
    a <- a[-1,]
    a <- apply(a, 2, as.numeric)
    # corrplot::corrplot(cor(a), type="lower", diag = F)
    a[a != 0] <- 1
    if(sum(is.na(cor(a))) >= 1) next
    corrplot::corrplot(cor(a), type="lower", diag = T, method = "square", tl.col = "black", order = "alphabet", tl.cex = 0.7, main = p)
  }
  dev.off()
}
# note : not possible OTU, because it can't be compared across years. The OTU identities always change.
# note : omnivore, herbivores different years are different species --> no overlap

# tertiary consumers : special case. take the 67 species measured in 2008, 2011 and 2012 and take the 11 suppl. species out of years 2009 and 2010.
tert <- spdiv[Trophic_level == "tertiary.consumer", .(Species, value, trlevel_year, Plot, Year)]
# find the 11 species which are only present in 2009 and 2010
unique(tert[Year == "2009", Species])[which(!unique(tert[Year == "2009", Species]) %in% unique(tert[Year == "2008", Species]))]
```

# Combine years

## autotrophs
Years 2008 to 2016.
Lichens and Bryophytes only 2009 (119 species, 137 plots)

year   |  no. species | no. Plots |
-------| ------------ | --------- |
2008   |   344        |  147      |
2009   |   463        |  150      |
2009 l |   119        |  150      |
2009 p |   344        |  150      |
2010   |   344        |  150      |
2011   |   344        |  150      |
2012   |   344        |  149      |
2013   |   344        |  149      |
2014   |   344        |  148      |
2015   |   344        |  150      |
2016   |   344        |  150      |

```{r}
autotroph <- spdiv[Trophic_level == "autotroph"]

# how many species and how many plots were measured in the different years?
length(unique(autotroph[Year == "2008", Plot])) # Changed year and tested for all years for reporting in the table
# get vector with lichen species to examine lichens separately
lichenspecies <- setdiff(unique(autotroph[Year == "2009", Species]), unique(autotroph[Year == "2008", Species]))
    # examine lichens and plants separately - same number of plots and expected number of species?
length(unique(autotroph[!Species %in% lichenspecies, Species]))
length(unique(autotroph[Species %in% lichenspecies, Plot]))
```
*Plots identities*
```{r, eval=F}
# are the same plots missing in all years?
testplotpresence <- unique(autotroph[, .(Year, Plot)])
vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
# no, different plots are missing.
rm(testplotpresence)
```
If a plant species is present in at least 1 year, it is considered to be present. Underlying assumption : plant species composition is quite stable, therefore it is representative to assess their presence in a large time span.

Test : check how different the species composition is if considering all years.

Assessing presence of plant species in all years. Lichen and Bryophyte species are taken directly from year 2009, as this is the only year.
```{r}
plants <- autotroph[!Species %in% lichenspecies, ]
lichens <- autotroph[Species %in% lichenspecies,]
# sum(length(unique(plants$Species)), length(unique(lichens$Species))) # check if the sum of species is 463 to be sure to have all autotroph species

# calculate the mean of all value (species presence/ absence). If it is not zero, the species was present in at least one year and the value can be set to 1.
plants <- aggregate(value ~ Species + Plot, plants, function(x) mean(x, na.rm=T))
plants <- data.table::data.table(plants)
# nrow(plants) == 344*150 # TRUE : there are 344 species per plot in the new dataset
# Check how many plant species have been present / absent in how many years
hist(plants$value, main="Presence of plant species among years", sub="The plot indicates if a plant species was either present in no year, \n in 1 years , ... , in all 9 years. Most species are never present", xlab = "")

# set the numbers which are not 0 or 1 to 1 (if value > 0, that means that plant has been present at least in one year)
plants[value != 0, value := 1]

# add the lichens dataset to the plants dataset
autotroph <- rbind(plants, lichens[, .(Species, Plot, value)])
# nrow(autotroph) == 150 * 344 + 150 * 119 # TRUE : there are 119 lichen and 344 plant species in all 150 plots.
```

```{r}
hist(autotroph$value)
hist(lichens$value)
hist(plants$value)
```
Although working with a range of 9 years, still many plant species are not present in many plots. This indicates that the assumption of stable autotroph species was correct.

```{r}
# remove lichens and plants, not used any more
rm(plants) ; rm(lichens); rm(lichenspecies)
```


## herbivore
```{r}
herbivore <- spdiv[Trophic_level == "herbivore"]
```
Note : the code below can be deleted as soon as the new diversity dataset is available.
```{r}
# Arthropod herbivores consist of 3 Groups, 2 of them contain missing data, one not.
# We can only take the plots present in all groups --> reduce the number of plots
unique(herbivore[Year == "2008", Group_fine])
length(unique(herbivore[Year == "2008" & Group_fine == "Hymenoptera", Plot]))
```
| Dataset  | Hemiptera | Coleoptera  | Hymenoptera | Orthoptera |
| -------- | --------- |------------ |------------ |----------- |
| no Plots |  139      |     139     |  **150**    |  139       |
```{r}
herbivore_plotset <- unique(herbivore[Year == "2008" & Group_fine == "Orthoptera", Plot])
# check if the plot set is consistent
sum(herbivore_plotset != unique(herbivore[Year == "2008" & Group_fine == "Hemiptera", Plot])) # all the same
sum(herbivore_plotset != unique(herbivore[Year == "2008" & Group_fine == "Coleoptera", Plot])) # all the same

# select the plot set for herbivores
# select all rows which are EITHER from 2008 (arthropods) and from the selected plot list, OR they are from 2017
# species from 2017 don't have to be part of the selected plots
herbivore <- herbivore[Plot %in% herbivore_plotset & Year == "2008" | Year == "2017", ]
```


```{r}
testplotpresence <- unique(herbivore[, .(Year, Plot)])
vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
rm(testplotpresence)
```
Snails were only measured in 134 plots. They contain 39 species. Insects were measured in all plots, they contain 401 species.

```{r}
length(unique(herbivore[Year == "2008", Species]))
length(intersect(herbivore[Year == "2008", Plot], herbivore[Year == "2017", Plot]))
```

| Year       |  2008    |  2017   | both   |
| Group      | insects  | snails  | both   |
| ---------- | -------- | ------- | ------ |
| no Plots   |   139    |  134    |  124   |
| no Species |   401    |   39    |  440   |

Too many missing plots in snails dataset. Take insects dataset only.
```{r}
herbivore <- herbivore[Year == "2008", .(Species, Plot, value)]
# nrow(herbivore) == 139 * 401 # 401 species in 139 plots present
```



## Omnivore
Consists of arthropods dataset from 2008, ants dataset from 2014_2015, and snails dataset from 2017.
```{r}
omnivore <- spdiv[Trophic_level == "omnivore"]
testplotpresence <- unique(omnivore[, .(Year, Plot)])
vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
rm(testplotpresence)
```
Many plots are missing.

subset     |  arthropods  | ants   | snails  |  all  |  arth&sn  | 
---------- | ------------ | ------ | ------- | ----- | --------- |
Year       |    2008      | 14 15  |  2017   | all   | 08 & 17   |
no Plots   |     139      |  110   |  134    |  97   |  124      |
no Species |     14       |  20    |  21     |  55   |  35       |

```{r}
# length(intersect(omnivore[Year == "2008", Plot], omnivore[Year == "2017", Plot]))
# length(intersect(intersect(omnivore[Year == "2008", Plot], omnivore[Year == "2017", Plot]), omnivore[Year == "2014_2015", Plot]))
```
Only took the arthropod dataset, as snails and ants have too many missing plots.
```{r}
omnivore <- omnivore[Year == "2008", .(Species, Plot, value)]
# omnivore_ant <- omnivore[Year == "2014_2015", .(Species, Plot, value)]
# omnivore_snail <- omnivore[Year == "2017", .(Species, Plot, value)]
```


## Secondary consumers
2008 dataset from 
```{r}
secondary_consumer <- spdiv[Trophic_level == "secondary.consumer"]
testplotpresence <- unique(secondary_consumer[, .(Year, Plot)])
vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
rm(testplotpresence)
```
Only 2008 dataset has some missing values

  Year     | 2008  | 2011 |
---------- | ----- | ---- |
no Plots   | 139   | 150* |
no Species | 170   |   4  |

Species set does not overlap.

* possibly, set from 2011 was not complete neither? But if the same error as in all insect datasets --> selecting plots from 2008 will solve the issue.
TODO : wait for new dataset and check wheter the 2011 data needs to be checked for missing plots or not.
```{r}
# length(unique(secondary_consumer[Year == "2008", Species]))
any(unique(secondary_consumer[Year == "2008", Species]) %in% unique(secondary_consumer[Year == "2011", Species]))
```

Select the Plot set from 2008 and merge the datasets together.
```{r}
secondary_consumer <- secondary_consumer[Plot %in% unique(unique(secondary_consumer[Year == "2008", Plot]))]
# nrow(secondary_consumer) == 4 * 139 + 170 * 139 # expected number of rows present
```


## Tertiary consumer
```{r}
tertiary_consumer <- spdiv[Trophic_level == "tertiary.consumer"]
testplotpresence <- unique(tertiary_consumer[, .(Year, Plot)])
vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
rm(testplotpresence)
```

   Year    | 2008   |    2009    |    2010    |   2011  |   2012   |
---------- | ------ | ---------- | ---------- | ------- | -------- |
subset     | birds  | birds bats | birds bats |  birds  |  birds   |
no Plot    |  150   |  150+149   |  150+150   |  150    |  150     |
no Species |  67    | 78= 67+11  | 78= 67+11  |  67     |  67      |

```{r}
# unique(tertiary_consumer[Year == "2012", Group_fine])
# length(unique(tertiary_consumer[Year == "2012", Plot]))

# length(intersect(unique(tertiary_consumer[Year == "2009", Species]), unique(tertiary_consumer[Year == "2010", Species])))
batspecies <- setdiff(unique(tertiary_consumer[Year == "2009", Species]), unique(tertiary_consumer[Year == "2011", Species]))
```
The Bird and Bat species of the different years are the same.

Take average of Species occurrence and check how often species occur. We assume that birds and bats are difficult to measure, therefore having a large time window makes sense. A species is considered to be present in a plot, if it is present at least in one year.
```{r}
birds <- aggregate(value ~ Species + Plot, tertiary_consumer[Group_fine == "Birds"], function(x) mean(x, na.rm=T))
birds <- data.table::data.table(birds)
# nrow(birds) == 67 * 150 # TRUE : 67 species in 150 plots
hist(birds$value, main="Presence of bird species among years")
# If species is present at least in one year, take it as present
birds[value > 0, value := 1]
nrow(birds) == 67 * 150 # expected number of rows present (67 species in 150 plots)

bats <- aggregate(value ~ Species + Plot, tertiary_consumer[Group_fine == "Bats" & Species %in% batspecies], function(x) mean(x, na.rm=T))
bats <- data.table::data.table(bats)
# nrow(bats) == 11 * 150
hist(bats$value)
# If species is present at least in one year, take it as present
bats[value > 0, value := 1]
nrow(bats) == 11 * 150 # expected number of rows present (11 species in 150 plots)

# combine the bird and bat dataset
tertiary_consumer <- rbind(birds, bats)
```


## Bacteria RNA

```{r}
bacteriaRNA <- spdiv[Trophic_level == "bacteria.RNA"]
testplotpresence <- unique(bacteriaRNA[, .(Year, Plot)])
vis_miss(data.table::dcast(testplotpresence, Plot ~ Year))
rm(testplotpresence)
```
Not visible in the plot, but there are only 148 plots for both years.

Check if OTU names are the same in both years. No obvious overlap.
```{r, eval=F}
length(setdiff(unique(bacteriaRNA[Year == "2014", Species]), unique(bacteriaRNA[Year == "2011", Species])))
# length(unique(bacteriaRNA$Species))
# The OTU names prefix is either bac11 or bac14 ...
# grep("01ece679a6294aadf97b931ce39a539a", bacteriaRNA$Species)
bacteriaRNA[grep("01ece679a6294aadf97b931ce39a539a", bacteriaRNA$Species), Year]
```
The OTUs can be compared across the years. However, we will only work with the 2011 dataset in order to be more consistent with the years.
Replace the prefix by bac_ instead of bac11_ and bac14_
```{r, eval=F}
# In case the years would be combined
bacteriaRNA[grep("bac11_", Species), Species := gsub("bac11_", "bac14_", Species)]
```

|    year    |  2011   |  2014     |  
| ---------- | ------- | --------- | 
| no Plots   |   148   |   148     |
| no OTUs    |  140510 |  139691   |

```{r, eval=F}
length(unique(bacteriaRNA[Year == "2014", Species]))
length(setdiff(unique(bacteriaRNA[Year == "2011", Species]), unique(bacteriaRNA[Year == "2014", Species]))) # 34435 # 35254
length(intersect(unique(bacteriaRNA[Year == "2011", Species]), unique(bacteriaRNA[Year == "2014", Species]))) # 105256
```
2014 : 34435 OTUs unique to 2014, 105256 overlapping of total 139691. ~ 1/4 to 3/4
2011 : 35254 OTUs unique to 2011, 105256 overlapping of total 140510. ~ 1/4 to 3/4
```{r}
grid.newpage()
draw.pairwise.venn(area1 = 34435 + 105256, area2 = 35254 + 105256, cross.area = 105256, category = c("2011 OTU", "2014 OTU"))
```
Select 2011 dataset.
```{r}
bacteriaRNA <- bacteriaRNA[Year == "2011", .(Species, Plot, value)]
# The bacteria RNA dataset had been reduced: all species-plot combinations with 0 were removed.
# reconstruct them (code from Caterina)
bacteriaRNA <- setDT(bacteriaRNA)[CJ(Species=Species,Plot=Plot,unique=T), on=.(Species, Plot)]
bacteriaRNA[is.na(value), value := 0 ]
# add NA values for the two missing plots
bac_missing <- rbind(data.table::data.table(Species = unique(bacteriaRNA[Plot == "AEG21", Species]), Plot = "AEG33", value = NA),
                     data.table::data.table(Species = unique(bacteriaRNA[Plot == "AEG21", Species]), Plot = "AEG34", value = NA))
bacteriaRNA <- rbind(bacteriaRNA, bac_missing)
nrow(bacteriaRNA) == 150 * 140510
```


## protist.bacterivore
2011, 2011_2012, 2017 datasets
```{r}
protist_bacterivore <- spdiv[Trophic_level == "protist.bacterivore"]
testplotpresence <- unique(protist_bacterivore[, .(Year, Plot)])
vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
rm(testplotpresence)
```
Only 1 plot missing, in 2011

Are the OTU the same across years?
Datasets 2011 and 2017 are comparable with each others, but not with dataset 2011_2012. The name appendices for the latter need to be preserved, the other prefixes can be removed.
```{r, eval=F}
protist_bacterivore[grep("_protist24426", Species), Species := gsub("_protist24426", "", Species)] # remove appendix from 2011
protist_bacterivore[grep("_protist24466", Species), Species := gsub("_protist24466", "", Species)] # remove appendix from 2017

length(setdiff(unique(protist_bacterivore[Year == "2011", Species]), unique(protist_bacterivore[Year == "2011_2012", Species])))
length(intersect(unique(protist_bacterivore[Year == "2017", Species]), unique(protist_bacterivore[Year == "2011_2012", Species])))
# length(unique(protist_bacterivore[Year == "2011", Species]))
# length(unique(protist_bacterivore[Year == "2011_2012", Species]))
```

|    year    | 2011    | 2011_2012 |  2017  | 2011 2017 | 2017 2011_2012 |
| ---------- | ------- | --------- | ------ | --------- | -------------- |
| no Plots   |   149   |   150     |   150  |    149    |     149        |
| no OTUs    |   856   |   233     |   863  | 833+23+30 |       0        |

No overlap between 2011 and 2011_2012 and 2017 and 2011_2012. 

For BetaDivMultifun, only year 2011 is chosen : 
```{r}
protist_bacterivore <- protist_bacterivore[Year == "2011"]
nrow(protist_bacterivore) == 149 * 856
#TODO add the missing plot rows

# HERE! find the missing plot and maybe add it again. (23.5.19)

# pro_mis <- data.table::data.table(Species = unique(protist_bacterivore[Plot == "AEG21", Species]), Plot = "AEG33", value = NA)
```



## protist.eukaryvore
```{r}
protist_eukaryvore <- spdiv[Trophic_level == "protist.eukaryvore"]
testplotpresence <- unique(protist_eukaryvore[, .(Year, Plot)])
vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
rm(testplotpresence)
```
Only 1 plot missing, in 2011.

Renaming of OTUs necessary
```{r}
#TODO : remove those lines once new dataset is there
protist_eukaryvore[grep("_protist24426", Species), Species := gsub("_protist24426", "", Species)] # clean 2011
protist_eukaryvore[grep("_protist24466", Species), Species := gsub("_protist24466", "", Species)] # clean 2017
```

```{r, eval=F}
# interchange intersect with setdiff and modify years to obtain values in table below
length(setdiff(unique(protist_eukaryvore[Year == "2017", Species]), unique(protist_eukaryvore[Year == "2011", Species])))
length(unique(protist_eukaryvore[Year == "2011", Plot]))
```

|   Year   |   2011   |  2017  |  both    |
| -------- | -------- | ------ | -------- |
| no Plots |   149    |  150   |    149   |
| no OTUs  |   211    |  210   | 204+7+6  |


## protist.omnivore

```{r}
protist_omnivore <- spdiv[Trophic_level == "protist.omnivore"]
testplotpresence <- unique(protist_omnivore[, .(Year, Plot)])
vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
rm(testplotpresence)
```
Only 1 plot missing, in 2011.

Renaming of OTUs necessary
```{r}
protist_omnivore[grep("_protist24426", Species), Species := gsub("_protist24426", "", Species)] # clean 2011
protist_omnivore[grep("_protist24466", Species), Species := gsub("_protist24466", "", Species)] # clean 2017
```

```{r, eval=F}
# interchange intersect with setdiff and modify years to obtain values in table below
length(intersect(unique(protist_omnivore[Year == "2011", Species]), unique(protist_omnivore[Year == "2017", Species])))
length(unique(protist_omnivore[Year == "2017", Species]))
```

|   Year   |   2011   |  2017  |  both    |
| -------- | -------- | ------ | -------- |
| no Plots |   149    |  150   |    149   |
| no OTUs  |   440    |  434   | 430+10+4 |



## protist.plant.parasite

```{r}
protist_plantparasite <- spdiv[Trophic_level == "protist.plant.parasite"]
testplotpresence <- unique(protist_plantparasite[, .(Year, Plot)])
vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
rm(testplotpresence)
```
Only 1 plot missing, in 2011.

Renaming of OTUs necessary
```{r}
protist_plantparasite[grep("_protist24426", Species), Species := gsub("_protist24426", "", Species)] # clean 2011
protist_plantparasite[grep("_protist24466", Species), Species := gsub("_protist24466", "", Species)] # clean 2017
```

```{r, eval=F}
# interchange intersect with setdiff and modify years to obtain values in table below
length(setdiff(unique(protist_plantparasite[Year == "2017", Species]), unique(protist_plantparasite[Year == "2011", Species])))
length(unique(protist_plantparasite[Year == "2017", Plot]))
```

|   Year   |   2011   |  2017  |  both    |
| -------- | -------- | ------ | -------- |
| no Plots |   149    |  150   |    149   |
| no OTUs  |   96     |   95   |  95+1+0  |


Probably skipping the OTU which is only present in 2011 and work with the 95 overlapping ones.


## soilfungi.decomposer
Years 2011, 2014, 2017
```{r}
soilfungi_decomposer <- spdiv[Trophic_level == "soilfungi.decomposer"]
testplotpresence <- unique(soilfungi_decomposer[, .(Year, Plot)])
vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
rm(testplotpresence)
```
Check if OTU need renaming
```{r}
length(unique(soilfungi_decomposer[Year == "2017", Species]))
length(setdiff(unique(soilfungi_decomposer[Year == "2017", Species]), unique(soilfungi_decomposer[Year == "2014", Species])))

length(intersect(intersect(unique(soilfungi_decomposer[Year == "2011", Species]), unique(soilfungi_decomposer[Year == "2017", Species])), unique(soilfungi_decomposer[Year == "2014", Species])))
```

|  Year    |  2011  |  2014  |  2017  | 11 14            |     11 17      |      14 17     | all
| -------- | ------ | ------ | ------ | ---------------- | -------------- | -------------- | --------------- |
| no Plots |  150   |  150   |  150   |       150        |       150      |      150       |      150        |
| no OTUs  | 12342  | 10772  | 10971  | 9403+2939+1369   | 9368+2974+1603 | 8391+2381+2580 | 7420+(see left) |


## soilfungi.pathotroph

```{r}
soilfungi_pathotroph <- spdiv[Trophic_level == "soilfungi.pathotroph"]
testplotpresence <- unique(soilfungi_pathotroph[, .(Year, Plot)])
vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
rm(testplotpresence)
```
No missing plots
```{r}
length(unique(soilfungi_pathotroph[Year == "2017", Species]))

length(setdiff(unique(soilfungi_pathotroph[Year == "2017", Species]), unique(soilfungi_pathotroph[Year == "2011", Species])))
length(intersect(intersect(unique(soilfungi_pathotroph[Year == "2011", Species]), unique(soilfungi_pathotroph[Year == "2017", Species])), unique(soilfungi_pathotroph[Year == "2014", Species])))
```
|  Year    |  2011  |  2014  |  2017  |      11 14       |     11 17      |      14 17     | all
| -------- | ------ | ------ | ------ | ---------------- | -------------- | -------------- | --------------- |
| no Plots |  150   |  150   |  150   |       150        |       150      |      150       |      150        |
| no OTUs  |  4097  |  6313  |  2924  | 2852+1245+3461   | 2852+1245+304  | 2134+4179+790 | 1934+(see left) |


## soilfungi.symbiont


```{r}
soilfungi_symbiont <- spdiv[Trophic_level == "soilfungi.symbiont"]
testplotpresence <- unique(soilfungi_symbiont[, .(Year, Plot)])
vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
rm(testplotpresence)
```
No missing plots
```{r}
length(unique(soilfungi_symbiont[Year == "2017", Species]))

length(setdiff(unique(soilfungi_symbiont[Year == "2017", Species]), unique(soilfungi_symbiont[Year == "2014", Species])))

length(intersect(intersect(unique(soilfungi_symbiont[Year == "2011", Species]), unique(soilfungi_symbiont[Year == "2017", Species])), unique(soilfungi_symbiont[Year == "2014", Species])))
```
|  Year    |  2011  |  2014  |  2017  |      11 14       |     11 17      |      14 17     |    all          |
| -------- | ------ | ------ | ------ | ---------------- | -------------- | -------------- | --------------- |
| no Plots |  150   |  150   |  150   |       150        |       150      |      150       |      150        |
| no OTUs  |  1416  |  1478  |  1445  |   1093+323+385   |  1057+359+388  | 1080+398+365   |  914+(see left) |



<!-------------------------------------------------------------------------------------------------------------------------------->

## Select Plots
Select the plots without missing information and store. 
```{r}
plots <- list()
for (i in unique(spdiv$Trophic_level)){
  plots[[i]] <- unique(spdiv[Trophic_level==i]$Plot)
}
common.plots <- Reduce(intersect,plots) #137 plots (3 more than last time)
saveRDS(common.plots, file = "plotNAset.rds")
# for each trophic level, checked it number of plots would increase (where are the missing plots coming from?)
# length(Reduce(intersect, plots[-5])) # 144 without decomposers
# length(Reduce(intersect, plots[-15])) # 139 without bacteria.RNA
# length(Reduce(intersect, plots[-5][-14])) # 146 without both decomposers and bacteria.RNA
```
137 plots contain no missing information. If decomposers would be taken out, 144 plots would be available. If bacteria.RNA would be taken out, 139 plots would be available (146 if both taken out).

Inspect what happens with decomposers (below code). They are missing because they were not measured at 11 plots, there is no missing entry in the dataset. Metadata says that 145 EPs were measured.
```{r, eval=F}
dec <- spdiv[Trophic_level == "decomposer"]
length(unique(dec$Plot))
#TODO why?
```
Get the common plot names overview
```{r, eval=F}
paste("AEG :", length(grep("A", common.plots)), "   HEG :", length(grep("H", common.plots)), "    SEG :", length(grep("S", common.plots)), sep = "")
```
There are 42 plots from AEG, 47 from HEG and 48 from SEG.

Only keep the selected plots
```{r}
spdiv <- spdiv[Plot %in% common.plots,]
```





### abundance

### presence-absence
transform into presence- absence if required
```{r}
if(typeofbeta == "presenceabsence"){
  spdiv[value > 0, value := 1]
}
# no mising values there!
# sum(is.na(spdiv$value))
```


below : the old script I wrote in 2017
```{r}
#for each taxonomic group get the list of plots (I use Group.broad because this is the level
#at which species were collected)


# length(unique(plots$AMF)) # plots$AMF contains all 150 plots
# save the set of plots to exclude.
uncommon.plots <- plots$AMF[!plots$AMF %in% common.plots]

#now dcast everybody using Trophic_levels and subset according to common plots
trnames <- unique(grl$Trophic_level)

for(i in trnames){
  temp <- grl[Trophic_level==i]
  # # change the format of my data and only keep the information needed to calculate beta diversity
  # newdata <- dcast.data.table(temp, Plot ~ Species)
  # newdata <- as.data.frame(newdata[Plot %in% common.plots]) #if you want it to be a dataframe
  # rownames(newdata) <- newdata[,"Plot"]
  # store the new dataset with the same name as before
  newdata <- temp
  assign(i, newdata)
  print(paste(i,sum(is.na(newdata)))) #to see if there are NA's
}
rm(temp) ; gc()

# there are two measures for species Urocystis_agropyri (not for all plots). If there are 2 measures, they are different,
# so one of the measures is always 1. (I removed all doubles before!) I always take 1 if both variants occur.
# must also work for abundance data!

plant.pathogen <- as.data.table(plant.pathogen)
plant.pathogen[, DataID:=NULL] # take out DataID because some differ in DataID only.
plant.pathogen = unique(plant.pathogen)
new_uro <- plant.pathogen[Species== "Urocystis_agropyri",][order(Plot,value,decreasing=T)]

duprow <- duplicated(new_uro, by="Plot") # the duplicated rows are always the second ones.
#                                          here: the ones containing 0 (as they are sorted).
new_uro <- new_uro[! duprow,] # the new dataset for urocystis_agropyri
plant.pathogen <- plant.pathogen[Species!= "Urocystis_agropyri",]
plant.pathogen <- rbind(plant.pathogen, new_uro)

rm(new_uro) ; rm(duprow) ; gc()

#########################
# 2. PREPARE FOR BETAPART
#########################
# change the format of my data and only keep the information needed to calculate beta diversity
# betapart requires a specific format: data.frame in which rownames are sites and columnnamess are species.
# therefore, first I need to get my dataset into the right format:
for(i in trnames){
  temp <- get(i)
  newdata <- dcast.data.table(temp, Plot ~ Species)
  newdata <- as.data.frame(newdata[Plot %in% common.plots]) #if you want it to be a dataframe
  rownames(newdata) <- newdata[,"Plot"]
  newdata <- newdata[ , !(names(newdata) == "Plot")]
  # store the new dataset with the same name as before
  assign(i, newdata)
}


###################
# Handle NA VALUES:
# 
#herbivore is the only group with NAs -> why?
unique(grl[Trophic_level=="herbivore"]$Group_broad)
herbivore[1:10,colSums(is.na(herbivore))>0]

#it's just two species, we can remove them and we should be good!
herbivore <- herbivore[colSums(is.na(herbivore))==0]
sum(is.na(herbivore))
# now I can remove grl
rm(grl) ; gc()


# CREATION OF plot_NAset vector which is stored now
# betapart can't handle NA values, I need to take out plots which contain NA values in any species
# 1. Check how many and which plots contain NA values

plot_NAset <- vector()
# na_vals_per_level <- list()
for(i in trnames){
  data <- get(i)
  navals <- apply(data, 1, function(r) any(is.na(r)))
  plot_NAset <- append(plot_NAset, rownames(data)[navals])
  # # if wanted, the list na_vals_per_level can be made as well, where you see which plot misses in which trophic level
  # name <- paste(i, 'na_plots')
  # na_vals_per_level[[name]] <- unique(rownames(data)[navals])
}
plot_NAset <- unique(plot_NAset) # I lose 4 more plots from my data.
length(plot_NAset)
rm(navals); rm(data) ; rm(i) ; gc()
# rm(name)

# merge plot_NAset with uncommon.plots to have the whole set of plots to exclude.
plot_NAset <- c(plot_NAset, uncommon.plots) # I only exclude 20 plots now
# take out plot_NAset from common plots
common.plots <- common.plots[!common.plots %in% plot_NAset]
# table(substr(common.plots,0,1)) # there are 39 plots from AEG, 44 plots from HEG and 47 plots from SEG
write(plot_NAset,file="plot_NAset.txt") # wrote plot_NAset to a file so I can easily access it without running this script.

# delete all rows which contain plots occurring in plot_NAset
for(i in trnames){
  data <- get(i)
  newdata <- data[!rownames(data) %in% plot_NAset ,]
  assign(i,newdata)
}
rm(data) ; rm(i) ; rm(newdata)

# # How many Species are there in one trophic level?
# for(i in unique(grl[,Trophic_level])){
#   len <- length(unique(grl[Trophic_level == i, Species]))
#   print(paste(i, " : " , len))
# }
# rm(len) ; rm(i)


######################################
# 3. RUN BETAPART presence - absence #
######################################
# before running: check if the whole 4. is commented! (not running)

# As in some datasets, there are many 0 variables, some plots have NaN (in omnivore, many plots)
# NaN occur if there are no occurrences of any species in both plots. Therefore, I will replace NaN values with 0, using 
# this function in the for loop
remove_nan <- function(x){
  x[is.nan(x)] <- 0
  return(x)
}

if(typeofbeta == "presence_absence"){
  beta_pa <- vector() # either beta_pa or beta_abund
  for(i in trnames){
    set <- get(i)
    name <- paste('beta_pa',i,sep='_') # beta_pa stands for "presence-absence" ; beta_abund for "abundance"
    result <- beta.pair(set, index.family="sorensen")
    result <- lapply(result,as.matrix)
    result <- lapply(result, function(x) cbind("Plot" = seq(1,130,by=1),x))
    result <- lapply(result, function(x) remove_nan(x))
    assign(name, result)
    beta_pa <- append(beta_pa , name)
  }
  rm(set) ; rm(name) ; rm(result) ; rm(i)
}

######################################
# 4. RUN BETAPART abundance          #
######################################
# to run this part, change the variable typeofbeta to "abundance"

# As in some datasets, there are many 0 variables, some plots have NaN (in omnivore, many plots)
# NaN occur if there are no occurrences of any species in both plots. Therefore, I will replace NaN values with 0, using
# the function made under presence absence.
if(typeofbeta == "abundance"){
  beta_abund <- vector()
  for(i in trnames){
    set <- get(i)
    name <- paste('beta_abund',i,sep='_') # beta_pa stands for "presence-absence" ; beta_abund for "abundance"
    result <- beta.pair.abund(set, index.family = "bray")
    result <- lapply(result,as.matrix)
    result <- lapply(result, function(x) cbind("Plot" = seq(1,130,by=1),x))
    result <- lapply(result, function(x) remove_nan(x))
    assign(name, result)
    beta_abund <- append(beta_abund , name)
  }
  rm(set) ; rm(name) ; rm(result) ; rm(i)
}

######################################
# 5. CLEANING THE RESULTS            #
######################################
# remove original data
rm(autotroph) ; rm(belowground.herbivore) ; rm(belowground.predator) ; rm(decomposer) ; rm(herbivore) ; rm(microbe.decomposer)
rm(plant.pathogen); rm(protist) ; rm(secondary.consumer) ; rm(soilfungi.decomposer) ; rm(soilfungi.pathogen)
rm(symbiont) ; rm(tertiary.consumer) ; rm(vert.herb) ; rm(plots) ; rm(uncommon.plots)
# remove unwanted vector
rm(plot_NAset) ;  rm(trnames) ; rm(typeofbeta)
gc()
```

