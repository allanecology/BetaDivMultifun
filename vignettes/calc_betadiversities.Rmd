---
title: "test"
author: "Noelle Schenk"
date: "May 7, 2019"
output: html_document
---
*requires* : spdiv, spinfo (spinfo is the file containing information about all species, spdiv is the collected data.)

# Calculate beta diversities
here I prepare the raw diversity dataset, prepare it for betapart and calculate beta diversities (abundance and presence-absence based).
Note: the beginning of the script is almost completely from Caterina until splitting into trophic levels (Thank you!)
```{r}
# to chose between presence absence or abundance, uncomment one of these lines (or, if both are commented, the script is sourced
# from another script where the vector is saved.)
# presence_absence or abundance?
typeofbeta <- "presenceabsence"
# typeofbeta <- "abundance"
```

```{r}
# table of contents
# 1. CLEAN THE DATASET
# 2. PREPARE FOR BETAPART (assess some problems)
# 3. RUN BETAPART presence - absence
# 4. RUN BETAPART abundance
# 5. CLEANING RESULTS

# by commenting, chose one of these options and therefore either the small or the larger dataset.
# ################################
# # Option 1 - SMALL DATASET
# # load the vector of plots to include in the analysis
# plot_NAset <- scan("plot_NAset_small_functions.txt" , character(), quote = "") # I saved this vector as a file as I will constantly use it.

################################
# Option 2 - LARGE DATASET
# load the vector of plots to include in the analysis
# plot_NAset <- scan("plot_NAset.txt" , character(), quote = "") # I saved this vector as a file as I will constantly use it.

```

## Dataset Cleaning
From cleaning, getting numbers : 
- 334700 species in the dataset
- 28 different trophic levels
- type = presenceabsence : plant pathogen, ant omnivore

*trophic levels*:
- autotroph
- herbivore
- decomposer
- belowground predator
- tertiary consumers
- 
- pollinator (if not used for functions)

```{r}
# delete Plot_bexis (old plot names)
spdiv[, Plot_bexis := NULL]
# spdiv[, c("Dataversion", "DataID") := NULL]
spdiv <- merge(spdiv, spinfo, by = "Species", all.x=T)
# now I can remove the original datasets, so I save cpu:
rm(spinfo); gc()
```

## Select trophic levels
Group to 18 trophic levels as needed for analysis. (see also `info_diversity.ods`)
```{r}
# take out trophic levels which are not used in analysis
spdiv <- spdiv[!Trophic_level %in% c("detritivore", "protist.unknown", "soilfungi.other", "vert.herb", "protist.parasite.nonplant")]
# merge the trophic levels which are merged in analysis
spdiv[Trophic_level == "herbivore.snail", Trophic_level := "herbivore"]
spdiv[Trophic_level == "ant.omnivore", Trophic_level := "omnivore"]
spdiv[Trophic_level == "omnivore.snail", Trophic_level := "omnivore"]
spdiv[Trophic_level == "protist.mainly.bacterivore", Trophic_level := "protist.bacterivore"]
# unique(spdiv$Trophic_level)
```
show years
```{r}
unique(spdiv[, .(Trophic_level, Year)])
```

```{r}
length(unique(spdiv$Species)) # 309734 species in the dataset (incl. OTU)
```
Get overview of amount of species per trophic level
```{r, eval=F}
for(t in unique(spdiv$Trophic_level)){
  print(c(t, length(unique(spdiv[Trophic_level == t, Species]))))
}
```



## Check if diversity across years is correlated
Create new column with trophic level and year
```{r, eval=F}
spdiv[, trlevel_year := paste(Trophic_level, Year, sep = "")]
```
Correlation plot of all trophic levels and years? Or better betadiversity among years?
```{r, eval=F}
# m <- cor(spdiv[, .(Species, value, trlevel_year)], use = "pariwise.complete.obs")
# 
# M <- cor(small_grlfuns[, !colnames(grlfuns) %in% c("Explo","Plotn", "Plot"), with=F], use="pairwise.complete.obs")
# corrplot::corrplot(M,type="lower",addCoef.col = "black",method="color",diag=F, tl.srt=1, tl.col="black", mar=c(1,0,1,0), number.cex=0.6)

# testing with 1 trophic level, 2 years
# for presence absence
for(trlevel in c("autotroph", "secondary.consumer", "tertiary.consumer")){
  pdf(paste("corr_diversity_across_years_", trlevel, ".pdf", sep=""), paper = "a4r")
  par(mfrow=c(12,12))
  test <- spdiv[Trophic_level == trlevel, .(Species, value, trlevel_year, Plot, Year)]
  for(p in unique(test$Plot)){
    a <- data.table::dcast.data.table(test[Plot == p], Year ~ Species, fill = 0)
    a[is.na(a)] <- 0
    a <- t(a)
    colnames(a) <- a[1,]
    a <- a[-1,]
    a <- apply(a, 2, as.numeric)
    # corrplot::corrplot(cor(a), type="lower", diag = F)
    a[a != 0] <- 1
    if(sum(is.na(cor(a))) >= 1) next
    corrplot::corrplot(cor(a), type="lower", diag = T, method = "square", tl.col = "black", order = "alphabet", tl.cex = 0.7, main = p)
  }
  dev.off()
}
# note : not possible OTU, because it can't be compared across years. The OTU identities always change.
# note : omnivore, herbivores different years are different species --> no overlap

# tertiary consumers : special case. take the 67 species measured in 2008, 2011 and 2012 and take the 11 suppl. species out of years 2009 and 2010.
tert <- spdiv[Trophic_level == "tertiary.consumer", .(Species, value, trlevel_year, Plot, Year)]
# find the 11 species which are only present in 2009 and 2010
unique(tert[Year == "2009", Species])[which(!unique(tert[Year == "2009", Species]) %in% unique(tert[Year == "2008", Species]))]
```

# Combine years

## autotrophs
Years 2008 to 2016.
Lichens and Bryophytes only 2009 (119 species, 137 plots)

year   |  no. species | no. Plots |
-------| ------------ | --------- |
2008   |   344        |  147      |
2009   |   463        |  150      |
2009 l |   119        |  150      |
2009 p |   344        |  150      |
2010   |   344        |  150      |
2011   |   344        |  150      |
2012   |   344        |  149      |
2013   |   344        |  149      |
2014   |   344        |  148      |
2015   |   344        |  150      |
2016   |   344        |  150      |


```{r}
auto <- spdiv[Trophic_level == "autotroph"]

# how many species and how many plots were measured in the different years?
length(unique(auto[Year == "2008", Plot]))
# get vector with lichen species to examine lichens separately
lichenspecies <- setdiff(unique(auto[Year == "2009", Species]), unique(auto[Year == "2008", Species]))
    # examine lichens and plants separately - same number of plots and expected number of species?
length(unique(auto[!Species %in% lichenspecies, Species]))
length(unique(auto[Species %in% lichenspecies, Plot]))
```
*Plots identities*

- 2012 dataset contains plot SEG22, which is not present in 2012
    - 2013 dataset contains plot AEG02, which is not present in 2013
--> need to plot that, it's a mess...
```{r}
# same plots in the 137 plots in all years?
test <- unique(auto[, .(Year, Plot)])
test2 <- data.table::dcast(test, Plot ~Year)
vis_miss(test2)

# library(cowplot)
# ggplot(test, aes(Plot, Year)) +
#         geom_point() +
#   theme(axis.text = element_text(angle = 45, hjust = 1, size=10))
# 
# auto_overview <- data.table::data.table()
# auto_overview[, original_plots := unique(auto[Year == "2016", Plot])]
# auto_overview[, plots2016 := unique(auto[Year == "2016", Plot])]
# auto_overview[, plots2015 := unique(auto[Year == "2015", Plot])]
# auto_overview[, plots2014 := unique(auto[Year == "2014", Plot])]
# 
# setdiff(unique(auto[Year == "2013", Plot]), unique(auto[Year == "2014", Plot]))

```






## Select Plots
Select the plots without missing information and store. 
```{r}
plots <- list()
for (i in unique(spdiv$Trophic_level)){
  plots[[i]] <- unique(spdiv[Trophic_level==i]$Plot)
}
common.plots <- Reduce(intersect,plots) #137 plots (3 more than last time)
saveRDS(common.plots, file = "plotNAset.rds")
# for each trophic level, checked it number of plots would increase (where are the missing plots coming from?)
# length(Reduce(intersect, plots[-5])) # 144 without decomposers
# length(Reduce(intersect, plots[-15])) # 139 without bacteria.RNA
# length(Reduce(intersect, plots[-5][-14])) # 146 without both decomposers and bacteria.RNA
```
137 plots contain no missing information. If decomposers would be taken out, 144 plots would be available. If bacteria.RNA would be taken out, 139 plots would be available (146 if both taken out).

Inspect what happens with decomposers (below code). They are missing because they were not measured at 11 plots, there is no missing entry in the dataset. Metadata says that 145 EPs were measured.
```{r, eval=F}
dec <- spdiv[Trophic_level == "decomposer"]
length(unique(dec$Plot))
#TODO why?
```
Get the common plot names overview
```{r, eval=F}
paste("AEG :", length(grep("A", common.plots)), "   HEG :", length(grep("H", common.plots)), "    SEG :", length(grep("S", common.plots)), sep = "")
```
There are 42 plots from AEG, 47 from HEG and 48 from SEG.

Only keep the selected plots
```{r}
spdiv <- spdiv[Plot %in% common.plots,]
```





### abundance

### presence-absence
transform into presence- absence if required
```{r}
if(typeofbeta == "presenceabsence"){
  spdiv[value > 0, value := 1]
}
# no mising values there!
# sum(is.na(spdiv$value))
```


below : the old script I wrote in 2017
```{r}
#for each taxonomic group get the list of plots (I use Group.broad because this is the level
#at which species were collected)


# length(unique(plots$AMF)) # plots$AMF contains all 150 plots
# save the set of plots to exclude.
uncommon.plots <- plots$AMF[!plots$AMF %in% common.plots]

#now dcast everybody using Trophic_levels and subset according to common plots
trnames <- unique(grl$Trophic_level)

for(i in trnames){
  temp <- grl[Trophic_level==i]
  # # change the format of my data and only keep the information needed to calculate beta diversity
  # newdata <- dcast.data.table(temp, Plot ~ Species)
  # newdata <- as.data.frame(newdata[Plot %in% common.plots]) #if you want it to be a dataframe
  # rownames(newdata) <- newdata[,"Plot"]
  # store the new dataset with the same name as before
  newdata <- temp
  assign(i, newdata)
  print(paste(i,sum(is.na(newdata)))) #to see if there are NA's
}
rm(temp) ; gc()

# there are two measures for species Urocystis_agropyri (not for all plots). If there are 2 measures, they are different,
# so one of the measures is always 1. (I removed all doubles before!) I always take 1 if both variants occur.
# must also work for abundance data!

plant.pathogen <- as.data.table(plant.pathogen)
plant.pathogen[, DataID:=NULL] # take out DataID because some differ in DataID only.
plant.pathogen = unique(plant.pathogen)
new_uro <- plant.pathogen[Species== "Urocystis_agropyri",][order(Plot,value,decreasing=T)]

duprow <- duplicated(new_uro, by="Plot") # the duplicated rows are always the second ones.
#                                          here: the ones containing 0 (as they are sorted).
new_uro <- new_uro[! duprow,] # the new dataset for urocystis_agropyri
plant.pathogen <- plant.pathogen[Species!= "Urocystis_agropyri",]
plant.pathogen <- rbind(plant.pathogen, new_uro)

rm(new_uro) ; rm(duprow) ; gc()

#########################
# 2. PREPARE FOR BETAPART
#########################
# change the format of my data and only keep the information needed to calculate beta diversity
# betapart requires a specific format: data.frame in which rownames are sites and columnnamess are species.
# therefore, first I need to get my dataset into the right format:
for(i in trnames){
  temp <- get(i)
  newdata <- dcast.data.table(temp, Plot ~ Species)
  newdata <- as.data.frame(newdata[Plot %in% common.plots]) #if you want it to be a dataframe
  rownames(newdata) <- newdata[,"Plot"]
  newdata <- newdata[ , !(names(newdata) == "Plot")]
  # store the new dataset with the same name as before
  assign(i, newdata)
}


###################
# Handle NA VALUES:
# 
#herbivore is the only group with NAs -> why?
unique(grl[Trophic_level=="herbivore"]$Group_broad)
herbivore[1:10,colSums(is.na(herbivore))>0]

#it's just two species, we can remove them and we should be good!
herbivore <- herbivore[colSums(is.na(herbivore))==0]
sum(is.na(herbivore))
# now I can remove grl
rm(grl) ; gc()


# CREATION OF plot_NAset vector which is stored now
# betapart can't handle NA values, I need to take out plots which contain NA values in any species
# 1. Check how many and which plots contain NA values

plot_NAset <- vector()
# na_vals_per_level <- list()
for(i in trnames){
  data <- get(i)
  navals <- apply(data, 1, function(r) any(is.na(r)))
  plot_NAset <- append(plot_NAset, rownames(data)[navals])
  # # if wanted, the list na_vals_per_level can be made as well, where you see which plot misses in which trophic level
  # name <- paste(i, 'na_plots')
  # na_vals_per_level[[name]] <- unique(rownames(data)[navals])
}
plot_NAset <- unique(plot_NAset) # I lose 4 more plots from my data.
length(plot_NAset)
rm(navals); rm(data) ; rm(i) ; gc()
# rm(name)

# merge plot_NAset with uncommon.plots to have the whole set of plots to exclude.
plot_NAset <- c(plot_NAset, uncommon.plots) # I only exclude 20 plots now
# take out plot_NAset from common plots
common.plots <- common.plots[!common.plots %in% plot_NAset]
# table(substr(common.plots,0,1)) # there are 39 plots from AEG, 44 plots from HEG and 47 plots from SEG
write(plot_NAset,file="plot_NAset.txt") # wrote plot_NAset to a file so I can easily access it without running this script.

# delete all rows which contain plots occurring in plot_NAset
for(i in trnames){
  data <- get(i)
  newdata <- data[!rownames(data) %in% plot_NAset ,]
  assign(i,newdata)
}
rm(data) ; rm(i) ; rm(newdata)

# # How many Species are there in one trophic level?
# for(i in unique(grl[,Trophic_level])){
#   len <- length(unique(grl[Trophic_level == i, Species]))
#   print(paste(i, " : " , len))
# }
# rm(len) ; rm(i)


######################################
# 3. RUN BETAPART presence - absence #
######################################
# before running: check if the whole 4. is commented! (not running)

# As in some datasets, there are many 0 variables, some plots have NaN (in omnivore, many plots)
# NaN occur if there are no occurrences of any species in both plots. Therefore, I will replace NaN values with 0, using 
# this function in the for loop
remove_nan <- function(x){
  x[is.nan(x)] <- 0
  return(x)
}

if(typeofbeta == "presence_absence"){
  beta_pa <- vector() # either beta_pa or beta_abund
  for(i in trnames){
    set <- get(i)
    name <- paste('beta_pa',i,sep='_') # beta_pa stands for "presence-absence" ; beta_abund for "abundance"
    result <- beta.pair(set, index.family="sorensen")
    result <- lapply(result,as.matrix)
    result <- lapply(result, function(x) cbind("Plot" = seq(1,130,by=1),x))
    result <- lapply(result, function(x) remove_nan(x))
    assign(name, result)
    beta_pa <- append(beta_pa , name)
  }
  rm(set) ; rm(name) ; rm(result) ; rm(i)
}

######################################
# 4. RUN BETAPART abundance          #
######################################
# to run this part, change the variable typeofbeta to "abundance"

# As in some datasets, there are many 0 variables, some plots have NaN (in omnivore, many plots)
# NaN occur if there are no occurrences of any species in both plots. Therefore, I will replace NaN values with 0, using
# the function made under presence absence.
if(typeofbeta == "abundance"){
  beta_abund <- vector()
  for(i in trnames){
    set <- get(i)
    name <- paste('beta_abund',i,sep='_') # beta_pa stands for "presence-absence" ; beta_abund for "abundance"
    result <- beta.pair.abund(set, index.family = "bray")
    result <- lapply(result,as.matrix)
    result <- lapply(result, function(x) cbind("Plot" = seq(1,130,by=1),x))
    result <- lapply(result, function(x) remove_nan(x))
    assign(name, result)
    beta_abund <- append(beta_abund , name)
  }
  rm(set) ; rm(name) ; rm(result) ; rm(i)
}

######################################
# 5. CLEANING THE RESULTS            #
######################################
# remove original data
rm(autotroph) ; rm(belowground.herbivore) ; rm(belowground.predator) ; rm(decomposer) ; rm(herbivore) ; rm(microbe.decomposer)
rm(plant.pathogen); rm(protist) ; rm(secondary.consumer) ; rm(soilfungi.decomposer) ; rm(soilfungi.pathogen)
rm(symbiont) ; rm(tertiary.consumer) ; rm(vert.herb) ; rm(plots) ; rm(uncommon.plots)
# remove unwanted vector
rm(plot_NAset) ;  rm(trnames) ; rm(typeofbeta)
gc()
```

