---
title: "From Diversity to Betadiversity"
author: "Noelle Schenk, Caterina Penone"
date: "May 7, 2019"
output: html_document
---
*requires* : 
- datasets : spdiv, spinfo (spinfo is the file containing information about all species, spdiv is the collected data.)
- plotNAset (the names of plots which are included)

# Load and merge dataset
Note : this script is based on the Exploratoreis diversity dataset, which is read in with the script `analysis_nonpublic.R`. It reads in the two datasets `spdiv` and `spinfo`.

## Dataset Cleaning
From cleaning, getting numbers : 
- 202944 species in the dataset
- 20 different trophic levels
- type = presenceabsence : plant pathogen, ant omnivore

```{r}
require(betapart) # needed in order to run beta.pair_zerospecies()

# delete Plot_bexis (old plot names)
spdiv[, Plot_bexis := NULL]
# spdiv[, c("Dataversion", "DataID") := NULL]
spdiv <- merge(spdiv, spinfo, by = "Species", all.x=T)
# This analysis requires complete data (NA s in the diversity data can not be accepted because 
# they can not be imputed).
# Therefore remove all rows with NA.
spdiv <- spdiv[!is.na(value)]

# Set to presence-absence
spdiv[value != 0, value := 1]

# now I can remove the original datasets, so I save cpu:
rm(spinfo); gc()
```


# Select trophic levels
Group to 18 trophic levels as needed for analysis. (see also `info_diversity.ods`)
```{r}
#TODO DIESES SKRIPT
# - übersichten über die trophic levels, number of species etc. ev. nach unten schieben --> 
#    zu dem Part, wo das Diversity dataset parat ist.

# # rename trophic levels with names from the previous version of the diversity dataset
# # (old ID : 190802, new ID : 201124)
# spdiv <- merge(spdiv, names_trlevel, by = "Trophic_level", all.x = T)
# spdiv[, Trophic_level := NULL]
# setnames(spdiv, old = "old_Trophic_level", new = "Trophic_level")
#TODO change names or NOT? if not, delete this chunk and the dataset names_trlevel

# take out trophic levels which are not used in analysis
# not looked at in this script
exclude <- c("unknown.protist", "unknown.soilfungi", "unknown.acari", "herbivore.bird", "protist.parasite.nonplant", "mainlybacterivore.protist", "decomposer.collembola")
# herbivore.bird, former vertebrate herbivore vert.herb : only 104 plots
# protist.parasite.nonplant :  probably wise to remove, we don't expect to affect any function directly
# mainlybacterivore.protist : less studied --> less information about their roles. expected to 
#      have similar role than bacterivores.
# decomposer.collembola : data from 2019, newer than the newest function (from 2017)

# take out trophic leels which are not used in analsis
# but are looked at in this script (can be outcommented to reproduce reason of exclusion)
exclude <- c(exclude, "pollinator.arthropod", "omnivore.snail", "omnivore.ant", "omnivore.arthropod", "decomposer.arthropod", "decomposer.acari", "decomposer.myriapod", "carnivore.acari", "herbivore.snail")
#TODO pollinator.arthropod : TODO (note : there is code for it in this script)
# omnivores : represent interactions between secondary.consumers and herbivores
# carnivore.acari : only 1 species
# herbivore.snail : too few plots
# decomposers : from 2019, functions are until 2017 - too young.

spdiv <- spdiv[!Trophic_level %in% exclude, ]
```

overview dataset
```{r, eval=F}
unique(spdiv[, .(Trophic_level, Year)])
length(unique(spdiv$Species)) # 183388 species in the dataset (incl. OTU)
# Get overview of amount of species per trophic level
for(t in unique(spdiv$Trophic_level)){
  print(c(t, length(unique(spdiv[Trophic_level == t, Species]))))
}
```
[1] "bacteria.RNA" "174945"      
[1] "herbivore.arthropod" "401"                
[1] "autotroph" "495"      
[1] "tertiary.consumer.birdbat" "78"                       
[1] "secondary.consumer.arthropod" "170"                         
[1] "plantpathogen.fungi" "84"                 
[1] "secondary.consumer.arthropodsoillarvae" "17"                                    
[1] "herbivore.arthropodsoillarvae" "11"                           
[1] "secondary.consumer.myriapod" "4"                          
[1] "omnivore.protist" "444"             
[1] "eukaryvore.protist" "217"               
[1] "plantparasite.protist" "96"                   
[1] "bacterivore.protist" "886"                
[1] "decomposer.soilfungi" "4069"                
[1] "symbiont.soilfungi" "1010"              
[1] "pathotroph.soilfungi" "461"  


Store trophic levels in vector
```{r}
trlevels <- sort(unique(spdiv$Trophic_level))
# store complete set of plots
all_plots <- unique(spdiv$Plot)
```


# Check if diversity across years is correlated
Create new column with trophic level and year
```{r, eval=F}
#TODO : move this chunk below
spdiv[, trlevel_year := paste(Trophic_level, Year, sep = "")]
```
Correlation plot of all trophic levels and years? Or better betadiversity among years?
```{r, eval=F}
# m <- cor(spdiv[, .(Species, value, trlevel_year)], use = "pariwise.complete.obs")
# 
# M <- cor(small_grlfuns[, !colnames(grlfuns) %in% c("Explo","Plotn", "Plot"), with=F], use="pairwise.complete.obs")
# corrplot::corrplot(M,type="lower",addCoef.col = "black",method="color",diag=F, tl.srt=1, tl.col="black", mar=c(1,0,1,0), number.cex=0.6)

# testing with 1 trophic level, 2 years
# for presence absence
#TODO : rename tertiary.consumer to tertiary.consumer.birdbat
for(trlevel in c("autotroph", "secondary.consumer", "tertiary.consumer.birdbat")){
  pdf(paste("corr_diversity_across_years_", trlevel, ".pdf", sep=""), paper = "a4r")
  par(mfrow=c(12,12))
  test <- spdiv[Trophic_level == trlevel, .(Species, value, trlevel_year, Plot, Year)]
  for(p in unique(test$Plot)){
    a <- data.table::dcast.data.table(test[Plot == p], Year ~ Species, fill = 0)
    a[is.na(a)] <- 0
    a <- t(a)
    colnames(a) <- a[1,]
    a <- a[-1,]
    a <- apply(a, 2, as.numeric)
    # corrplot::corrplot(cor(a), type="lower", diag = F)
    a[a != 0] <- 1
    if(sum(is.na(cor(a))) >= 1) next
    corrplot::corrplot(cor(a), type="lower", diag = T, method = "square", tl.col = "black", order = "alphabet", tl.cex = 0.7, main = p)
  }
  dev.off()
}
# note : not possible OTU, because it can't be compared across years. The OTU identities always change.
# note : omnivore, herbivores different years are different species --> no overlap

# tertiary consumers : special case. take the 67 species measured in 2008, 2011 and 2012 and take the 11 suppl. species out of years 2009 and 2010.
tert <- spdiv[Trophic_level == "tertiary.consumer", .(Species, value, trlevel_year, Plot, Year)]
# find the 11 species which are only present in 2009 and 2010
unique(tert[Year == "2009", Species])[which(!unique(tert[Year == "2009", Species]) %in% unique(tert[Year == "2008", Species]))]
```



# Clean Diversity data
Combine years if possible, check presence of species and if a given group of species can be included in the analysis or not.

## autotrophs
Years 2008 to 2016.
Lichens and Bryophytes only 2009 (119 species, 137 plots)

year   |  no. species | no. Plots |
-------| ------------ | --------- |
2008   |   342        |  147      |
2009   |   485        |  150      |
2009 l |   119        |  150      | lichen & bryophyte dataset
2009 p |   342        |  150      |
2010   |   342        |  150      |
2011   |   342        |  150      |
2012   |   342        |  149      |
2013   |   342        |  149      |
2014   |   342        |  148      |
2015   |   342        |  150      |
2016   |   342        |  150      |

```{r}
autotroph <- spdiv[Trophic_level == "autotroph"]
autotroph <- autotroph[Year %in% c("2009", "2008", "2010", "2011", "2012", "2013", "2014", "2015", "2016")]
autotrophnew <- spdiv[Trophic_level == "autotroph" & Year %in% c("2017", "2018")]
# find the species in autotroph which are never present in the years
test <- data.table::data.table(aggregate(value ~ Species, autotroph, sum))
exclude <- test[value == 0, Species]
# exclude them from the analysis
autotroph <- autotroph[!Species %in% exclude]

# get numbers for table above :
# how many species and how many plots were measured in the different years?
# length(unique(autotroph[Year == "2008", Plot])) # Changed year and tested for all years for reporting in the table

# get vector with lichen species to examine lichens separately
lichenspecies <- setdiff(unique(autotroph[Year == "2009", Species]), unique(autotroph[Year == "2008", Species]))
  # examine lichens and plants separately - same number of plots and expected number of species?
length(unique(autotroph[!Species %in% lichenspecies, Species]))
length(unique(autotroph[!Species %in% lichenspecies, Plot]))
```
*Plots identities*
```{r, eval=F}
# are the same plots missing in all years?
testplotpresence <- unique(autotroph[, .(Year, Plot)])
visdat::vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
# no, different plots are missing.
rm(testplotpresence)
```

```{r, eval = T}
# note : this chunk depends on plotNAset, which is not available from the first round on. (is created by this script and updated by another later. (circularity in scripts))
# are the same plots missing in all years?
testplotpresence <- unique(autotroph[Plot %in% plotNAset, .(Year, Plot)])
visdat::vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
# no, different plots are missing.
rm(testplotpresence)
```

If a plant species is present in at least 1 year, it is considered to be present. Underlying assumption : plant species composition is quite stable, therefore it is representative to assess their presence in a large time span.

If a plant species is missing in a year, rather the year than the plot is removed. Underlying assumption : if a plot is missing a year, the diversity was not measured as many times as in the other plots.

Years 2009, 2010, 2011, 2015, 2016 are complete.

Assessing presence of plant species in all years. Lichen and Bryophyte species are taken directly from year 2009, as this is the only year.
```{r}
autotroph <- autotroph[Year %in% c("2009", "2010", "2011", "2015", "2016")]
plants <- autotroph[!Species %in% lichenspecies, ]
lichens <- autotroph[Species %in% lichenspecies,]
# if a species is present in at least one year, it is considered to be present
# calculate the mean of all value (species presence/ absence). If it is not zero, the species was present in at least one year and the value can be set to 1.
plants <- aggregate(value ~ Species + Plot, plants, function(x) mean(x, na.rm=T))
plants <- data.table::data.table(plants)
# nrow(plants) == 342*150 # TRUE : there are 342 species per plot in the new dataset
# Check how many plant species have been present / absent in how many years
hist(plants$value, main="Presence of plant species among years", sub="The plot indicates if a plant species was either present in no year, \n in 1 years , ... , in all 9 years. Most species are never present", xlab = "")

# set the numbers which are not 0 or 1 to 1 (if value > 0, that means that plant has been present at least in one year)
plants[value != 0, value := 1]

# add the lichens dataset to the plants dataset
autotroph <- rbind(plants, lichens[, .(Species, Plot, value)])
nrow(autotroph) == 150 * 342 + 150 * 119 # TRUE : there are 119 lichen and 342 plant species in all 150 plots.
```

```{r}
hist(autotroph$value)
hist(lichens$value)
hist(plants$value)
```
Although working with a range of 5 years, still many plant species are not present in many plots. This indicates that the assumption of stable autotroph species was correct.

```{r}
# remove lichens and plants, not used any more
rm(plants) ; rm(lichens); rm(lichenspecies); rm(autotrophnew)
# take out autotrophs from spdiv
spdiv <- spdiv[!Trophic_level == "autotroph"]
```



## herbivore
candidates to include : herbivore.arthropod and herbivore.snail
*note*: code with `eval=F` is describing the reasons why a specific group of species is excluded or included.
```{r}
herbivore <- spdiv[Trophic_level %in% c("herbivore.arthropod", "herbivore.snail")]
```
first check plot set for arthropods, then check which plots are covered by snail data as well.

### herbivore.arthropod
consist of 4 groups ("Hemiptera"   "Coleoptera"  "Hymenoptera" "Orthoptera"), some contain missing plots. Chose the plot intersect with complete coverage.
```{r, eval = F}
# Arthropod herbivores consist of 3 Groups, 2 of them contain missing data, one not.
# We can only take the plots present in all groups --> reduce the number of plots
unique(herbivore[Trophic_level == "herbivore.arthropod", Group_fine])
length(unique(herbivore[Trophic_level == "herbivore.arthropod" & Group_fine == "Hemiptera", Species]))
```
| Dataset    | Hemiptera | Coleoptera  | Hymenoptera | Orthoptera |
| --------   | --------- |------------ |------------ |----------- |
| no Plots   |  139      |     139     |   139       |  139       |
| no Species |  197      |     182     |    4        |  16        |

```{r, eval = F}
testplotpresence <- unique(herbivore[Group_fine == "Hymenoptera", .(Species, Plot)])
visdat::vis_miss(data.table::dcast(testplotpresence, Plot ~Species))
rm(testplotpresence)
```

```{r}
# Get subset of plots (intersect) which is present in all arthropod groups (which plots contain full species data?)
arthro_plotset <- intersect(
  unique(herbivore[Trophic_level == "herbivore.arthropod" & Group_fine == "Hemiptera", Plot]),
  unique(herbivore[Trophic_level == "herbivore.arthropod" & Group_fine == "Orthoptera", Plot]))
arthro_plotset <- intersect(arthro_plotset,
  unique(herbivore[Trophic_level == "herbivore.arthropod" & Group_fine == "Hymenoptera", Plot])
)
arthro_plotset <- intersect(arthro_plotset,
  unique(herbivore[Trophic_level == "herbivore.arthropod" & Group_fine == "Coleoptera", Plot])
)

# check if the plot set is consistent
sum(arthro_plotset != unique(herbivore[Year == "2008" & Group_fine == "Hemiptera", Plot])) # all the same
sum(arthro_plotset != unique(herbivore[Year == "2008" & Group_fine == "Coleoptera", Plot])) # all the same

# Exclude the plots which are to exclude from arthropods (only arthropods so snails can be checked independently, although this would not be necessary).
herbivore <- herbivore[Plot %in% arthro_plotset & Trophic_level == "herbivore.arthropod" | Trophic_level == "herbivore.snail", ]
rm(arthro_plotset)
```

### herbivore.snail
```{r, eval=F}
testplotpresence <- unique(herbivore[, .(Trophic_level, Plot)])
visdat::vis_miss(data.table::dcast(testplotpresence, Plot ~Trophic_level))
rm(testplotpresence)
```
Snails were only measured in 134 plots. They contain 39 species. Insects were measured in 134 plots, they contain 401 species.
Snails seem to be missing mostly in one region : in SEG, 16 plots are missing, no missings in the other regions.
```{r, eval = F}
length(grep("AEG", unique(herbivore[Trophic_level == "herbivore.snail", Plot]), value = T)) # 50
length(grep("SEG", unique(herbivore[Trophic_level == "herbivore.snail", Plot]), value = T)) # 34
length(grep("HEG", unique(herbivore[Trophic_level == "herbivore.snail", Plot]), value = T)) # 50
```

Only 124 plots contain both arthropods and snails.
```{r, eval=F}
length(unique(herbivore[Trophic_level == "herbivore.arthropod", Species])) # 399
length(intersect(herbivore[Trophic_level == "herbivore.arthropod", Plot], herbivore[Trophic_level == "herbivore.snail", Plot])) # 124
```

| Year       |  2008    |  2017   | both   |
| Group      | insects  | snails  | both   |
| ---------- | -------- | ------- | ------ |
| no Plots   |   139    |  134    |  124   |
| no Species |   399    |   39    |  438   |

Too many missing plots in snails, and too few species. Take arthropod dataset only.
```{r}
herbivore.arthropod <- herbivore[Trophic_level == "herbivore.arthropod", .(Species, Plot, value)]
nrow(herbivore.arthropod) == 139 * 399 # 399 species in 139 plots present . If number is not correct, some species were not measured in all plots.
# remove from spdiv
spdiv <- spdiv[!Trophic_level == "herbivore.arthropod"]

# summary : 399 species in 139 plots
```



## Omnivore REMOVED
Consists of arthropods dataset from 2008, ants dataset from 2014_2015, and snails dataset from 2017.
Removed biologically because they represent the interaction of herbivores and secondary consumers in the analysis. Including them makes it more difficult to differentiate between herbivores and carnivores.
```{r, eval = F}
omnivore <- spdiv[Trophic_level %in% c("omnivore.arthropod", "omnivore.ant", "omnivore.snail")]
testplotpresence <- unique(omnivore[, .(Year, Plot)])
# testplotpresence <- unique(omnivore[Plot %in% plotNAset, .(Year, Plot)])
visdat::vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
rm(testplotpresence)
```
Many plots are missing.

*note* : some details of the table might have changed after the last update of the diversity dataset. The main message remains the same.

subset     |  arthropods  | ants   | snails  |  all  |  arth&sn  | 
---------- | ------------ | ------ | ------- | ----- | --------- |
Year       |    2008      | 14 15  |  2017   | all   | 08 & 17   |
no Plots   |     139      |  110   |  134    |  97   |  124      |
no Species |     14       |  20    |  21     |  55   |  35       |

```{r, eval = F}
# length(intersect(omnivore[Year == "2008", Plot], omnivore[Year == "2017", Plot]))
# length(intersect(intersect(omnivore[Year == "2008", Plot], omnivore[Year == "2017", Plot]), omnivore[Year == "2014_2015", Plot]))
```
Only took the arthropod dataset, as snails and ants have too many missing plots.
```{r, eval = F}
omnivore <- omnivore[Year == "2008", .(Species, Plot, value)]
# omnivore_ant <- omnivore[Year == "2014_2015", .(Species, Plot, value)]
# omnivore_snail <- omnivore[Year == "2017", .(Species, Plot, value)]
nrow(omnivore) == 139 * 14 # expected number of rows present
# many plots do not contain any species - take out
test <- aggregate(value ~ Plot, omnivore, sum)
barplot(height = test$value)
abline(h = mean(test$value), col = "red")
abline(h = median(test$value), col = "green")

print(test$Plot[which(test$value == 0)])
rm(omnivore)
```


## Secondary consumers
arthropods (2008) and myriapods (2011)
```{r}
secondary.consumer <- spdiv[Trophic_level %in% c("secondary.consumer.arthropod", "secondary.consumer.myriapod")]
myria.sc <- spdiv[Trophic_level == "secondary.consumer.myriapod"]

testplotpresence <- unique(secondary.consumer[, .(Trophic_level, Plot)])
# testplotpresence <- unique(secondary.consumer[Plot %in% plotNAset, .(Year, Plot)])
visdat::vis_miss(data.table::dcast(testplotpresence, Plot ~Trophic_level))
rm(testplotpresence)
```
Only arthropods dataset has some missing values

```{r, eval=F}
# length(unique(secondary.consumer[Trophic_level == "secondary.consumer.arthropod", Species]))
# any(unique(secondary.consumer[Trophic_level == "secondary.consumer.arthropod", Species]) %in% unique(secondary.consumer[Trophic_level == "secondary.consumer.myriapod", Species]))
```
  Year     | arthropods  |  myriapods |
---------- | ----------- |  --------- |
no Plots   |      139    |      150   |
no Species |      170    |       4    |

Species set does not overlap.

Select the arthropod Plots and remove the missing plots from myriapods.
```{r}
sc_plotset <- unique(secondary.consumer[Trophic_level == "secondary.consumer.arthropod", Plot])
secondary.consumer <- secondary.consumer[Plot %in% sc_plotset, .(Species, Plot, value)]
nrow(secondary.consumer) == 139 * 174  # expected number of rows present
spdiv <- spdiv[!Trophic_level == "secondary.consumer.arthropod"]
spdiv <- spdiv[!Trophic_level == "secondary.consumer.myriapod"]

trlevels <- c(trlevels[-grep("secondary.consumer", trlevels)], "secondary.consumer", "secondary.consumer.arthropodsoillarvae")
```


## Tertiary consumer
only included birds, not bats. Bats are not expected to have direct effects on any of the included functions. (Tested with analysis, putting them together explains much more variance and possibly "unmasks" the "true bird effect".)
```{r, eval = T}
tertiary.consumer <- spdiv[Trophic_level == "tertiary.consumer.birdbat"]
testplotpresence <- unique(tertiary.consumer[, .(Year, Plot)])
visdat::vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
rm(testplotpresence)
```

   Year    | 2008   |    2009    |    2010    |   2011  |   2012   |
---------- | ------ | ---------- | ---------- | ------- | -------- |
subset     | birds  | birds bats | birds bats |  birds  |  birds   |
no Plot    |  150   |  150+149   |  150+150   |  150    |  150     |
no Species |  67    | 78= 67+11  | 78= 67+11  |  67     |  67      |

```{r, eval = F}
# unique(tertiary.consumer[Year == "2011", Group_fine])
# length(unique(tertiary.consumer[Year == "2009", Plot]))

# length(intersect(unique(tertiary.consumer[Year == "2009", Species]), unique(tertiary.consumer[Year == "2010", Species])))
# batspecies <- setdiff(unique(tertiary.consumer[Year == "2009", Species]), unique(tertiary.consumer[Year == "2011", Species]))
```
The Bird and Bat species of the different years are the same.

Take average of Species occurrence and check how often species occur. We assume that birds and bats are difficult to measure, therefore having a large time window makes sense. A species is considered to be present in a plot, if it is present at least in one year.
```{r, eval = T}
birds <- aggregate(value ~ Species + Plot, tertiary.consumer[Group_fine == "Birds"], function(x) mean(x, na.rm=T)) # combine years
birds <- data.table::data.table(birds)
# nrow(birds) == 67 * 150 # TRUE : 67 species in 150 plots
hist(birds$value, main="Presence of bird species among years")
# If species is present at least in one year, take it as present
birds[value > 0, value := 1]
nrow(birds) == 67 * 150 # still expected number of rows present (67 species in 150 plots)

tertiary.consumer <- data.table::copy(birds)
rm(birds); gc()

nrow(tertiary.consumer) == 150 * (67)

# find plots with 0 species, but don't remove
# test <- data.table::data.table(aggregate(value ~ Plot, tertiary.consumer, sum))
# barplot(height = test$value)
# test[value == 0, Plot] # 5 plots with 0 species

nrow(tertiary.consumer) == 150*67 # expected number of rows present
```
check betadiversity
```{r,eval = F}
# check betadiversity
beta.tertiary.consumer <- prepare_for_betapair(tertiary.consumer)
beta.tertiary.consumer <- BetaDivMultifun::beta.pair_zerospecies(beta.tertiary.consumer, index.family = "sorensen")
test <- beta.tertiary.consumer$beta.sor
test <- as.matrix(test)
test[!lower.tri(test)] <- 1000
test <- reshape2::melt(test, value.name = "tertiary.consumer")
test <- data.table(test)
test <- test[!tertiary.consumer == 1000, ]
plot(test$tertiary.consumer)
# check the betadiversiy = 0 cases
test[tertiary.consumer == 0, ] # 33 such cases.
all(tertiary.consumer[Plot %in% c("AEG06"), Species] == tertiary.consumer[Plot %in% c("AEG23"), Species])
# plot comparisons with 0 betadiversity both contain all species
rm(test)
```

```{r}
trlevels[which(trlevels == "tertiary.consumer.birdbat")] <- "tertiary.consumer"
spdiv <- spdiv[!Trophic_level == "tertiary.consumer.birdbat"]
```


## Bacteria RNA

```{r}
bacteria.RNA <- spdiv[Trophic_level == "bacteria.RNA"]
# bacteria.RNA <- add_back_missing_plots_species_combinations(bacteria.RNA, all_plots) # 23276560 missing combinations were added.
testplotpresence <- unique(bacteria.RNA[, .(Year, Plot)])
visdat::vis_miss(data.table::dcast(testplotpresence, Plot ~ Year))
rm(testplotpresence)
```
Not visible in the plot, but there are only 148 plots for both years.

Check if OTU names are the same in both years. No obvious overlap.
```{r, eval=F}
grep("01ece679a6294aadf97b931ce39a539a", bacteria.RNA$Species, value = T)
unique(bacteria.RNA[grep("01ece679a6294aadf97b931ce39a539a", bacteria.RNA$Species), Year]) # species present in both years
```

The OTUs can be compared across the years. However, we will only work with the 2011 dataset in order to be more consistent with the years.
Replace the prefix by bac_ instead of bac11_ and bac14_

|    year    |  2011   |  2014     |  2011 & 14 |
| ---------- | ------- | --------- | -----------|
| no Plots   |   148   |   148     |   148      |
| no OTUs    |  140510 |  139691   |   174945   |

```{r, eval=F}
length(unique(bacteria.RNA[Year == "2014", Species])) # 139691
length(setdiff(unique(bacteria.RNA[Year == "2011", Species]), unique(bacteria.RNA[Year == "2014", Species]))) # 35254 unique to 2011, 34435 unique to 2014
length(intersect(unique(bacteria.RNA[Year == "2011", Species]), unique(bacteria.RNA[Year == "2014", Species]))) # 105256 present in both years

grid::grid.newpage()
VennDiagram::draw.pairwise.venn(area1 = 34435 + 105256, area2 = 35254 + 105256, cross.area = 105256, category = c("2014 OTU", "2011 OTU"))
# approx. overlap of 3/4
```
Select 2011 dataset.
```{r}
bacteria.RNA <- bacteria.RNA[Year == "2011", .(Species, Plot, value)]
# The bacteria RNA dataset had been reduced: all species-plot combinations with 0 were removed.
# reconstruct them (code from Caterina, see https://github.com/biodiversity-exploratories-synthesis/Synthesis-dataset-manual/blob/main/Synthesis%20datasets%20%20How%20to%20use.md under "Missing" zeros)
# 2 plots are missing, exclude them (AEG33 and AEG34)
bac_plots <- all_plots[-which(all_plots %in% c("AEG33", "AEG34"))]
bacteria.RNA <- add_back_missing_plots_species_combinations(bacteria.RNA, bac_plots) # 19052152 missing combinations were added.
rm(bac_plots)

nrow(bacteria.RNA) == 148 * 140510 # expected number of plots present
spdiv <- spdiv[!Trophic_level == "bacteria.RNA"]
```


## protist.bacterivore
2011, 2017 datasets
```{r}
protist.bacterivore <- spdiv[Trophic_level == "bacterivore.protist"]
testplotpresence <- unique(protist.bacterivore[, .(Year, Plot)])
visdat::vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
rm(testplotpresence)
```
Only 1 plot missing, in 2011

Are the OTU the same across years?
Datasets 2011 and 2017 are comparable with each other.
```{r, eval=F}
length(setdiff(unique(protist.bacterivore[Year == "2011", Species]), unique(protist.bacterivore[Year == "2017", Species])))
length(intersect(unique(protist.bacterivore[Year == "2017", Species]), unique(protist.bacterivore[Year == "2011", Species])))
length(unique(protist.bacterivore[Year == "2011", Plot]))
length(unique(protist.bacterivore[, Species]))
```

|    year    | 2011    |  2017  | 2011 2017 |
| ---------- | ------- | ------ | --------- |
| no Plots   |   149   |   150  |    150    |
| no OTUs    |   886   |   886  |    886    |

For BetaDivMultifun, only year 2011 is chosen : 
```{r}
bacterivore.protist <- protist.bacterivore[Year == "2011", .(Species, Plot, value)]
nrow(bacterivore.protist) == 149 * 886 # TRUE : The expected number of rows is present.
spdiv <- spdiv[!Trophic_level == "bacterivore.protist"]
rm(protist.bacterivore)
```



## protist.eukaryvore
```{r}
protist.eukaryvore <- spdiv[Trophic_level == "eukaryvore.protist"]
testplotpresence <- unique(protist.eukaryvore[, .(Year, Plot)])
visdat::vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
rm(testplotpresence)
```
Only 1 plot missing, in 2011.

```{r, eval=F}
# interchange intersect with setdiff and modify years to obtain values in table below
# length(intersect(unique(protist.eukaryvore[Year == "2017", Species]), unique(protist.eukaryvore[Year == "2011", Species])))
length(unique(protist.eukaryvore[Year == "2017", Plot]))
```

|   Year   |   2011   |  2017  |  both    |
| -------- | -------- | ------ | -------- |
| no Plots |   149    |  150   |    150   |
| no OTUs  |   217    |  217   |    217   |

For BetaDivMultifun, only year 2011 is chosen : 
```{r}
eukaryvore.protist <- protist.eukaryvore[Year == "2011", .(Species, Plot, value)]
nrow(eukaryvore.protist) == 149 * 217 # TRUE : The expected number of rows is present.
spdiv <- spdiv[!Trophic_level == "eukaryvore.protist"]
rm(protist.eukaryvore)
```


## protist.omnivore

```{r}
protist.omnivore <- spdiv[Trophic_level == "omnivore.protist"]
testplotpresence <- unique(protist.omnivore[, .(Year, Plot)])
visdat::vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
rm(testplotpresence)
```
Only 1 plot missing, in 2011.

```{r, eval=F}
# interchange intersect with setdiff and modify years to obtain values in table below
length(intersect(unique(protist.omnivore[Year == "2011", Species]), unique(protist.omnivore[Year == "2017", Species])))
length(unique(protist.omnivore[Year == "2017", Plot]))
length(unique(protist.omnivore[, Plot]))
```

|   Year   |   2011   |  2017  |  both    |
| -------- | -------- | ------ | -------- |
| no Plots |   149    |  150   |    150   |
| no OTUs  |   444    |  444   |    444   |

Only Year 2011 is chosen.
```{r}
omnivore.protist <- protist.omnivore[Year == "2011", .(Species, Plot, value)]
nrow(omnivore.protist) == 149 * 444 # expected number of rows is present
spdiv <- spdiv[!Trophic_level == "omnivore.protist"]
rm(protist.omnivore)
```



## protist.plant.parasite

```{r}
protist.plant.parasite <- spdiv[Trophic_level == "plantparasite.protist"]
testplotpresence <- unique(protist.plant.parasite[, .(Year, Plot)])
visdat::vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
rm(testplotpresence)
```
Only 1 plot missing, in 2011.

```{r, eval=F}
# interchange intersect with setdiff and modify years to obtain values in table below
length(intersect(unique(protist.plant.parasite[Year == "2017", Species]), unique(protist.plant.parasite[Year == "2011", Species])))
length(unique(protist.plant.parasite[Year == "2017", Species]))
```

|   Year   |   2011   |  2017  |  both    |
| -------- | -------- | ------ | -------- |
| no Plots |   149    |  150   |    149   |
| no OTUs  |   96     |   96   |     96   |

Only 2011 is chosen
```{r}
plantparasite.protist <- protist.plant.parasite[Year == "2011", .(Species, Plot, value)]
nrow(plantparasite.protist) == 149 * 96
spdiv <- spdiv[!Trophic_level == "plantparasite.protist"]
rm(protist.plant.parasite)
```


## decomposer.soilfungi
Years 2011, 2014, 2017
```{r}
decomposer.soilfungi <- spdiv[Trophic_level == "decomposer.soilfungi"]
# adding back the missing plot - species combinations . all species-plot combinations with 0 had been removed to store memory. note : only temporarily, after filtering for years, needs to be done again because the function can not add the years to missing combinations.
decomposer.soilfungi <- add_back_missing_plots_species_combinations(decomposer.soilfungi, all_plots)

testplotpresence <- unique(decomposer.soilfungi[, .(Year, Plot)])
visdat::vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
rm(testplotpresence)
```
Check if OTU need renaming and check overlap of OTUs
```{r, eval=F}
length(unique(decomposer.soilfungi[Year == "2011", Species]))
length(setdiff(unique(decomposer.soilfungi[Year == "2017", Species]), unique(decomposer.soilfungi[Year == "2014", Species])))

length(intersect(intersect(unique(decomposer.soilfungi[Year == "2011", Species]), unique(decomposer.soilfungi[Year == "2017", Species])), unique(decomposer.soilfungi[Year == "2014", Species])))
length(intersect(unique(decomposer.soilfungi[Year == "2014", Species]), unique(decomposer.soilfungi[Year == "2017", Species])))
```

|  Year    |  2011  |  2014  |  2017  | 11 14 | 11 17 | 14 17 | all   |
| -------- | ------ | ------ | ------ | ----- | ----- | ------| ----- |
| no Plots |  150   |  150   |  150   |  150  |  150  |   150 |  150  |
| no OTUs  | 2332   | 1971   |  2353  | 1102  | 1245  |  1146 |  906  |

Only year 2011 is chosen
```{r}
decomposer.soilfungi <- decomposer.soilfungi[Year == "2011", .(Species, Plot, value)]
# nrow(decomposer.soilfungi) # 8783
decomposer.soilfungi <- add_back_missing_plots_species_combinations(decomposer.soilfungi, all_plots)
#nrow(decomposer.soilfungi) # 349800
nrow(decomposer.soilfungi) == 150 * 2332 # TRUE : all expected rows are present
spdiv <- spdiv[!Trophic_level == "decomposer.soilfungi"]
```


## pathotroph.soilfungi
2011, 2014, 2017

```{r}
pathotroph.soilfungi <- spdiv[Trophic_level == "pathotroph.soilfungi"]
pathotroph.soilfungi <- add_back_missing_plots_species_combinations(pathotroph.soilfungi, all_plots)
testplotpresence <- unique(pathotroph.soilfungi[, .(Year, Plot)])
visdat::vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
rm(testplotpresence)
```
missing plots in 2014
```{r, eval=F}
# code to fill table below
length(unique(pathotroph.soilfungi[Year == "2017", Species]))
length(setdiff(unique(pathotroph.soilfungi[Year == "2017", Species]), unique(pathotroph.soilfungi[Year == "2011", Species])))

length(intersect(intersect(unique(pathotroph.soilfungi[Year == "2011", Species]), unique(pathotroph.soilfungi[Year == "2017", Species])), unique(pathotroph.soilfungi[Year == "2014", Species])))
```
|  Year    |  2011  |  2014  |  2017  |  11 14   | 11 17  | 14 17 | all  |
| -------- | ------ | ------ | ------ | ---------| ------ | ------| ---- |
| no Plots |  150   |  145   |  150   |   150    |  150   |  150  | 150  |
| no OTUs  |  285   |  222   |  277   |   132    |  155   |  149  | 113  |

Only 2011 data is used here.
```{r}
pathotroph.soilfungi <- pathotroph.soilfungi[Year == "2011", .(Species, Plot, value)]
# after filtering for year, need to add missing plot x species combinations again
pathotroph.soilfungi <- add_back_missing_plots_species_combinations(pathotroph.soilfungi, all_plots = all_plots)
nrow(pathotroph.soilfungi) == 150 * 285 # TRUE : all expected rows present
spdiv <- spdiv[!Trophic_level == "pathotroph.soilfungi"]
```


## symbiont.soilfungi

2011, 2014, 2017
```{r}
symbiont.soilfungi <- spdiv[Trophic_level == "symbiont.soilfungi"]
symbiont.soilfungi <- add_back_missing_plots_species_combinations(symbiont.soilfungi, all_plots)
testplotpresence <- unique(symbiont.soilfungi[, .(Year, Plot)])
visdat::vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
rm(testplotpresence)
```
several missing plots x species combinations in all years, but no NA values.
```{r, eval=F}
length(unique(symbiont.soilfungi[Year == "2017", Species]))

length(setdiff(unique(symbiont.soilfungi[Year == "2011", Plot]), unique(symbiont.soilfungi[Year == "2014", Plot])))

length(intersect(intersect(unique(symbiont.soilfungi[Year == "2011", Species]), unique(symbiont.soilfungi[Year == "2017", Species])), unique(symbiont.soilfungi[Year == "2014", Species])))
```
|  Year    |  2011  |  2014  |  2017  |  11 14   | 11 17  | 14 17 | all  |
| -------- | ------ | ------ | ------ | ---------| ------ | ------| ---- |
| no Plots |  142   |  140   |  148   |   133    |  141   |  139  | 133  |
| no OTUs  |  385   |  560   |  378   |   141    |  113   |  139  |  80  |

Only 2011 is chosen.
```{r}
symbiont.soilfungi <- symbiont.soilfungi[Year == "2011", .(Species, Plot, value)]
# adding back missing plot-species combinations (code from Caterina)
symbiont.soilfungi <- add_back_missing_plots_species_combinations(symbiont.soilfungi, all_plots)
length(unique(symbiont.soilfungi$Plot)) == 150

nrow(symbiont.soilfungi) == 150 * 385 # all expected combinations present
spdiv <- spdiv[!Trophic_level == "symbiont.soilfungi"]
```



# check and select trophic levels with only one year

## belowground herbivore

```{r}
belowground.herbivore <- spdiv[Trophic_level == "herbivore.arthropodsoillarvae",]
# testplotpresence <- unique(belowground.herbivore[, .(Year, Plot)])
# visdat::vis_miss(data.table::dcast(testplotpresence, Plot ~Year))
# rm(testplotpresence)
# length(unique(belowground.herbivore$Species)) # 11 species
nrow(belowground.herbivore) == 150 * 11 # expected number of rows present
```
All plots are present, only one year (simple situation - no plot is shown).
```{r, eval=F}
hist(belowground.herbivore$value, main="Presence of belowground herbivores, 11 species", sub="The plot indicates that most species - Plot combinations are not present. This is a first indicator for relatively high (acceptable high) beta-diversity.", xlab = "")
```
```{r, eval = T}
bh_overv <- aggregate(value ~ Plot, belowground.herbivore, sum)
barplot(height = bh_overv$value)
abline(h = mean(bh_overv$value), col = "red")
abline(h = median(bh_overv$value), col = "green")
```
Most plots contain 3 species. 5 Plots do not contain any species. No need to remove them from analysis, beta-diversity will be set to 0 or 1 accordingly (see below).

Calculate betadiversity to check wether plots differ in their species composition / turnover.
```{r, eval = F}
beta.belowground.herbivore <- prepare_for_betapair(belowground.herbivore)
beta.belowground.herbivore <- beta.pair_zerospecies(beta.belowground.herbivore, index.family = "sorensen")

corrplot::corrplot(as.matrix(beta.belowground.herbivore$beta.sor),type="lower", method="color", diag=F, mar=c(1,0,1,0), number.cex=0.4, tl.srt = 45, tl.col = "black", tl.cex = 0.5)

corrplot::corrplot(as.matrix(beta.belowground.herbivore$beta.sim),type="lower", method="color", diag=F, mar=c(1,0,1,0), number.cex=0.4, tl.srt = 45, tl.col = "black", tl.cex = 0.5)

corrplot::corrplot(as.matrix(beta.belowground.herbivore$beta.sne),type="lower", method="color", diag=F, mar=c(1,0,1,0), number.cex=0.4, tl.srt = 45, tl.col = "black", tl.cex = 0.5)

# note : betadiversity including plots without species produce NaN. They will be addressed later.

# cleaning
rm(beta.belowground.herbivore)
```
There is definitely some betadiversity among the plots.
```{r}
nrow(belowground.herbivore) == 150 * 11 # expected number of plots present
herbivore.arthropodsoillarvae <- data.table::copy(belowground.herbivore)
rm(belowground.herbivore)
spdiv <- spdiv[!Trophic_level == "herbivore.arthropodsoillarvae"]
```


## belowground predator

```{r}
belowground.predator <- spdiv[Trophic_level == "secondary.consumer.arthropodsoillarvae"]
nrow(belowground.predator) == 17 * 150 # expected number of plots present
```
```{r, eval = T}
bp_overv <- aggregate(value ~ Plot, belowground.predator, sum)
barplot(height = bp_overv$value)
abline(h = mean(bp_overv$value), col = "red")
abline(h = median(bp_overv$value), col = "green")
```
There is 1 plot in belowground predators which does not contain any species.

calc betadiversity and plot
```{r, eval = F}
beta.belowground.predator <- prepare_for_betapair(belowground.predator)
beta.belowground.predator <- beta.pair_zerospecies(beta.belowground.predator, index.family = "sorensen")

corrplot::corrplot(as.matrix(beta.belowground.predator$beta.sor),type="lower", method="color", diag=F, mar=c(1,0,1,0), number.cex=0.4, tl.srt = 45, tl.col = "black", tl.cex = 0.5)

corrplot::corrplot(as.matrix(beta.belowground.predator$beta.sim),type="lower", method="color", diag=F, mar=c(1,0,1,0), number.cex=0.4, tl.srt = 45, tl.col = "black", tl.cex = 0.5)

corrplot::corrplot(as.matrix(beta.belowground.predator$beta.sne),type="lower", method="color", diag=F, mar=c(1,0,1,0), number.cex=0.4, tl.srt = 45, tl.col = "black", tl.cex = 0.5)
# cleaning
rm(beta.belowground.predator)
```
```{r}
nrow(belowground.predator) == 150 * 17 # expected number of rows present
secondary.consumer.arthropodsoillarvae <- data.table::copy(belowground.predator)
spdiv <- spdiv[!Trophic_level == "secondary.consumer.arthropodsoillarvae"]
rm(belowground.predator)
```


## decomposer TAKEN OUT
2008, 2011, 2019
short reason : 2008 and 2011 are not complete enough, 2019 data is too young to include because youngest function is from 2017.
```{r, eval = F}
decomposer <- spdiv[Trophic_level %in% c("decomposer.arthropod", "decomposer.myriapod"), .(Species, Plot, value, Trophic_level, Year)]
```
|   type   | arthropods | arthropods| myriapods |
|          |   2011     |   2019    |           |
| -------- | ---------- | --------- | --------- |
| #species |     40     |     64    |      6    |
| #Plots   |    139     |    141*   |    150    |
*it becomes clear later, that arthropods in 2019 have 9 plots with 0 species --> need to be removed. Edit : no need to remove them any more, set betadiversity to 0 or 1 accordingly.
```{r, eval = F}
length(unique(decomposer[Year == "2019", Species]))

testplotpresence <- unique(decomposer[, .(Trophic_level, Plot)])
visdat::vis_miss(data.table::dcast(testplotpresence, Plot ~Trophic_level))
rm(testplotpresence)
# no missing plots
bp_overv <- data.table(aggregate(value ~ Plot, decomposer[Year == "2019"], sum))
barplot(height = bp_overv$value, main = "species per plot")
abline(h = mean(bp_overv$value), col = "red")
abline(h = median(bp_overv$value), col = "green")
zerospecies <- bp_overv[value == 0, Plot] # 9 plots with 0 species
# Note : no need to take them out
rm(bp_overv)

# how many species were found in 2008 and 2019?
intersect(unique(decomposer[Year == "2008", Species]), unique(decomposer[Year == "2019", Species])) # 0 species

decomposer <- decomposer[Year == "2019"]
decomposer <- decomposer[!Plot %in% zerospecies]# remove the plots without species

rm(zerospecies)
```
```{r, eval = F}
spdiv <- spdiv[!Trophic_level == "decomposer.arthropod"]
spdiv <- spdiv[!Trophic_level == "decomposer.myriapod"]
```


## plant pathogen
Year 2011
```{r}
plantpathogen.fungi <- spdiv[Trophic_level == "plantpathogen.fungi"]
plantpathogen.fungi <- add_back_missing_plots_species_combinations(plantpathogen.fungi, all_plots)
```
```{r}
bp_overv <- data.table::data.table(aggregate(value ~ Plot, plantpathogen.fungi, sum))
barplot(height = bp_overv$value)
abline(h = mean(bp_overv$value), col = "red")
abline(h = median(bp_overv$value), col = "green")
# Note : keep plots without species.
```
84 species in 150 plots
```{r}
length(unique(plantpathogen.fungi$Plot))
nrow(plantpathogen.fungi) == 84 * 150

spdiv <- spdiv[!Trophic_level == "plantpathogen.fungi"]
```


## pollinator REMOVED

```{r, eval = F}
pollinator <- spdiv[Trophic_level == "pollinator.arthropod"]
```
```{r, eval = F}
bp_overv <- aggregate(value ~ Plot, pollinator, sum)
barplot(height = bp_overv$value, ylab = "number of pollinator species per plot")
abline(h = mean(bp_overv$value), col = "red")
abline(h = median(bp_overv$value), col = "green")
```
```{r, eval = F}
pollinator <- pollinator[!Plot %in% bp_overv$Plot[which(bp_overv$value == 0)]]
# fill in missing combinations
pollinator <- data.table::setDT(pollinator)[data.table::CJ(Species=Species,Plot=Plot,unique=T), on=.(Species, Plot)]
pollinator[is.na(value), value := 0 ]
length(unique(pollinator$Species))
nrow(pollinator) == 707 * 144
# cleaning
rm(bp_overv)
```
144 Plots with 707 species.
```{r, eval = F}
spdiv <- spdiv[!Trophic_level == "pollinator.arthropod"]
```

# acari REMOVED
decomposer.acari
```{r, eval = F}
decomp.acari <- spdiv[Trophic_level == "decomposer.acari"]
length(unique(decomp.acari$Plot))

bp_overv <- data.table(aggregate(value ~ Plot, decomp.acari, sum))
barplot(height = bp_overv$value, ylab = "number of pollinator species per plot")
abline(h = mean(bp_overv$value), col = "red")
abline(h = median(bp_overv$value), col = "green")
decomp.acari <- decomp.acari[!Plot %in% bp_overv[value == 0, Plot], ]
rm(bp_overv)
```
46 species, 140 plots


# Find plot Selection
Find subset of plots without missing diversity data and store.

```{r}
rm(spdiv); gc()
#check names of trlevels
names_trlevel <- names_trlevel$final_name
all(names_trlevel[-which(names_trlevel == "")] %in% trlevels) & all(trlevels %in% names_trlevel[-which(names_trlevel == "")]) # same set of names in trlevels
names_trlevel <- names_trlevel[-which(names_trlevel == "")]
```

Select the plots without missing information and store. This chunk of code generates `plotNAset.rds`, the selected set of plots.
```{r, eval=F}
plots <- list()
for(t in trlevels){
  tr <- get(t)
  plots[[t]] <- unique(tr$Plot)
}
common.plots <- Reduce(intersect,plots) # 136 plots
# take out HEG31 because this is taken out in functions
common.plots <- common.plots[-which(common.plots == "HEG31")]
saveRDS(common.plots, file = "plotNAset.rds")

redplotset <- c()
for(t in trlevels){
  redplotset[t] <- length(Reduce(intersect, plots[-which(names(plots) == t)]))
}

# show missing status of all trophic levels
testplotpresence <- data.table(t(rbindlist(lapply(plots, as.data.frame.list), fill = T, use.names = T)))
names(testplotpresence) <- names(plots)
visdat::vis_miss(testplotpresence)

par(mar = c(10, 4.1, 4.1, 2.1))
barplot(redplotset, ylim = c(0, 140), las = 3, cex.names = 0.8, main = "Does removal of given trophic level increase number of plots?")
# abline(h = 114, col = "darkgreen")
abline(h = 136, col = "red")

length(grep("AEG", common.plots))
length(grep("HEG", common.plots))
length(grep("SEG", common.plots))

#TODO : assign plotNAset newly! for the moment : assign by hand : 
plotNAset <- common.plots
```
Inspect common plot set
```{r, eval=F}
paste("AEG :", length(grep("A", common.plots)), "   HEG :", length(grep("H", common.plots)), "    SEG :", length(grep("S", common.plots)), sep = "")
```
| region    | no. plots |
| --------- | --------- |
| all       |    135    |
| AEG       |    42     |
| HEG       |    46     |
| SEG       |    47     |



# Select Plots from diversity datasets
Only keep the selected plots
```{r, eval = F}
if(!length(plotNAset) > 1){plotNAset <- common.plots}
for(t in trlevels){
  tr <- get(t)
  tr <- tr[Plot %in% plotNAset, ]
  assign(t, tr)
}
# take out HEG31, is automatic as soon as the gapfilling is run. 
# that means that this betadiversity script needs to be run twice, once before and once after the gapfilling
```

# overvievs
```{r, eval = F}
sum <- 0
for(t in trlevels){
  tr <- get(t)
  print(paste(t, ": ", length(unique(tr$Species)), "species"))
  sum <- sum + length(unique(tr$Species))
}
sum
```
[1] "autotroph :  461 species"
[1] "bacteria.RNA :  140510 species"
[1] "bacterivore.protist :  886 species"
[1] "decomposer.soilfungi :  2332 species"
[1] "eukaryvore.protist :  217 species"
[1] "herbivore.arthropod :  399 species"
[1] "herbivore.arthropodsoillarvae :  11 species"
[1] "omnivore.protist :  444 species"
[1] "pathotroph.soilfungi :  285 species"
[1] "plantparasite.protist :  96 species"
[1] "plantpathogen.fungi :  84 species"
[1] "symbiont.soilfungi :  385 species"
[1] "tertiary.consumer :  67 species"
[1] "secondary.consumer :  174 species"
[1] "secondary.consumer.arthropodsoillarvae :  17 species"
Total : 146'368 species in the  dataset (5'858 species without bacteria)


# Calculate betadiversities

Set betadiversity to 0 or 1 in case plots do not contain any species, according to e.g. Carlo Ricotta https://doi.org/10.1002/ece3.2980
e.g. Plot "P1" contains 3 species, "P2" and "P3" do not contain any species : 

P1 : 1 1 1 0 0 0 0
P2 : 0 0 0 0 0 0 0
P3 : 0 0 0 0 0 0 0

betadiversity(P1, P2) is set to beta.sne = 1, beta.sim = 0, beta.sor = 1
betadiversity(P2, P3) is set to beta.sor = 0 = beta.sne + beta.sim

This is done by the function `beta.pair_zerospecies()` from this package (`BetaDivMultifun` package)
```{r}
for(t in trlevels){
  tr <- get(t)
  b.tr <- prepare_for_betapair(tr)
  b.tr <- beta.pair_zerospecies(b.tr, index.family = "sorensen")
  trsimname <- paste(t, ".beta.sim", sep = "")
  trnesname <- paste(t, ".beta.sne", sep = "")
  assign(trsimname, b.tr$beta.sim)
  assign(trnesname, b.tr$beta.sne)
}
rm(t); rm(tr); rm(b.tr); rm(trsimname); rm(trnesname)

# prepare for formatesitepair
# convert to long format
trlevels_components <- c(paste(trlevels, ".beta.sim", sep=""), paste(trlevels, ".beta.sne", sep=""))
# create super-dataframe to store all betadiversities
t <- trlevels_components[1] ; tr <- get(t) ; tr <- as.matrix(tr) ; tr[!lower.tri(tr)] <- 1000
tr <- reshape2::melt(tr, value.name = t)
tr <- tr[which(tr[,3] != 1000), ]
nrow(tr[which(tr[,3] != 1000), ]) ==  (135*135) - ((135*135 / 2) +135/2) # 9045 rows left
masterbeta <- tr

for(t in trlevels_components[-1]){
  tr <- get(t)
  tr <- as.matrix(tr)
  tr[!lower.tri(tr)] <- 1000
  tr <- reshape2::melt(tr, value.name = t)
  # tr <- tr[!is.na(tr[, 3]),] #TODO removed 
  tr <- tr[which(tr[,3] != 1000), ] 
  masterbeta <- merge(masterbeta, tr, by = c("Var1", "Var2"), all.x = T)
}
rm(tr); rm(t)
```

save betadiversity datasets
```{r}
# for(t in trlevels){
#   tr <- get(t)
#   saveRDS(tr, file = paste(t, "betadiversity.rds", sep="_"))
# }
saveRDS(trlevels, "trlevels_vector.rds")
saveRDS(masterbeta, "master_beta.rds")
```

# Calculate alpha diversities
```{r}
for(t in trlevels){
  tr <- get(t)
  alpha <- aggregate(value ~ Plot, tr, function(x) sum(x))
  alphaname <- paste(t, ".alpha", sep = "")
  setnames(alpha, old = c("Plot", "value"), new = c("Var1", alphaname))
  assign(alphaname, alpha)
}
rm(t); rm(tr); rm(alpha); rm(alphaname)

# put all alphas together to masteralpha
masteralpha <- data.table::copy(autotroph.alpha) # by hand for trlevels[1]
for(t in trlevels[-1]){
  alphaname <- paste(t, ".alpha", sep = "")
  tr <- get(alphaname)
  masteralpha <- merge(masteralpha, tr, by = "Var1", all.x = T)
}
# save alphadiversities
saveRDS(masteralpha, "master_alpha.rds")

# combine betadiversity masters with alphas
masterdiversity <- merge(masterbeta, masteralpha, by = "Var1", all.x = T)
backup <- colnames(masteralpha)
colnames(masteralpha) <- paste(colnames(masteralpha), "2", sep = ".")
setnames(masteralpha, old = "Var1.2", new = "Var2")
masterdiversity <- merge(masterdiversity, masteralpha, by = "Var2", all.x = T)

# save masterdiversity
saveRDS(masterdiversity, "master_diversity_alpha_beta.rds")
```



# Cleaning
```{r}
rm(spdiv); rm(test); rm(tr); rm(t); rm(redplotset); rm(plots)
rm(alphaname); rm(sum); rm(exclude); rm(bh_overv); rm(bp_overv)
rm(masteralpha); rm(masterdiversity)
rm(list = trlevels)
rm(list = trlevels_components)
```
